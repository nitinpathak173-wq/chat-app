<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twinkle Chat</title>
    <!-- Tailwind CSS Play CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind theme configuration for our purple color
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        primary: '#6a0dad',
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        'spin': {
                            'to': { transform: 'rotate(360deg)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.3s ease-out',
                        'fade-in': 'fade-in 0.3s ease-out',
                        'scale-in': 'scale-in 0.1s ease-out',
                        'spin': 'spin 1s linear infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Simple scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px;}
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .hidden { display: none; }
        .message-bubble-wrapper:hover .action-btn {
            opacity: 1;
        }
        .dark .dark-text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <!-- =========== NEW: Loading Screen =========== -->
    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-16 h-16 border-4 border-t-primary border-gray-200 rounded-full animate-spin"></div>
    </div>

    <!-- =========== Authentication Page (Visible on load) =========== -->
    <div id="auth-page" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <!-- Login Form -->
            <div id="login-view">
                <h2 class="text-3xl font-bold text-center text-gray-800">Welcome Back!</h2>
                <p class="text-center text-gray-500">Login to continue to Twinkle Chat</p>
                <div class="mt-8 space-y-4">
                    <button id="google-signin-btn" class="w-full flex items-center justify-center py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 39.233 44 34.026 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Sign in with Google
                    </button>
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                        <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or continue with</span></div>
                    </div>
                </div>
                <form id="login-form" class="mt-4 space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <button type="submit" class="w-full py-3 text-white bg-primary rounded-md hover:bg-purple-800 transition-colors font-bold active:scale-95">Login</button>
                </form>
                <p class="mt-6 text-sm text-center">Don't have an account? <a href="#" id="show-signup" class="font-medium text-primary hover:underline">Sign up</a></p>
            </div>
            <!-- Signup Form -->
            <div id="signup-view" class="hidden">
                <h2 class="text-3xl font-bold text-center text-gray-800">Create Account</h2>
                <p class="text-center text-gray-500">Get started with Twinkle Chat</p>
                <div class="mt-8 space-y-4">
                    <button id="google-signup-btn" class="w-full flex items-center justify-center py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 39.233 44 34.026 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Sign up with Google
                    </button>
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                        <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or continue with</span></div>
                    </div>
                </div>
                <form id="signup-form" class="mt-4 space-y-6">
                    <input type="text" id="signup-username" placeholder="Username (must be unique)" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <button type="submit" class="w-full py-3 text-white bg-primary rounded-md hover:bg-purple-800 transition-colors font-bold active:scale-95">Sign Up</button>
                </form>
                <p class="mt-6 text-sm text-center">Already have an account? <a href="#" id="show-login" class="font-medium text-primary hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- =========== Main App Container (Hidden by default) =========== -->
    <div id="app-container" class="hidden h-screen w-screen flex flex-col bg-gray-100 dark:bg-gray-900 border-8 border-white dark:border-gray-900">
        <!-- Top Navigation -->
        <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
            <h1 class="text-2xl font-bold text-primary dark:text-white">Twinkle Chat</h1>
            <div id="profile-button-container" class="w-10 h-10 rounded-full cursor-pointer" title="Profile">
                 <img id="header-profile-pic" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Profile">
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto pb-20">
            <!-- CHATS PAGE -->
            <div id="chats-page" class="page p-4 relative h-full">
                <input type="search" id="search-input" placeholder="Search existing chats..." class="w-full mb-4 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                <div id="chat-list" class="space-y-3">
                    <!-- Chat list items will be injected here by JS -->
                </div>
                <!-- New Chat Floating Action Button -->
                <button id="new-chat-btn" class="absolute bottom-6 right-6 bg-primary text-white w-14 h-14 rounded-full flex items-center justify-center text-3xl shadow-lg hover:bg-purple-800 transition transform hover:scale-110 active:scale-95" title="New Chat">
                    +
                </button>
            </div>
            <!-- PROFILE PAGE -->
            <div id="profile-page" class="page hidden p-4 animate-fade-in">
                <div class="max-w-md mx-auto space-y-4">
                    <!-- Profile Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                        <div id="profile-pic-container" class="relative w-24 h-24 mx-auto mb-4 cursor-pointer group">
                            <img id="profile-pic-display" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile Picture">
                            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white text-xs font-bold">Change</span>
                            </div>
                        </div>
                        <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                        <h3 id="profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                        <p id="profile-email" class="text-gray-500 dark:text-gray-400">email@example.com</p>
                    </div>

                    <!-- Bio Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">Bio</h4>
                            <button id="edit-bio-btn" class="text-sm text-primary font-semibold">Edit</button>
                        </div>
                        <p id="bio-text" class="text-gray-600 dark:text-gray-300 text-sm">This is your bio. Click edit to change it.</p>
                        <textarea id="bio-input" class="hidden w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-200" rows="3"></textarea>
                        <button id="save-bio-btn" class="hidden mt-2 w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                    </div>

                    <!-- Settings Card -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200">Dark Theme</h4>
                            <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600">
                                <span id="theme-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>
                    </div>
                    
                    <button id="logout-button" class="w-full py-2 text-white bg-red-500 rounded-md hover:bg-red-600 transition active:scale-95">Logout</button>
                </div>
            </div>
            
            <!-- GEMINI PAGE -->
            <div id="gemini-page" class="page hidden flex flex-col h-full">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-gemini-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <div class="flex items-center space-x-3">
                        <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" class="w-8 h-8 rounded-full object-contain" alt="Gemini">
                        <div>
                            <h2 class="font-bold text-gray-900 dark:text-white">Gemini</h2>
                            <p class="text-xs text-green-500">Online</p>
                        </div>
                    </div>
                </header>
                <div id="gemini-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Gemini messages will be injected here -->
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <form id="gemini-message-form" class="flex items-center">
                        <input type="text" id="gemini-message-input" placeholder="Ask Gemini anything..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-primary text-white rounded-full hover:bg-purple-800 transition active:scale-95">Send</button>
                    </form>
                </footer>
            </div>

            <!-- OVERLAY PAGES -->
            <!-- CHAT ROOM PAGE -->
            <div id="chat-room-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-to-chats-btn" class="text-primary dark:text-white font-bold p-2 text-2xl flex items-center justify-center">
                        &lt;
                    </button>
                    <div id="chat-room-header-clickable" class="flex items-center space-x-3 cursor-pointer flex-1">
                        <div class="relative w-10 h-10">
                            <img id="chat-room-pic" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Partner">
                            <div id="chat-room-status-dot" class="w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>
                        </div>
                        <div>
                            <h2 id="chat-room-username" class="font-bold text-gray-900 dark:text-white dark-text-glow">Chat Partner</h2>
                            <p id="chat-room-status-text" class="text-xs text-gray-500">Offline</p>
                        </div>
                    </div>
                    <!-- Chat Settings Menu -->
                    <div class="relative">
                        <button id="chat-settings-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                        <div id="chat-settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg z-10">
                            <a href="#" id="delete-chat-btn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Delete Chat</a>
                        </div>
                    </div>
                </header>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <!-- Messages will be injected here -->
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <!-- Reply Preview -->
                    <div id="reply-preview-container" class="hidden p-2 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p id="reply-preview-username" class="text-sm font-bold text-sky-500"></p>
                                <p id="reply-preview-text" class="text-xs text-gray-600 dark:text-gray-300 truncate"></p>
                            </div>
                            <button id="cancel-reply-btn" class="text-gray-500 dark:text-gray-400">&times;</button>
                        </div>
                    </div>
                    <form id="message-form" class="flex items-center">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-primary text-white rounded-full hover:bg-purple-800 transition active:scale-95">Send</button>
                    </form>
                </footer>
            </div>
            
            <!-- SEARCH USERS PAGE -->
            <div id="search-users-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-search-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <input type="search" id="user-search-input" placeholder="Search for users by username..." class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                </header>
                <div id="user-search-results" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- User search results will be injected here -->
                </div>
            </div>

            <!-- PARTNER PROFILE PAGE -->
            <div id="partner-profile-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30 animate-fade-in">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-partner-profile-btn" class="text-primary font-bold p-2">&lt; Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                     <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <img id="partner-profile-pic" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50 mx-auto mb-4" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Partner Profile Picture">
                            <h3 id="partner-profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Bio</h4>
                            <p id="partner-profile-bio" class="text-gray-600 dark:text-gray-300 text-sm">No bio available.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DELETE CHAT CONFIRMATION MODAL -->
            <div id="delete-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4 text-center">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Delete Chat</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Are you sure you want to permanently delete this entire conversation?</p>
                    <div class="flex justify-center space-x-4">
                         <button id="cancel-delete-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                         <button id="confirm-delete-btn" class="py-2 px-4 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-t-md flex justify-around p-1 border-t dark:border-gray-700 z-10">
            <button data-page="chats-page" class="nav-btn relative flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <span id="chats-badge" class="hidden absolute top-1 right-6 w-2 h-2 bg-red-500 rounded-full"></span>
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                <span class="text-xs font-semibold">Chats</span>
            </button>
            <button data-page="gemini-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <span class="text-xs font-semibold">Gemini</span>
            </button>
            <button data-page="profile-page" class="nav-btn flex flex-col items-center justify-center w-full py-2 rounded-lg transition-colors duration-200">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs font-semibold">Profile</span>
            </button>
        </nav>
    </div>

    <!-- Firebase and App Logic Script -->
    <script type="module">
        // =================================================================
        // 1. FIREBASE SDK IMPORTS (FROM CDN)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, where, orderBy, onSnapshot, addDoc,
            serverTimestamp, runTransaction, getDocs, limit, writeBatch, Timestamp, increment, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { 
            getStorage, 
            ref as storageRef, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        // =================================================================
        // 2. FIREBASE CONFIGURATION
        // =================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyBMZBqPHViEWGA7mT_GN_mePBOnqT1NYz0",
  authDomain: "chat-app-e1891.firebaseapp.com",
  projectId: "chat-app-e1891",
  storageBucket: "chat-app-e1891.firebasestorage.app",
  messagingSenderId: "889518853542",
  appId: "1:889518853542:web:969c0d35177a3fb2fd9367"
};

        // =================================================================
        // 3. INITIALIZE FIREBASE & SERVICES
        // =================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const storage = getStorage(app);
        
        // =================================================================
        // 4. GLOBAL STATE & DOM REFERENCES
        // =================================================================
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribeChats = null;
        let unsubscribeMessages = null;
        let unsubscribePartnerStatus = null;
        let unsubscribeTypingStatus = null;
        let unsubscribeStatuses = null;
        let typingTimeout = null;
        let geminiChatHistory = [];
        let statusViewerTimeout = null;
        let currentReply = null;
        let selectedMessage = null;
        
        const loadingScreen = document.getElementById('loading-screen');
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        const pages = document.querySelectorAll('.page');
        
        // Forms & Toggles
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        
        // Buttons
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        const logoutButton = document.getElementById('logout-button');
        const navButtons = document.querySelectorAll('.nav-btn');
        const profileButtonContainer = document.getElementById('profile-button-container');
        const newChatBtn = document.getElementById('new-chat-btn');
        
        // Chat List
        const searchInput = document.getElementById('search-input');
        const chatList = document.getElementById('chat-list');
        const chatsBadge = document.getElementById('chats-badge');
        
        // Chat Room
        const chatRoomPage = document.getElementById('chat-room-page');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const chatRoomHeaderClickable = document.getElementById('chat-room-header-clickable');
        const chatRoomUsername = document.getElementById('chat-room-username');
        const chatRoomPic = document.getElementById('chat-room-pic');
        const chatRoomStatusDot = document.getElementById('chat-room-status-dot');
        const chatRoomStatusText = document.getElementById('chat-room-status-text');
        const replyPreviewContainer = document.getElementById('reply-preview-container');
        const replyPreviewUsername = document.getElementById('reply-preview-username');
        const replyPreviewText = document.getElementById('reply-preview-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        const chatSettingsMenu = document.getElementById('chat-settings-menu');
        const deleteChatBtn = document.getElementById('delete-chat-btn');

        // User Search
        const searchUsersPage = document.getElementById('search-users-page');
        const backFromSearchBtn = document.getElementById('back-from-search-btn');
        const userSearchInput = document.getElementById('user-search-input');
        const userSearchResults = document.getElementById('user-search-results');

        // Profile Page
        const profilePicContainer = document.getElementById('profile-pic-container');
        const profilePicInput = document.getElementById('profile-pic-input');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const headerProfilePic = document.getElementById('header-profile-pic');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const editBioBtn = document.getElementById('edit-bio-btn');
        const saveBioBtn = document.getElementById('save-bio-btn');
        const bioText = document.getElementById('bio-text');
        const bioInput = document.getElementById('bio-input');

        // Partner Profile Page
        const partnerProfilePage = document.getElementById('partner-profile-page');
        const backFromPartnerProfileBtn = document.getElementById('back-from-partner-profile-btn');
        const partnerProfilePic = document.getElementById('partner-profile-pic');
        const partnerProfileUsername = document.getElementById('partner-profile-username');
        const partnerProfileBio = document.getElementById('partner-profile-bio');

        // Gemini Chat Page
        const geminiPage = document.getElementById('gemini-page');
        const backFromGeminiBtn = document.getElementById('back-from-gemini-btn');
        const geminiMessagesContainer = document.getElementById('gemini-messages-container');
        const geminiMessageForm = document.getElementById('gemini-message-form');
        const geminiMessageInput = document.getElementById('gemini-message-input');

        // Modals
        const deleteChatModal = document.getElementById('delete-chat-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const messageMenu = document.getElementById('message-menu');

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleSlider = document.getElementById('theme-toggle-slider');

        // =================================================================
        // 5. HELPER FUNCTIONS
        // =================================================================
        const getInitials = (name = '') => name ? name.charAt(0).toUpperCase() : '?';
        const getPlaceholderUrl = (initials) => `https://placehold.co/100x100/6a0dad/white?text=${initials}`;
        const timeAgo = (timestamp) => {
            if (!timestamp) return '';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp.toMillis()) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return `just now`;
        };
        const formatMessageTime = (timestamp) => {
            if (!timestamp) return '';
            return timestamp.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        };

        // =================================================================
        // 6. PAGE NAVIGATION LOGIC
        // =================================================================
        function showPage(pageId, isOverlay = false) {
            if (!isOverlay) {
                pages.forEach(page => page.classList.add('hidden'));
            }
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                if(!isOverlay) activePage.classList.add('animate-fade-in');
            }
            if (!isOverlay) updateNavButtons(pageId);
        }

        function hidePage(pageId) {
            const page = document.getElementById(pageId);
            if(page) page.classList.add('hidden');
        }

        function updateNavButtons(activePageId) {
            navButtons.forEach(btn => {
                const isTarget = btn.dataset.page === activePageId;
                btn.classList.toggle('text-primary', isTarget && !document.documentElement.classList.contains('dark'));
                btn.classList.toggle('dark:text-white', isTarget);
                btn.classList.toggle('text-gray-500', !isTarget);
                btn.classList.toggle('dark:text-gray-400', !isTarget);
                btn.classList.toggle('bg-purple-100', isTarget);
                btn.classList.toggle('dark:bg-gray-700', isTarget);
            });
        }
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                showPage(pageId);
            });
        });
        profileButtonContainer.addEventListener('click', () => showPage('profile-page'));

        // =================================================================
        // 7. AUTHENTICATION & PRESENCE MANAGEMENT
        // =================================================================
        onAuthStateChanged(auth, async (user) => {
            loadingScreen.classList.add('hidden');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                    authPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    showPage('chats-page');
                    setupRealtimeListeners();
                    managePresence(user.uid);
                    // Update profile UI
                    profileUsername.textContent = currentUser.username;
                    profileEmail.textContent = currentUser.email;
                    bioText.textContent = currentUser.bio || 'This is your bio. Click edit to change it.';
                    const initials = getInitials(currentUser.username);
                    const profilePicUrl = currentUser.profilePicUrl || getPlaceholderUrl(initials);
                    headerProfilePic.src = profilePicUrl;
                    profilePicDisplay.src = profilePicUrl;
                } else {
                    console.error("User exists in Auth but not in Firestore. Logging out.");
                    signOut(auth); 
                }
            } else {
                currentUser = null;
                authPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupRealtimeListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (username.length < 3) return alert("Username must be at least 3 characters.");
            if (password.length < 6) return alert("Password must be at least 6 characters.");

            try {
                const usernameDoc = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameDoc.exists()) throw new Error("Username is already taken.");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", user.uid);
                    const usernameRef = doc(db, "usernames", username.toLowerCase());
                    
                    transaction.set(userRef, {
                        uid: user.uid,
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        email: email,
                        profilePicUrl: null,
                        bio: '', // Initialize with empty bio
                        createdAt: serverTimestamp(),
                        status: {
                            state: 'offline',
                            last_changed: serverTimestamp(),
                        }
                    });
                    transaction.set(usernameRef, { uid: user.uid });
                });
            } catch (error) {
                alert("Signup Error: " + error.message);
            }
        });
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user already exists in Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // New user, create their profile
                    const username = user.displayName.split(' ')[0].toLowerCase() + Math.floor(Math.random() * 1000);
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        username: user.displayName,
                        username_lowercase: user.displayName.toLowerCase(),
                        email: user.email,
                        profilePicUrl: user.photoURL,
                        bio: '',
                        createdAt: serverTimestamp(),
                        status: {
                            state: 'offline',
                            last_changed: serverTimestamp(),
                        }
                    });
                     await setDoc(doc(db, "usernames", username), { uid: user.uid });
                }
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                alert("Could not sign in with Google. Please try again.");
            }
        }
        googleSigninBtn.addEventListener('click', handleGoogleSignIn);
        googleSignupBtn.addEventListener('click', handleGoogleSignIn);

        logoutButton.addEventListener('click', async () => {
            if (currentUser) {
                const userStatusRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userStatusRef, {
                    status: { state: 'offline', last_changed: serverTimestamp() }
                });
            }
            signOut(auth);
        });

        showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.parentElement.classList.add('hidden'); signupForm.parentElement.classList.remove('hidden'); });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.parentElement.classList.add('hidden'); loginForm.parentElement.classList.remove('hidden'); });

        function managePresence(uid) {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + uid);
            const userStatusFirestoreRef = doc(db, '/users/' + uid);

            const isOfflineForFirestore = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForFirestore = { state: 'online', last_changed: serverTimestamp() };

            // Use Realtime Database for immediate disconnect detection
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === false) {
                    // Not connected, ensure Firestore is updated
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                    return;
                }
                // When connected, set online status in RTDB and Firestore
                const onDisconnectRef = onDisconnect(userStatusDatabaseRef);
                onDisconnectRef.set({ state: 'offline', last_changed: rtdbServerTimestamp() });
                set(userStatusDatabaseRef, { state: 'online', last_changed: rtdbServerTimestamp() });
                updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
            });

            // Use browser visibility API for faster updates
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                } else {
                    updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
                }
            });
        }

        // =================================================================
        // 8. REALTIME LISTENERS & CHAT LIST
        // =================================================================
        function cleanupRealtimeListeners() {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            if (unsubscribeStatuses) unsubscribeStatuses();
        }

        function setupRealtimeListeners() {
            cleanupRealtimeListeners();
            // Chat listener
            const chatsQuery = query(
                collection(db, "chats"),
                where("participants", "array-contains", currentUser.uid),
                orderBy("lastMessageTimestamp", "desc")
            );
            
            unsubscribeChats = onSnapshot(chatsQuery, async (snapshot) => {
                let totalUnread = 0;
                const chatPromises = snapshot.docs.map(async (chatDoc) => {
                    const chatData = chatDoc.data();
                    const unreadCount = chatData.unreadCount?.[currentUser.uid] || 0;
                    totalUnread += unreadCount;

                    const partnerId = chatData.participants.find(id => id !== currentUser.uid);
                    if (!partnerId) return null;
                    const userDoc = await getDoc(doc(db, "users", partnerId));
                    return userDoc.exists() ? { id: chatDoc.id, partner: userDoc.data(), unreadCount, ...chatData } : null;
                });
                const chats = (await Promise.all(chatPromises)).filter(Boolean);
                renderChatList(chats);

                // Update main nav badge
                if (totalUnread > 0) {
                    chatsBadge.classList.remove('hidden');
                } else {
                    chatsBadge.classList.add('hidden');
                }
            });
        }

        function renderChatList(chats) {
            if (chats.length === 0) {
                chatList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">No chats yet. Click the '+' button to find users and start a conversation.</p>`;
                return;
            }
            chatList.innerHTML = chats.map(chat => {
                const isOnline = chat.partner.status?.state === 'online';
                const initials = getInitials(chat.partner.username);
                const profilePicUrl = chat.partner.profilePicUrl || getPlaceholderUrl(initials);
                const unreadBadge = chat.unreadCount > 0 ? `<span class="bg-primary text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">${chat.unreadCount}</span>` : '';

                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition chat-item" data-partner-id="${chat.partner.uid}" data-partner-name="${chat.partner.username}" data-partner-pic="${chat.partner.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${chat.partner.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                    </div>
                    ${unreadBadge}
                </div>
            `}).join('');
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const partnerName = item.dataset.partnerName.toLowerCase();
                item.style.display = partnerName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // =================================================================
        // 9. CHAT ROOM LOGIC & READ RECEIPTS & TYPING INDICATOR
        // =================================================================
        chatList.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                openChatRoom({
                    uid: chatItem.dataset.partnerId,
                    username: chatItem.dataset.partnerName,
                    profilePicUrl: chatItem.dataset.partnerPic
                });
            }
        });
        
        async function openChatRoom(partner) {
            currentChatPartner = partner;
            showPage('chat-room-page', true);
            chatRoomUsername.textContent = partner.username;
            const initials = getInitials(partner.username);
            chatRoomPic.src = partner.profilePicUrl || getPlaceholderUrl(initials);
            
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            // Reset unread count for this chat
            const chatRef = doc(db, 'chats', chatId);
            await updateDoc(chatRef, { [`unreadCount.${currentUser.uid}`]: 0 });

            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            unsubscribePartnerStatus = onSnapshot(doc(db, "users", partner.uid), (doc) => {
                const partnerData = doc.data();
                currentChatPartner = { ...currentChatPartner, ...partnerData }; // Keep partner data updated
                const isOnline = partnerData.status?.state === 'online';
                chatRoomStatusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                // This will be updated by the typing listener
                if (!chatRoomStatusText.textContent.includes('typing')) {
                    chatRoomStatusText.textContent = isOnline ? 'Online' : 'Offline';
                }
                chatRoomStatusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
            });
            
            // Listen for partner's typing status
            const typingRef = ref(rtdb, `/typing/${chatId}/${partner.uid}`);
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            unsubscribeTypingStatus = onValue(typingRef, (snapshot) => {
                const isTyping = snapshot.val() === true;
                if (isTyping) {
                    chatRoomStatusText.textContent = 'typing...';
                    chatRoomStatusText.className = 'text-xs text-primary italic';
                } else {
                    const isOnline = currentChatPartner.status?.state === 'online';
                    chatRoomStatusText.textContent = isOnline ? 'Online' : 'Offline';
                    chatRoomStatusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
                }
            });

            const messagesQuery = query(collection(db, `chats/${chatId}/messages`), orderBy("timestamp", "asc"));
            
            if(unsubscribeMessages) unsubscribeMessages();
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                renderMessages(snapshot.docs);
                markMessagesAsRead(snapshot.docs);
            });
        }
        
        function renderMessages(messageDocs) {
            messagesContainer.innerHTML = messageDocs.map(doc => {
                const msg = doc.data();
                const isSender = msg.senderId === currentUser.uid;

                const replyHtml = msg.replyTo ? `
                    <div class="p-2 mb-1 text-xs bg-black bg-opacity-10 dark:bg-white dark:bg-opacity-10 rounded-md">
                        <p class="font-bold text-sky-500">${msg.replyTo.senderName}</p>
                        <p class="truncate">${msg.replyTo.text}</p>
                    </div>
                ` : '';

                const readReceipt = isSender ? `
                    <div class="text-xs ${msg.isRead ? 'text-blue-500' : 'text-gray-400'}">
                        
                    </div>
                ` : '';
                
                const reactions = msg.reactions || {};
                const reactionsHtml = Object.entries(reactions)
                    .filter(([emoji, uids]) => uids.length > 0)
                    .map(([emoji, uids]) => `
                        <div class="bg-gray-200 dark:bg-gray-600 text-xs rounded-full px-2 py-0.5 flex items-center">
                            <span>${emoji}</span>
                            <span class="ml-1 text-gray-700 dark:text-gray-200">${uids.length}</span>
                        </div>
                    `).join('');

                return `
                    <div 
                        class="flex flex-col animate-fade-in-up message-bubble-wrapper relative ${isSender ? 'items-end' : 'items-start'}"
                        data-message-id="${doc.id}"
                        data-message-text="${msg.text}"
                        data-message-sender="${isSender ? currentUser.username : currentChatPartner.username}"
                    >
                        <div class="flex items-center ${isSender ? 'flex-row-reverse' : ''}">
                            <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isSender ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm'}">
                                ${replyHtml}
                                <p>${msg.text}</p>
                            </div>
                            <button class="action-btn reply-btn opacity-0 transition-opacity p-2 text-gray-500 dark:text-gray-400">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="flex items-center mt-1 pr-2 space-x-2">
                             <p class="text-xs text-gray-400 dark:text-gray-500">${formatMessageTime(msg.timestamp)}</p>
                            ${readReceipt}
                        </div>
                        <div class="flex space-x-1 mt-1 ${isSender ? 'pr-2' : 'pl-2'}">
                            ${reactionsHtml}
                        </div>
                    </div>`;
            }).join('');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function markMessagesAsRead(messageDocs) {
            const batch = writeBatch(db);
            let updatesMade = false;
            messageDocs.forEach(doc => {
                const msg = doc.data();
                if (msg.receiverId === currentUser.uid && !msg.isRead) {
                    batch.update(doc.ref, { isRead: true });
                    updatesMade = true;
                }
            });
            if (updatesMade) {
                await batch.commit();
            }
        }

        messageInput.addEventListener('input', () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, true);
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingRef, false);
            }, 2000); // User is considered "stopped typing" after 2 seconds
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatPartner) return;
            
            messageInput.value = '';
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            clearTimeout(typingTimeout);
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, false);

            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                text: text,
                type: "text",
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            if (currentReply) {
                newMessage.replyTo = currentReply;
            }

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);

                const batch = writeBatch(db);
                batch.set(doc(messagesRef), newMessage);
                batch.set(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    [`unreadCount.${currentChatPartner.uid}`]: increment(1)
                }, { merge: true });

                await batch.commit();

            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Could not send message.");
                messageInput.value = text;
            } finally {
                cancelReply();
            }
        });

        backToChatsBtn.addEventListener('click', () => {
            hidePage('chat-room-page');
            currentChatPartner = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
        });
        
        // =================================================================
        // 10. MESSAGE INTERACTION LOGIC (REPLY, REACT, COPY)
        // =================================================================
        messagesContainer.addEventListener('click', (e) => {
            const replyButton = e.target.closest('.reply-btn');
            if (replyButton) {
                const messageWrapper = replyButton.closest('.message-bubble-wrapper');
                currentReply = {
                    messageId: messageWrapper.dataset.messageId,
                    text: messageWrapper.dataset.messageText,
                    senderName: messageWrapper.dataset.messageSender
                };
                showReplyPreview();
            }
        });

        function showReplyPreview() {
            if (!currentReply) return;
            replyPreviewUsername.textContent = `Replying to ${currentReply.senderName}`;
            replyPreviewText.textContent = currentReply.text;
            replyPreviewContainer.classList.remove('hidden');
            messageInput.focus();
        }

        function cancelReply() {
            currentReply = null;
            replyPreviewContainer.classList.add('hidden');
        }
        cancelReplyBtn.addEventListener('click', cancelReply);

        // =================================================================
        // 11. USER SEARCH LOGIC
        // =================================================================
        newChatBtn.addEventListener('click', () => {
            showPage('search-users-page', true);
            userSearchInput.value = '';
            userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Type a username to find users.</p>';
        });

        backFromSearchBtn.addEventListener('click', () => hidePage('search-users-page'));

        userSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Keep typing to search...</p>';
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, 
                    where("username_lowercase", ">=", searchTerm),
                    where("username_lowercase", "<=", searchTerm + '\uf8ff'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const users = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) users.push(doc.data());
                });
                renderUserSearchResults(users);
            } catch (error) {
                console.error("Error searching users:", error);
                userSearchResults.innerHTML = '<p class="text-red-500 text-center mt-4">Error searching for users. Ensure database indexes are configured.</p>';
            }
        });

        function renderUserSearchResults(users) {
            if (users.length === 0) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">No users found.</p>';
                return;
            }
            userSearchResults.innerHTML = users.map(user => {
                const isOnline = user.status?.state === 'online';
                const initials = getInitials(user.username);
                const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);
                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition user-search-item" data-user-id="${user.uid}" data-user-name="${user.username}" data-user-pic="${user.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${user.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${user.email}</p>
                    </div>
                </div>
            `}).join('');
        }

        userSearchResults.addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-search-item');
            if (userItem) {
                hidePage('search-users-page');
                openChatRoom({
                    uid: userItem.dataset.userId,
                    username: userItem.dataset.userName,
                    profilePicUrl: userItem.dataset.userPic
                });
            }
        });

        // =================================================================
        // 12. PROFILE & BIO LOGIC
        // =================================================================
        profilePicContainer.addEventListener('click', () => profilePicInput.click());

        profilePicInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;

            const toast = document.createElement('div');
            toast.textContent = 'Uploading...';
            toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            document.body.appendChild(toast);

            try {
                const filePath = `profile-pics/${currentUser.uid}/${Date.now()}-${file.name}`;
                const fileRef = storageRef(storage, filePath);
                
                const snapshot = await uploadBytes(fileRef, file);
                const photoURL = await getDownloadURL(snapshot.ref);

                await updateDoc(doc(db, 'users', currentUser.uid), { profilePicUrl: photoURL });
                currentUser.profilePicUrl = photoURL;
                
                headerProfilePic.src = photoURL;
                profilePicDisplay.src = photoURL;
                
                toast.textContent = 'Upload complete!';
                toast.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } catch (error) {
                console.error("Upload failed:", error);
                toast.textContent = 'Upload failed!';
                toast.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
            } finally {
                setTimeout(() => toast.remove(), 3000);
                profilePicInput.value = '';
            }
        });

        editBioBtn.addEventListener('click', () => {
            bioText.classList.add('hidden');
            editBioBtn.classList.add('hidden');
            bioInput.classList.remove('hidden');
            saveBioBtn.classList.remove('hidden');
            bioInput.value = currentUser.bio || '';
            bioInput.focus();
        });

        saveBioBtn.addEventListener('click', async () => {
            const newBio = bioInput.value.trim();
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { bio: newBio });
                currentUser.bio = newBio;
                bioText.textContent = newBio || 'This is your bio. Click edit to change it.';
            } catch (error) {
                console.error("Failed to save bio:", error);
                alert("Could not save bio.");
            } finally {
                bioText.classList.remove('hidden');
                editBioBtn.classList.remove('hidden');
                bioInput.classList.add('hidden');
                saveBioBtn.classList.add('hidden');
            }
        });
        
        chatRoomHeaderClickable.addEventListener('click', () => {
            if (!currentChatPartner) return;
            
            const initials = getInitials(currentChatPartner.username);
            partnerProfilePic.src = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);
            partnerProfileUsername.textContent = currentChatPartner.username;
            partnerProfileBio.textContent = currentChatPartner.bio || 'No bio available.';
            
            showPage('partner-profile-page', true);
        });

        backFromPartnerProfileBtn.addEventListener('click', () => {
            hidePage('partner-profile-page');
        });


        // =================================================================
        // 13. THEME SWITCHER LOGIC
        // =================================================================
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleSlider.classList.add('dark:translate-x-6');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleSlider.classList.remove('dark:translate-x-6');
            }
            localStorage.setItem('theme', theme);
            // Find the currently active page to update nav buttons correctly
            const activeNav = document.querySelector('.nav-btn.text-primary, .nav-btn.dark\\:text-white');
            if (activeNav) {
                updateNavButtons(activeNav.dataset.page);
            }
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            applyTheme(isDarkMode ? 'light' : 'dark');
        });

        // Apply saved theme on initial load
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        // =================================================================
        // 14. GEMINI CHAT LOGIC
        // =================================================================
        backFromGeminiBtn.addEventListener('click', () => {
            showPage('chats-page');
        });

        geminiMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = geminiMessageInput.value.trim();
            if (!prompt) return;

            geminiMessageInput.value = '';
            renderGeminiMessage(prompt, 'user');
            renderGeminiMessage('...', 'model', true); // Show loading indicator

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyAE9qqHiA_FrTzj-3pkTtS52tH1u53jAhQ"; //  PASTE YOUR GEMINI API KEY HERE 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    renderGeminiMessage(text, 'model');
                } else {
                    throw new Error("Invalid response structure from Gemini API.");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                renderGeminiMessage("Sorry, I couldn't get a response. Please try again.", 'model');
            }
        });

        function renderGeminiMessage(text, role, isLoading = false) {
            const loadingIndicator = geminiMessagesContainer.querySelector('.loading-indicator');
            if (loadingIndicator && !isLoading) {
                loadingIndicator.remove();
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl shadow-sm ${
                role === 'user' 
                ? 'bg-primary text-white rounded-br-none' 
                : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none'
            }`;
            
            if (isLoading) {
                messageWrapper.classList.add('loading-indicator');
                messageBubble.innerHTML = `<div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
                </div>`;
            } else {
                messageBubble.textContent = text;
            }

            messageWrapper.appendChild(messageBubble);
            geminiMessagesContainer.appendChild(messageWrapper);
            geminiMessagesContainer.scrollTop = geminiMessagesContainer.scrollHeight;
        }
        
        // =================================================================
        // 15. DELETE CHAT LOGIC
        // =================================================================
        chatSettingsBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.toggle('hidden');
        });

        deleteChatBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.add('hidden');
            deleteChatModal.classList.remove('hidden');
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteChatModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            try {
                // 1. Delete all messages in the subcollection
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const messagesSnapshot = await getDocs(messagesRef);
                const batch = writeBatch(db);
                messagesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // 2. Delete the main chat document
                await deleteDoc(doc(db, 'chats', chatId));
                
                // 3. Go back to chat list
                hidePage('chat-room-page');
                showPage('chats-page');

            } catch (error) {
                console.error("Error deleting chat:", error);
                alert("Could not delete chat. Please try again.");
            } finally {
                deleteChatModal.classList.add('hidden');
            }
        });

        // Close settings menu if clicking outside
        document.addEventListener('click', (e) => {
            if (!chatSettingsBtn.contains(e.target) && !chatSettingsMenu.contains(e.target)) {
                chatSettingsMenu.classList.add('hidden');
            }
            if (!messageMenu.contains(e.target) && !e.target.closest('.message-bubble-wrapper')) {
                messageMenu.classList.add('hidden');
            }
        });

    </script>
</body>
</html>