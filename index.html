<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twinkle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
    <script>
        // Custom Tailwind theme configuration for our purple color
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        primary: '#6a0dad',
                        ludo: { // Kept for other UI elements if needed, but not used by ludo game
                            red: '#ef4444',
                            green: '#22c55e',
                            yellow: '#f59e0b',
                            blue: '#3b82f6',
                        }
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        'spin': {
                            'to': { transform: 'rotate(360deg)' },
                        },
                        'blink': {
                            '50%': { opacity: '0.2' },
                        },
                        'progress': {
                           '0%': { width: '0%' },
                           '100%': { width: '100%' },
                        },
                        'bump': { // Added for voice note recording
                           '0%': { transform: 'scale(1)' },
                           '50%': { transform: 'scale(1.2)' },
                           '100%': { transform: 'scale(1)' },
                        },
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.3s ease-out',
                        'fade-in': 'fade-in 1.5s ease-out', /* Slower fade-in for logo */
                        'scale-in': 'scale-in 0.2s ease-out',
                        'spin': 'spin 1s linear infinite',
                        'blink': 'blink 1.4s infinite both',
                        'progress': 'progress linear forwards',
                        'bump': 'bump 1s ease-in-out infinite', // Added for voice note recording
                    }
                }
            }
        }
    </script>
    
    <style>
        /* --- CUSTOM HEADER GLASS EFFECT --- */
        header.glass-effect {
            background: transparent !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: none !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }

        /* --- TOAST NOTIFICATION STYLES --- */
        .toast-element {
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(0);
        }

        /* --- DARKER THEME OVERRIDES --- */
        .dark body, .dark .dark\:bg-gray-900, .dark .bg-gray-900 {
            background-color: #000000 !important;
        }
        .dark .dark\:bg-gray-800, .dark .bg-gray-800 {
            background-color: #121212 !important;
        }
        .dark .dark\:bg-gray-700, .dark .bg-gray-700 {
            background-color: #1e1e1e !important;
        }
        .dark .dark\:border-gray-600, .dark .border-gray-600 {
            border-color: #333333 !important;
        }
        .dark .dark\:border-gray-700, .dark .border-gray-700 {
            border-color: #2a2a2a !important;
        }
        .dark .dark\:text-gray-400, .dark .text-gray-400 {
            color: #999999 !important;
        }
        .dark .dark\:text-gray-300, .dark .text-gray-300 {
            color: #cccccc !important;
        }
        .dark .glass-effect {
            background: rgba(18, 18, 18, 0.75) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border-color: rgba(47, 47, 47, 0.7) !important;
        }
        .dark ::-webkit-scrollbar-track { background: #000000; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .dark .theme-doodle {
            background-color: #000000 !important;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234B5563' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") !important;
        }
        .dark .theme-geometric {
            background-color: #000000 !important;
            background-image: linear-gradient(135deg, #000000 25%, transparent 25%), linear-gradient(225deg, #000000 25%, transparent 25%), linear-gradient(45deg, #000000 25%, transparent 25%), linear-gradient(315deg, #000000 25%, #121212 25%) !important;
        }
        .dark .reaction-chip {
            background-color: #2a2a2a !important;
        }
        .dark .dark-text-glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        /* --- END DARKER THEME OVERRIDES --- */

        /* --- NEW UI IMPROVEMENT STYLES --- */
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .bg-gradient-custom {
            background-image: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
        }
        .border-gradient-custom {
            border-image-slice: 1;
            border-image-source: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
        }
        .logo-text span.large {
            font-size: 1.25em; /* Makes 'T' bigger */
            vertical-align: baseline;
        }

        /* Glass Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.5); /* From dark:bg-gray-800 */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Simple scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px;}
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .hidden { display: none; }
        .message-bubble-wrapper:hover .action-btn {
            opacity: 1;
        }
        .dark .dark-text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
        /* Rich Link Preview Styles */
        .link-preview {
            border-left: 3px solid #6a0dad;
        }
        .link-preview-image {
            width: 64px;
            height: 64px;
            object-fit: cover;
        }
        .rewrite-suggestion {
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .rewrite-suggestion:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Emoji Reactions */
        .reaction-chip {
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.2s;
        }
        .dark .reaction-chip {
            background-color: #4b5563; /* gray-600 */
        }
        .reaction-chip.reacted-by-me {
            background-color: #60a5fa; /* blue-400 */
            color: white;
        }
        .dark .reaction-chip.reacted-by-me {
            background-color: #3b82f6; /* blue-500 */
        }

        /* NEW: Style for highlighting replied messages */
        .highlight-message {
            background-color: rgba(106, 13, 173, 0.3) !important;
            box-shadow: 0 0 10px rgba(106, 13, 173, 0.5);
            transition: background-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out;
        }
        
        /* --- STATUS FEATURE STYLES --- */
        .status-ring {
            padding: 2px;
            border-radius: 9999px;
            background: linear-gradient(to right, #8b5cf6, #f59e0b); /* purple-500 to amber-500 */
        }
        .status-ring-seen {
            padding: 2px;
            border-radius: 9999px;
            background: #d1d5db; /* gray-300 */
        }
        .dark .status-ring-seen {
            background: #4b5563; /* gray-600 */
        }
        #status-viewer-modal {
            background-color: rgba(0,0,0,0.95);
        }
        #status-viewer-modal video, #status-viewer-modal img {
            max-height: 85vh; /* Adjusted for reply bar */
            max-width: 100vw;
            object-fit: contain;
        }
        .progress-bar-segment {
            background-color: rgba(255, 255, 255, 0.3);
            flex: 1 1 0%;
            height: 3px;
            border-radius: 2px;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            width: 0%; /* Controlled by JS now */
            transition: width 0.1s linear;
        }
        #status-upload-preview video, #status-upload-preview img {
             max-height: 60vh;
             object-fit: contain;
        }
        #like-status-btn .liked {
            color: #ef4444; /* red-500 */
            fill: #ef4444;
        }

        /* --- CHAT THEME STYLES --- */
        .theme-preview-item {
            cursor: pointer;
        }
        .theme-preview-item .border-primary {
            border-color: #6a0dad;
        }
        .theme-preview-item > div {
            background-size: cover;
            background-position: center;
        }

        /* Base styles for themes on messages container */
        #messages-container {
            transition: background 0.3s ease;
        }

        /* Theme 1: Doodle Fun */
        .theme-doodle {
            background-color: #f3f4f6; /* light: gray-100 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239CA3AF' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-doodle {
            background-color: #111827; /* dark: gray-900 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234B5563' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 2: Geometric Bliss */
        .theme-geometric {
            background-color: #f3f4f6;
            background-image: linear-gradient(135deg, #f3f4f6 25%, transparent 25%), linear-gradient(225deg, #f3f4f6 25%, transparent 25%), linear-gradient(45deg, #f3f4f6 25%, transparent 25%), linear-gradient(315deg, #f3f4f6 25%, #e5e7eb 25%);
            background-size: 40px 40px;
            background-position: -10px 0, -10px 0, 0 0, 0 0;
        }
        .dark .theme-geometric {
            background-color: #111827;
            background-image: linear-gradient(135deg, #111827 25%, transparent 25%), linear-gradient(225deg, #111827 25%, transparent 25%), linear-gradient(45deg, #111827 25%, transparent 25%), linear-gradient(315deg, #111827 25%, #1f2937 25%);
        }

        /* Theme 3: Cosmic Dust */
        .theme-cosmic {
            background-color: #0c0a1a;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="0.1"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9z"/%3E%3Cpath d="M6 5V0h1v5h5v1H6v5H5V6H0V5h5z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }
        html:not(.dark) .theme-cosmic {
            background-color: #f0f2ff;
            background-image: none; /* or a very light pattern if needed */
        }

        /* Theme 4: Lush Leaves */
        .theme-leaves {
            background-color: #f0fff4; /* mint-cream like */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23a7f3d0' fill-opacity='0.2'%3E%3Cpath fill-rule='evenodd' d='M11 0l5 20-5-5-5 5L11 0zm22 24l5 20-5-5-5 5 5-20zm22 24l5 20-5-5-5 5 5-20zM11 48l5 20-5-5-5 5 5-20z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-leaves {
            background-color: #052e16; /* dark green */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23a7f3d0' fill-opacity='0.1'%3E%3Cpath fill-rule='evenodd' d='M11 0l5 20-5-5-5 5L11 0zm22 24l5 20-5-5-5 5 5-20zm22 24l5 20-5-5-5 5 5-20zM11 48l5 20-5-5-5 5 5-20z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 5: Oceanic Waves */
        .theme-waves {
            background: #e0f2fe; /* light blue */
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%237dd3fc' fill-opacity='0.2'%3E%3Cpath d='M0 40c0 11.046 8.954 20 20 20s20-8.954 20-20S31.046 20 20 20 0 28.954 0 40zm80 0c0 11.046-8.954 20-20 20s-20-8.954-20-20 8.954-20 20-20 20 8.954 20 20zM20 0c11.046 0 20 8.954 20 20s-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0zm40 80c11.046 0 20-8.954 20-20s-8.954-20-20-20-20 8.954-20 20 8.954 20 20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-waves {
            background: #0c2a4d; /* dark blue */
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%237dd3fc' fill-opacity='0.1'%3E%3Cpath d='M0 40c0 11.046 8.954 20 20 20s20-8.954 20-20S31.046 20 20 20 0 28.954 0 40zm80 0c0 11.046-8.954 20-20 20s-20-8.954-20-20 8.954-20 20-20 20 8.954 20 20zM20 0c11.046 0 20 8.954 20 20s-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0zm40 80c11.046 0 20-8.954 20-20s-8.954-20-20-20-20 8.954-20 20 8.954 20 20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 6: Sunset Gradient */
        .theme-sunset {
            background: linear-gradient(170deg, #fef3c7, #fbcfe8, #e9d5ff);
        }
        .dark .theme-sunset {
            background: linear-gradient(170deg, #422006, #4a044e, #2e1065);
        }

        /* --- GRADIENT THEMES --- */
        /* Theme 7: Minty Fresh */
        .theme-minty {
            background: linear-gradient(170deg, #d4fc79, #96e6a1);
        }
        .dark .theme-minty {
            background: linear-gradient(170deg, #09203f, #537895);
        }

        /* Theme 8: Royal Amethyst */
        .theme-amethyst {
            background: linear-gradient(170deg, #c471f5, #fa71cd);
        }
        .dark .theme-amethyst {
            background: linear-gradient(170deg, #480572, #240039);
        }

        /* Theme 9: Fiery Sunrise */
        .theme-sunrise {
            background: linear-gradient(170deg, #fceabb, #f8b500);
        }
        .dark .theme-sunrise {
            background: linear-gradient(170deg, #870000, #190a05);
        }

        /* Theme 10: Cyber Glow */
       
        .theme-cyber {
            background: linear-gradient(170deg, #00d2ff, #3a7bd5);
        }
        .dark .theme-cyber {
            background: linear-gradient(170deg, #f02fc2, #6094ea);
        }

        /* Theme 11: Arctic Night */
        .theme-arctic {
            background: linear-gradient(170deg, #e0c3fc, #8ec5fc);
        }
        .dark .theme-arctic {
            background: linear-gradient(170deg, #000428, #004e92);
        }

        /* Theme 12: Sweet Peach */
        .theme-peach {
            background: linear-gradient(170deg, #ffdde1, #ee9ca7);
        }
        .dark .theme-peach {
            background: linear-gradient(170deg, #6d2e36, #3b171c);
        }

        /* --- NEW: MEDIA PREVIEW STYLES --- */
        #thumbnail-list::-webkit-scrollbar {
            height: 4px;
        }
        #thumbnail-list::-webkit-scrollbar-track {
            background: transparent;
        }
        #thumbnail-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .dark #thumbnail-list::-webkit-scrollbar-thumb {
            background: #4a5568;
        }
        .thumbnail-item {
            position: relative;
            flex-shrink: 0;
        }
        .thumbnail-item img,
        .thumbnail-item video {
            width: 4.5rem; /* 72px */
            height: 4.5rem; /* 72px */
            object-fit: cover;
            border-radius: 0.5rem; /* 8px */
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .remove-thumbnail-btn {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            line-height: 1;
            cursor: pointer;
            border: 2px solid white;
            transition: background-color 0.2s;
        }
        .remove-thumbnail-btn:hover {
            background-color: rgba(239, 68, 68, 0.8); /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
        <h1 class="text-6xl font-bold logo-text text-gradient animate-fade-in">
            <span class="large">T</span>winkle
        </h1>
    </div>

    <div id="auth-page" class="hidden">
        <div class="w-screen h-screen grid grid-cols-1 md:grid-cols-2">
            
            <div class="hidden md:flex flex-col items-center justify-center bg-gradient-to-br from-primary via-purple-800 to-indigo-700 text-white p-12 text-center relative overflow-hidden">
                <div class="absolute -top-16 -left-16 w-64 h-64 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-24 -right-10 w-72 h-72 bg-white/10 rounded-full"></div>
                
                <div class="z-10 animate-fade-in">
                    <h1 class="text-7xl font-bold logo-text">
                        <span class="large">T</span>winkle
                    </h1>
                    <p class="mt-4 text-lg text-purple-200 max-w-sm mx-auto">
                        Connect instantly. Chat seamlessly. Welcome to the future of conversation.
                    </p>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 overflow-y-auto">
                <div class="w-full max-w-md">
                    
                    <div id="login-view">
                        <div class="p-8 space-y-6 md:bg-white md:dark:bg-gray-800 md:rounded-2xl md:shadow-2xl animate-scale-in">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Welcome Back!</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Login to continue to Twinkle</p>
                            </div>
                            <form id="login-form" class="space-y-6">
                                <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <button type="submit" class="w-full py-3 text-white bg-gradient-custom rounded-md hover:opacity-90 transition-opacity font-bold active:scale-95">Login</button>
                            </form>
                            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Don't have an account? <a href="#" id="show-signup" class="font-medium text-primary hover:underline">Sign up</a></p>
                        </div>
                    </div>

                    <div id="signup-view" class="hidden">
                        <div class="p-8 space-y-6 md:bg-white md:dark:bg-gray-800 md:rounded-2xl md:shadow-2xl animate-scale-in">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Create Account</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Get started with Twinkle</p>
                            </div>
                            <form id="signup-form" class="space-y-6">
                                <input type="text" id="signup-username" placeholder="Username (must be unique)" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <button type="submit" class="w-full py-3 text-white bg-gradient-custom rounded-md hover:opacity-90 transition-opacity font-bold active:scale-95">Sign Up</button>
                            </form>
                            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Already have an account? <a href="#" id="show-login" class="font-medium text-primary hover:underline">Login</a></p>
                        </div>
                    </div>

                </div>
            </div>
            
        </div>
    </div>

    <div id="crop-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 class="text-lg font-bold text-center text-gray-900 dark:text-white">Crop Your Photo</h3>
            <div id="crop-container" class="w-full h-64"></div>
            <div class="flex justify-center space-x-4">
                 <button id="cancel-crop-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                 <button id="save-crop-btn" class="py-2 px-4 text-sm font-medium text-white bg-primary rounded-md hover:bg-purple-800 transition">Crop & Save</button>
            </div>
        </div>
    </div>

    <div id="upload-status-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold text-center text-gray-900 dark:text-white">Create Status</h3>
            <div id="status-upload-preview" class="flex-1 flex items-center justify-center bg-gray-100 dark:bg-gray-900 rounded-lg overflow-hidden">
                </div>
             <input type="text" id="status-caption-input" placeholder="Add a caption..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
            <div id="status-upload-error" class="text-red-500 text-sm text-center"></div>
            <div class="flex justify-center space-x-4">
                 <button id="cancel-status-upload-btn" class="w-full py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                 <button id="confirm-status-upload-btn" class="w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Upload</button>
            </div>
        </div>
    </div>
    <input type="file" id="status-file-input" class="hidden" accept="image/*,video/mp4,video/quicktime,video/webm">

    <div id="status-viewers-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-end justify-center z-[60]">
        <div class="bg-white dark:bg-gray-800 rounded-t-2xl shadow-xl w-full max-w-lg p-4 space-y-3 max-h-[60vh] flex flex-col">
            <div class="flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Viewers</h3>
                <button id="close-viewers-modal-btn">&times;</button>
            </div>
            <div id="status-viewers-list" class="flex-1 overflow-y-auto space-y-3">
                </div>
        </div>
    </div>


    <div id="app-container" class="hidden h-screen w-screen flex flex-col bg-gray-100 dark:bg-gray-900">
        <header class="fixed top-0 left-0 right-0 glass-effect py-2 px-4 flex justify-between items-center z-10">
             <h1 class="text-xl font-bold logo-text text-gradient">
                <span class="large">T</span>winkle
            </h1>
            <button id="open-gemini-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white transition-colors">
                <img src="https://static.vecteezy.com/system/resources/previews/055/687/055/non_2x/rectangle-gemini-google-icon-symbol-logo-free-png.png"  width="27" height="27">
        </header>

        <main class="flex-1 overflow-y-auto pb-20 pt-14">
            <div id="chats-page" class="page p-4 relative h-full">
                <input type="search" id="search-input" placeholder="Search existing chats..." class="w-full mb-4 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                <div id="chat-list" class="space-y-3">
                    </div>
            </div>

            <div id="status-page" class="page hidden p-4 space-y-6">
                <div id="my-status-section" class="flex items-center space-x-4 p-3 bg-white dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    <div class="relative">
                        <img id="my-status-pic" class="w-14 h-14 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="My Profile">
                        <button id="add-status-btn" class="absolute bottom-0 right-0 bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-800">
                             <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">My Status</h3>
                        <p id="my-status-subtitle" class="text-sm text-gray-500 dark:text-gray-400">Tap to add a new status</p>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-gray-500 dark:text-gray-400 font-semibold mb-2 px-2">RECENT UPDATES</h4>
                    <div id="status-list" class="space-y-3">
                        </div>
                </div>
            </div>
            
            <div id="settings-page" class="page hidden">
                <header class="p-4 flex-shrink-0">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h2>
                </header>
                <div class="p-4 space-y-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="search" placeholder="Search settings" class="w-full pl-10 pr-4 py-2 text-sm border-gray-300 dark:border-gray-700 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>

                    <div id="settings-profile-link" class="flex items-center space-x-4 p-3 bg-white dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <img id="settings-profile-pic" class="w-16 h-16 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile">
                        <div>
                            <h3 id="settings-profile-username" class="font-bold text-lg text-gray-900 dark:text-white">Username</h3>
                            <p id="settings-profile-bio" class="text-sm text-gray-500 dark:text-gray-400 truncate">This is your bio...</p>
                        </div>
                    </div>

                    <div class="space-y-1 bg-white dark:bg-gray-800 rounded-lg p-2">
                        <a href="#" id="favorites-settings-link" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                            <span class="text-gray-900 dark:text-white">Favorites</span>
                        </a>
                        <a href="#" id="privacy-settings-link" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                            <span class="text-gray-900 dark:text-white">Privacy</span>
                        </a>
                         <a href="#" id="chat-settings-section-link" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="text-gray-900 dark:text-white">Chat Settings</span>
                        </a>
                    </div>

                    <button id="logout-button" class="w-full mt-4 py-3 text-white bg-red-500 rounded-lg hover:bg-red-600 transition active:scale-95">Logout</button>
                </div>
            </div>

            <div id="privacy-settings-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-privacy-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Privacy Settings</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Read Receipts</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">If turned off, you won't send or receive read receipts.</p>
                                </div>
                                <button id="read-receipts-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 flex-shrink-0">
                                    <span id="read-receipts-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                        </div>
                </div>
            </div>
            
             <div id="chat-settings-section-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-chat-settings-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Chat Settings</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Dark Mode</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Toggle between light and dark theme for the app.</p>
                                </div>
                                <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 flex-shrink-0">
                                    <span id="theme-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                        <div id="chat-theme-selector-link" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Chat Background Theme</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Select a background for your chats.</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="current-theme-preview" class="w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-theme-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-40">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-chat-theme-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Select a Theme</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto grid grid-cols-2 gap-4">
                        <div class="theme-preview-item" data-theme="theme-default">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent bg-gray-100 dark:bg-gray-900 flex items-center justify-center"><span class="text-gray-800 dark:text-gray-200">Default</span></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Default</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-doodle">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-doodle"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Doodle Fun</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-geometric">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-geometric"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Geometric Bliss</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-cosmic">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-cosmic"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Cosmic Dust</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-leaves">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-leaves"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Lush Leaves</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-waves">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-waves"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Oceanic Waves</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-sunset">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-sunset"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Sunset Gradient</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-minty">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-minty"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Minty Fresh</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-amethyst">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-amethyst"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Royal Amethyst</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-sunrise">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-sunrise"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Fiery Sunrise</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-cyber">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-cyber"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Cyber Glow</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-arctic">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-arctic"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Arctic Night</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-peach">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-peach"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Sweet Peach</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="favorites-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-favorites-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Favorite Chats</h2>
                </header>
                <div id="favorites-list-container" class="flex-1 overflow-y-auto p-4 space-y-3">
                    </div>
            </div>

            <div id="profile-edit-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                 <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-profile-edit-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Edit Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <div id="profile-pic-container" class="relative w-24 h-24 mx-auto mb-4 cursor-pointer group">
                                <img id="profile-pic-display" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile Picture">
                                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="text-white text-xs font-bold">Change</span>
                                </div>
                            </div>
                            <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                            
                            <div id="username-display-container" class="flex justify-center items-center gap-2 mb-1">
                                <h3 id="profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                                <button id="edit-username-btn" class="text-sm text-primary font-semibold p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L13.196 5.232z" /></svg>
                                </button>
                            </div>

                            <div id="username-input-container" class="hidden max-w-xs mx-auto">
                                <input type="text" id="username-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-center text-gray-900 dark:text-gray-200" />
                                <div class="mt-2 flex gap-2">
                                     <button id="cancel-username-btn" class="w-full py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                                     <button id="save-username-btn" class="w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                                </div>
                            </div>

                            <p id="profile-email" class="text-gray-500 dark:text-gray-400">email@example.com</p>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-gray-800 dark:text-gray-200">Bio</h4>
                                <button id="edit-bio-btn" class="text-sm text-primary font-semibold">Edit</button>
                            </div>
                            <p id="bio-text" class="text-gray-600 dark:text-gray-300 text-sm">This is your bio. Click edit to change it.</p>
                            <textarea id="bio-input" class="hidden w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-200" rows="3"></textarea>
                            <button id="save-bio-btn" class="hidden mt-2 w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-room-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-to-chats-btn" class="text-primary dark:text-white p-2 text-sm">
                        Back
                    </button>
                    <div id="chat-room-header-clickable" class="flex items-center space-x-3 cursor-pointer flex-1">
                        <div id="chat-room-pic-wrapper" class="relative w-10 h-10">
                            <img id="chat-room-pic" class="w-10 h-10 rounded-full object-cover p-0.5 bg-white dark:bg-gray-800" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Partner">
                            <div id="chat-room-status-dot" class="w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>
                        </div>
                        <div>
                            <h2 id="chat-room-username" class="font-bold text-gray-900 dark:text-white dark-text-glow">Chat Partner</h2>
                            <p id="chat-room-status-text" class="text-xs text-gray-500">Offline</p>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="chat-settings-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                        <div id="chat-settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg z-10">
                            <a href="#" id="favorite-chat-btn" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                <svg id="favorite-chat-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                                <span id="favorite-chat-text">Favorite</span>
                            </a>
                            <a href="#" id="delete-chat-btn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Delete Chat</a>
                        </div>
                    </div>
                </header>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div id="emoji-reaction-picker" class="hidden absolute z-20 flex items-center gap-2 p-1.5 bg-white dark:bg-gray-700 rounded-full shadow-lg transition-transform duration-150 ease-out">
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform"></button>
                    </div>
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <div id="typing-indicator-container" class="h-12"></div>
                    <div id="ai-rewrite-popup" class="hidden mb-2 p-4 bg-white dark:bg-gray-700 rounded-lg shadow-lg animate-fade-in-up">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold flex items-center"><span class="mr-2 text-lg"></span> Gemini</h4>
                            <button id="close-rewrite-popup-btn" class="text-gray-500 dark:text-gray-400">&times;</button>
                        </div>
                        <div id="rewrite-suggestions" class="space-y-2 text-sm">
                            </div>
                    </div>
                    <div id="reply-preview-container" class="hidden p-2 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p id="reply-preview-username" class="text-sm font-bold text-sky-500"></p>
                                <p id="reply-preview-text" class="text-xs text-gray-600 dark:text-gray-300"></p>
                            </div>
                            <button id="cancel-reply-btn" class="text-gray-500 dark:text-gray-400">&times;</button>
                        </div>
                    </div>
                    <button id="ai-rewrite-btn" class="hidden w-full mb-2 flex items-center justify-center gap-2 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                         AI Rewrite
                    </button>
                    
                    <div id="recording-indicator" class="hidden flex items-center justify-between mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-blink mr-2"></div>
                            <span class="text-sm text-gray-700 dark:text-gray-200">Recording...</span>
                        </div>
                        <span id="recording-timer" class="text-sm font-mono text-gray-700 dark:text-gray-200">0:00</span>
                    </div>

                    <div id="media-preview-container" class="hidden p-2 border-t dark:border-gray-700 flex items-center">
                        <div id="thumbnail-list" class="flex-1 flex items-center gap-2 overflow-x-auto py-1">
                            </div>
                        <button id="send-media-btn" class="ml-2 p-3 bg-primary text-white rounded-full hover:bg-purple-800 transition-colors active:scale-95 flex-shrink-0">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                        </button>
                    </div>

                    <form id="message-form" class="flex items-center">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="button" id="attach-photo-btn" class="ml-2 mr-2 p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white rounded-full transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                        <input type="file" id="photo-input" class="hidden" accept="image/*,video/mp4,video/quicktime,video/webm" multiple>
                        
                        <button type="button" id="voice-note-btn" class="ml-2 p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white rounded-full transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>

                        <button type="submit" class="hidden px-5 py-2 bg-primary text-white rounded-full hover:bg-purple-800 transition-colors active:scale-95 font-semibold">Send</button>
                    </form>
                </footer>
            </div>
            
            <div id="search-users-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-search-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <input type="search" id="user-search-input" placeholder="Search for users by username..." class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                </header>
                <div id="user-search-results" class="flex-1 overflow-y-auto p-4 space-y-3">
                    </div>
            </div>

            <div id="partner-profile-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-partner-profile-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                     <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <img id="partner-profile-pic" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50 mx-auto mb-4" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Partner Profile Picture">
                            <h3 id="partner-profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Bio</h4>
                            <p id="partner-profile-bio" class="text-gray-600 dark:text-gray-300 text-sm">No bio available.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gemini-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-gemini-btn" class="text-primary dark:text-white p-2 text-sm">
                        Back
                    </button>
                    <h2 class="font-bold text-gray-900 dark:text-white flex items-center">
    <img src="https://static.vecteezy.com/system/resources/previews/055/687/055/non_2x/rectangle-gemini-google-icon-symbol-logo-free-png.png" width="25" height="25"> &nbsp;  Gemini
                    </h2>
                </header>
                <div id="gemini-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <div id="gemini-typing-indicator" class="h-6 mb-2"></div>
                    <form id="gemini-message-form" class="flex items-center">
                        <input type="text" id="gemini-message-input" placeholder="Type a message to Gemini..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-gradient-custom text-white rounded-full hover:opacity-90 transition-opacity active:scale-95">Send</button>
                    </form>
                </footer>
            </div>

            <div id="delete-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4 text-center">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Delete Chat</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Are you sure you want to permanently delete this entire conversation?</p>
                    <div class="flex justify-center space-x-4">
                         <button id="cancel-delete-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                         <button id="confirm-delete-btn" class="py-2 px-4 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            </div>
            
            <div id="image-preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
                <div id="preview-content-container" class="max-w-full max-h-full flex items-center justify-center">
                    </div>
                <button id="close-preview-btn" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
                <a id="download-media-btn" href="#" download="twinkle-image.png" class="absolute bottom-4 right-4 bg-primary text-white p-3 rounded-full hover:bg-purple-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </a>
            </div>

        </main>

        <div id="status-viewer-modal" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-between">
            <button id="prev-status-btn" class="absolute left-0 top-0 h-full w-1/3 z-20"></button>
            <button id="next-status-btn" class="absolute right-0 top-0 h-full w-1/3 z-20"></button>

            <div class="absolute top-0 left-0 right-0 p-4 pt-6 z-30 w-full">
                <div id="status-progress-bars" class="flex items-center gap-1 mb-2">
                    </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img id="status-viewer-pic" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p id="status-viewer-username" class="font-bold text-white"></p>
                            <p id="status-viewer-time" class="text-xs text-gray-300"></p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button id="delete-status-btn" class="hidden text-white mr-4 p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <button id="close-status-viewer-btn" class="text-white p-1">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="status-viewer-content" class="w-full h-full flex items-center justify-center">
                </div>
            
            <div class="absolute bottom-0 left-0 right-0 p-4 z-30 w-full bg-gradient-to-t from-black/70 to-transparent">
                 <p id="status-viewer-caption" class="text-center text-white mb-2"></p>
                 <div id="status-viewer-footer">
                     </div>
            </div>
        </div>

        <nav class="glass-effect fixed bottom-0 left-0 right-0 mx-2 mb-2 rounded-xl flex justify-around py-0.5 px-1 z-10">
            <button data-page="chats-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                <div class="relative">
                    <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    <span id="chats-badge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                </div>
                <span class="text-xs font-semibold">Chats</span>
            </button>
             <button data-page="status-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span class="text-xs font-semibold">Status</span>
            </button>
            <button data-page="search-users-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                 <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <span class="text-xs font-semibold">Search</span>
            </button>
            <button data-page="settings-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs font-semibold">Settings</span>
            </button>
        </nav>
    </div>

    <script type="module">
        // =================================================================
        // 1. FIREBASE SDK IMPORTS (FROM CDN)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, where, orderBy, onSnapshot, addDoc,
            serverTimestamp, runTransaction, getDocs, limit, writeBatch, Timestamp, increment, arrayUnion, arrayRemove, collectionGroup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // =================================================================
        // 2. FIREBASE CONFIGURATION
        // =================================================================
       const firebaseConfig = {
          apiKey: "AIzaSyBMZBqPHViEWGA7mT_GN_mePBOnqT1NYz0",
          authDomain: "chat-app-e1891.firebaseapp.com",
          projectId: "chat-app-e1891",
          storageBucket: "chat-app-e1891.appspot.com",
          messagingSenderId: "889518853542",
          appId: "1:889518853542:web:969c0d35177a3fb2fd9367"
        };

        // =================================================================
        // 3. INITIALIZE FIREBASE & SERVICES
        // =================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        // =================================================================
        // 4. GLOBAL STATE & DOM REFERENCES
        // =================================================================
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribeChats = null;
        let unsubscribeUsers = null;
        let unsubscribeMessages = null;
        let unsubscribePartnerStatus = null;
        let unsubscribeTypingStatus = null;
        let unsubscribeStatuses = null;
        let unsubscribeStatusItem = null; // For real-time like/view updates
        let typingTimeout = null;
        let currentReply = null;
        let geminiChatHistory = [];
        let readReceiptObserver = null;
        let pressHoldTimer = null;
        let activeMessageForReaction = null;
        let usernameCheckTimeout = null;
        let croppieInstance = null;
        let currentStatusViewerTimeout = null;
        let currentViewingStatus = {}; 
        let selectedMediaFiles = []; // NEW: For multi-photo preview
        
        // Voice Note Globals
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingTimerInterval;


        // Data caches for real-time updates
        let allChatsData = [];
        let allUsersData = {};
        let allStatusesData = {}; 
        
        const loadingScreen = document.getElementById('loading-screen');
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        const pages = document.querySelectorAll('.page');
        
        // Forms & Toggles
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        
        // Crop Modal References
        const cropModal = document.getElementById('crop-modal');
        const cropContainer = document.getElementById('crop-container');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const saveCropBtn = document.getElementById('save-crop-btn');

        // Buttons
        const logoutButton = document.getElementById('logout-button');
        const navButtons = document.querySelectorAll('.nav-btn');
        const openGeminiBtn = document.getElementById('open-gemini-btn');
        
        // Chat List
        const searchInput = document.getElementById('search-input');
        const chatList = document.getElementById('chat-list');
        const chatsBadge = document.getElementById('chats-badge');
        
        // Chat Room
        const chatRoomPage = document.getElementById('chat-room-page');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const chatRoomHeaderClickable = document.getElementById('chat-room-header-clickable');
        const chatRoomPicWrapper = document.getElementById('chat-room-pic-wrapper');
        const chatRoomUsername = document.getElementById('chat-room-username');
        const chatRoomPic = document.getElementById('chat-room-pic');
        const chatRoomStatusDot = document.getElementById('chat-room-status-dot');
        const chatRoomStatusText = document.getElementById('chat-room-status-text');
        const replyPreviewContainer = document.getElementById('reply-preview-container');
        const replyPreviewUsername = document.getElementById('reply-preview-username');
        const replyPreviewText = document.getElementById('reply-preview-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        const chatSettingsMenu = document.getElementById('chat-settings-menu');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const emojiReactionPicker = document.getElementById('emoji-reaction-picker');

        // Photo Upload References
        const attachPhotoBtn = document.getElementById('attach-photo-btn');
        const photoInput = document.getElementById('photo-input');
        
        // Voice Note References
        const voiceNoteBtn = document.getElementById('voice-note-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        const recordingTimer = document.getElementById('recording-timer');
        
        // NEW: Media Preview DOM References
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        const thumbnailList = document.getElementById('thumbnail-list');
        const sendMediaBtn = document.getElementById('send-media-btn');
        
        const imagePreviewModal = document.getElementById('image-preview-modal');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const downloadMediaBtn = document.getElementById('download-media-btn');


        // User Search
        const searchUsersPage = document.getElementById('search-users-page');
        const backFromSearchBtn = document.getElementById('back-from-search-btn');
        const userSearchInput = document.getElementById('user-search-input');
        const userSearchResults = document.getElementById('user-search-results');

        // Settings Page
        const settingsProfileLink = document.getElementById('settings-profile-link');
        const settingsProfilePic = document.getElementById('settings-profile-pic');
        const settingsProfileUsername = document.getElementById('settings-profile-username');
        const settingsProfileBio = document.getElementById('settings-profile-bio');
        const privacySettingsLink = document.getElementById('privacy-settings-link');

        // Privacy Settings Page
        const backFromPrivacyBtn = document.getElementById('back-from-privacy-btn');

        // Profile Edit Page
        const backFromProfileEditBtn = document.getElementById('back-from-profile-edit-btn');
        const profilePicContainer = document.getElementById('profile-pic-container');
        const profilePicInput = document.getElementById('profile-pic-input');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const editBioBtn = document.getElementById('edit-bio-btn');
        const saveBioBtn = document.getElementById('save-bio-btn');
        const bioText = document.getElementById('bio-text');
        const bioInput = document.getElementById('bio-input');
        const editUsernameBtn = document.getElementById('edit-username-btn');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const cancelUsernameBtn = document.getElementById('cancel-username-btn');
        const usernameInput = document.getElementById('username-input');
        const usernameDisplayContainer = document.getElementById('username-display-container');
        const usernameInputContainer = document.getElementById('username-input-container');


        // Partner Profile Page
        const partnerProfilePage = document.getElementById('partner-profile-page');
        const backFromPartnerProfileBtn = document.getElementById('back-from-partner-profile-btn');
        const partnerProfilePic = document.getElementById('partner-profile-pic');
        const partnerProfileUsername = document.getElementById('partner-profile-username');
        const partnerProfileBio = document.getElementById('partner-profile-bio');

        // Gemini Page
        const geminiPage = document.getElementById('gemini-page');
        const backFromGeminiBtn = document.getElementById('back-from-gemini-btn');
        const geminiMessagesContainer = document.getElementById('gemini-messages-container');
        const geminiMessageForm = document.getElementById('gemini-message-form');
        const geminiMessageInput = document.getElementById('gemini-message-input');
        const geminiTypingIndicator = document.getElementById('gemini-typing-indicator');

        // Modals
        const deleteChatModal = document.getElementById('delete-chat-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // AI Rewrite References
        const aiRewriteBtn = document.getElementById('ai-rewrite-btn');
        const aiRewritePopup = document.getElementById('ai-rewrite-popup');
        const closeRewritePopupBtn = document.getElementById('close-rewrite-popup-btn');
        const rewriteSuggestionsContainer = document.getElementById('rewrite-suggestions');
        
        // Theme Toggle & Chat Themes
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleSlider = document.getElementById('theme-toggle-slider');
        const readReceiptsToggle = document.getElementById('read-receipts-toggle');
        const readReceiptsToggleSlider = document.getElementById('read-receipts-toggle-slider');
        const chatSettingsSectionLink = document.getElementById('chat-settings-section-link');
        const chatSettingsSectionPage = document.getElementById('chat-settings-section-page');
        const backFromChatSettingsBtn = document.getElementById('back-from-chat-settings-btn');
        const chatThemeSelectorLink = document.getElementById('chat-theme-selector-link');
        const chatThemePage = document.getElementById('chat-theme-page');
        const backFromChatThemeBtn = document.getElementById('back-from-chat-theme-btn');
        const themePreviewItems = document.querySelectorAll('.theme-preview-item');
        const currentThemePreview = document.getElementById('current-theme-preview');

        // Status DOM References
        const statusPage = document.getElementById('status-page');
        const myStatusSection = document.getElementById('my-status-section');
        const myStatusPic = document.getElementById('my-status-pic');
        const myStatusSubtitle = document.getElementById('my-status-subtitle');
        const addStatusBtn = document.getElementById('add-status-btn');
        const statusList = document.getElementById('status-list');
        const uploadStatusModal = document.getElementById('upload-status-modal');
        const statusFileInput = document.getElementById('status-file-input');
        const statusUploadPreview = document.getElementById('status-upload-preview');
        const statusCaptionInput = document.getElementById('status-caption-input');
        const statusUploadError = document.getElementById('status-upload-error');
        const cancelStatusUploadBtn = document.getElementById('cancel-status-upload-btn');
        const confirmStatusUploadBtn = document.getElementById('confirm-status-upload-btn');
        const statusViewerModal = document.getElementById('status-viewer-modal');
        const statusProgressBars = document.getElementById('status-progress-bars');
        const statusViewerPic = document.getElementById('status-viewer-pic');
        const statusViewerUsername = document.getElementById('status-viewer-username');
        const statusViewerTime = document.getElementById('status-viewer-time');
        const closeStatusViewerBtn = document.getElementById('close-status-viewer-btn');
        const statusViewerContent = document.getElementById('status-viewer-content');
        const statusViewerCaption = document.getElementById('status-viewer-caption');
        const statusViewerFooter = document.getElementById('status-viewer-footer');
        const deleteStatusBtn = document.getElementById('delete-status-btn');
        const prevStatusBtn = document.getElementById('prev-status-btn');
        const nextStatusBtn = document.getElementById('next-status-btn');
        const statusViewersModal = document.getElementById('status-viewers-modal');
        const closeViewersModalBtn = document.getElementById('close-viewers-modal-btn');
        const statusViewersList = document.getElementById('status-viewers-list');
        
        // Favorites Feature DOM references
        const favoritesPage = document.getElementById('favorites-page');
        const backFromFavoritesBtn = document.getElementById('back-from-favorites-btn');
        const favoritesSettingsLink = document.getElementById('favorites-settings-link');
        const favoritesListContainer = document.getElementById('favorites-list-container');
        const favoriteChatBtn = document.getElementById('favorite-chat-btn');
        const favoriteChatIcon = document.getElementById('favorite-chat-icon');
        const favoriteChatText = document.getElementById('favorite-chat-text');

        // =================================================================
        // 5. HELPER FUNCTIONS
        // =================================================================
        const getInitials = (name = '') => name ? name.charAt(0).toUpperCase() : '?';
        const getPlaceholderUrl = (initials) => `https://placehold.co/100x100/6a0dad/white?text=${initials}`;
        const timeAgo = (timestamp) => {
            if (!timestamp) return '';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp.toMillis()) / 1000);
            
            if (seconds < 60) return `just now`;
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) {
                const days = Math.floor(interval);
                if (days === 1) return "yesterday";
                return days + " days ago";
            }
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return `just now`;
        };
        const formatMessageTime = (timestamp) => {
            if (!timestamp) return '';
            return timestamp.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        };

        const formatDuration = (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        const extractUrls = (text) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.match(urlRegex) || [];
        }

        async function fetchLinkPreview(url) {
            const cachedData = sessionStorage.getItem(url);
            if (cachedData) {
                return JSON.parse(cachedData);
            }

            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) return null;
                const data = await response.json();
                const html = data.contents;
                
                if (!html) return null;

                const doc = new DOMParser().parseFromString(html, 'text/html');
                const title = doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || doc.querySelector('title')?.textContent || '';
                const description = doc.querySelector('meta[property="og:description"]')?.getAttribute('content') || doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';
                let image = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';
                
                if (image && !image.startsWith('http')) {
                    try {
                        const urlObj = new URL(url);
                        image = `${urlObj.origin}${image}`;
                    } catch (e) {
                        image = '';
                    }
                }

                const previewData = {
                    url,
                    title: title.trim(),
                    description: description.trim(),
                    image: image || 'https://placehold.co/64x64/eee/ccc?text=N/A'
                };

                sessionStorage.setItem(url, JSON.stringify(previewData));
                return previewData;
            } catch (error) {
                console.error("Error fetching link preview:", error);
                return null;
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            let bgColor = 'bg-blue-500'; // info
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            toast.className = `fixed top-16 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg z-[100] animate-fade-in-up toast-element`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }


        // =================================================================
        // 6. PAGE NAVIGATION LOGIC
        // =================================================================
        function showPage(pageId, isOverlay = false) {
            if (!isOverlay) {
                pages.forEach(page => page.classList.add('hidden'));
            }
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
            }
            if (!isOverlay) updateNavButtons(pageId);
        }

        function hidePage(pageId) {
            const page = document.getElementById(pageId);
            if(page) page.classList.add('hidden');
        }

        function updateNavButtons(activePageId) {
            navButtons.forEach(btn => {
                const isTarget = btn.dataset.page === activePageId;
                btn.classList.toggle('text-gray-500', !isTarget);
                btn.classList.toggle('dark:text-gray-400', !isTarget);
                
                // New active state with gradient border
                btn.classList.toggle('border-t-2', isTarget);
                btn.classList.toggle('border-gradient-custom', isTarget);
                btn.classList.toggle('text-primary', isTarget);
                btn.classList.toggle('dark:text-white', isTarget);

                // Remove old background highlight
                btn.classList.remove('bg-purple-100', 'dark:bg-gray-700');
            });
        }
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                if (pageId === 'search-users-page') {
                    showPage('search-users-page', true);
                    userSearchInput.value = '';
                    userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Type a username to find users.</p>';
                } else if (pageId === 'status-page') {
                    renderStatusList();
                    showPage(pageId);
                } else {
                    showPage(pageId);
                }
            });
        });

        openGeminiBtn.addEventListener('click', () => {
            // Add a greeting message if the chat is empty
            if (geminiChatHistory.length === 0) {
                const greetingText = "Hello! I'm Gemini. How can I help you today? You can ask me questions, request translations, or get help with your writing.";
                const greetingMessage = { role: 'model', parts: [{ text: greetingText }] };
                geminiChatHistory.push(greetingMessage);
                renderGeminiMessage(greetingText, 'gemini');
            }
            showPage('gemini-page', true);
        });
        
        // --- NEW Navigation for Chat Settings ---
        chatSettingsSectionLink.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('chat-settings-section-page', true);
        });

        backFromChatSettingsBtn.addEventListener('click', () => {
            hidePage('chat-settings-section-page');
        });

        chatThemeSelectorLink.addEventListener('click', () => {
            updateThemeSelectionUI(currentUser.settings?.chatTheme || 'theme-default');
            showPage('chat-theme-page', true);
        });

        backFromChatThemeBtn.addEventListener('click', () => {
            hidePage('chat-theme-page');
        });

        favoritesSettingsLink.addEventListener('click', (e) => {
            e.preventDefault();
            renderFavoritesPage(); // Render the content when opening
            showPage('favorites-page', true);
        });

        backFromFavoritesBtn.addEventListener('click', () => {
            hidePage('favorites-page');
        });


        // =================================================================
        // 7. AUTHENTICATION & PRESENCE MANAGEMENT
        // =================================================================
        onAuthStateChanged(auth, async (user) => {
            loadingScreen.classList.add('hidden');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };

                    authPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    showPage('chats-page');
                    setupRealtimeListeners();
                    managePresence(user.uid);
                    
                    // Update profile UI in both Settings and Edit Profile pages
                    const initials = getInitials(currentUser.username);
                    const profilePicUrl = currentUser.profilePicUrl || getPlaceholderUrl(initials);
                    const bio = currentUser.bio || 'This is your bio. Click to edit it.';

                    // Settings page elements
                    settingsProfileUsername.textContent = currentUser.username;
                    settingsProfileBio.textContent = bio;
                    settingsProfilePic.src = profilePicUrl;
                    myStatusPic.src = profilePicUrl; // Update status page pic too
                    
                    // Update Read Receipts toggle UI
                    const readReceiptsEnabled = currentUser.settings?.readReceipts ?? true;
                    updateReadReceiptsToggleUI(readReceiptsEnabled);

                    // Apply saved chat theme
                    const savedChatTheme = currentUser.settings?.chatTheme || 'theme-default';
                    applyChatTheme(savedChatTheme);

                    // Edit Profile page elements
                    profileUsername.textContent = currentUser.username;
                    profileEmail.textContent = currentUser.email;
                    bioText.textContent = bio;
                    profilePicDisplay.src = profilePicUrl;
                    
                } else {
                    console.error("User exists in Auth but not in Firestore. Logging out.");
                    signOut(auth); 
                }
            } else {
                currentUser = null;
                authPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupRealtimeListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (username.length < 3) return alert("Username must be at least 3 characters.");
            if (password.length < 6) return alert("Password must be at least 6 characters.");

            try {
                const usernameDoc = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameDoc.exists()) throw new Error("Username is already taken.");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", user.uid);
                    const usernameRef = doc(db, "usernames", username.toLowerCase());
                    
                    transaction.set(userRef, {
                        uid: user.uid,
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        email: email,
                        profilePicUrl: null,
                        bio: '',
                        createdAt: serverTimestamp(),
                        status: {
                            state: 'offline',
                            last_changed: serverTimestamp(),
                        },
                        settings: {
                            readReceipts: true,
                            chatTheme: 'theme-default'
                        }
                    });
                    transaction.set(usernameRef, { uid: user.uid });
                });
            } catch (error) {
                alert("Signup Error: " + error.message);
            }
        });

        logoutButton.addEventListener('click', async () => {
            if (currentUser) {
                const userStatusRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userStatusRef, {
                    status: { state: 'offline', last_changed: serverTimestamp() }
                });
            }
            await signOut(auth);
            window.location.reload();
        });

        showSignup.addEventListener('click', (e) => { 
            e.preventDefault(); 
            loginView.classList.add('hidden'); 
            signupView.classList.remove('hidden'); 
        });
        showLogin.addEventListener('click', (e) => { 
            e.preventDefault(); 
            signupView.classList.add('hidden'); 
            loginView.classList.remove('hidden'); 
        });

        function managePresence(uid) {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + uid);
            const userStatusFirestoreRef = doc(db, '/users/' + uid);

            const isOfflineForFirestore = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForFirestore = { state: 'online', last_changed: serverTimestamp() };

            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === false) {
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                    return;
                }
                const onDisconnectRef = onDisconnect(userStatusDatabaseRef);
                onDisconnectRef.set({ state: 'offline', last_changed: rtdbServerTimestamp() });
                set(userStatusDatabaseRef, { state: 'online', last_changed: rtdbServerTimestamp() });
                updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                } else {
                    updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
                }
            });
        }

        // =================================================================
        // 8. REALTIME LISTENERS & CHAT LIST
        // =================================================================
        function cleanupRealtimeListeners() {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeUsers) unsubscribeUsers();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            if (unsubscribeStatuses) unsubscribeStatuses();
            if (unsubscribeStatusItem) unsubscribeStatusItem();
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        }

        function setupRealtimeListeners() {
            cleanupRealtimeListeners();

            const usersQuery = query(collection(db, "users"));
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    allUsersData[change.doc.id] = change.doc.data();
                });
                renderCombinedChatList();
                if(!statusPage.classList.contains('hidden')){
                   renderStatusList();
                }
            });

            const chatsQuery = query(
                collection(db, "chats"),
                where("participants", "array-contains", currentUser.uid),
                orderBy("lastMessageTimestamp", "desc")
            );
            
            unsubscribeChats = onSnapshot(chatsQuery, (snapshot) => {
                allChatsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCombinedChatList();
                
                // if the favorites page is open, re-render it
                if (!favoritesPage.classList.contains('hidden')) {
                    renderFavoritesPage();
                }
                
                // if a chat room is open, update its favorite button
                if (currentChatPartner && !chatRoomPage.classList.contains('hidden')) {
                    const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
                    const chatDoc = allChatsData.find(c => c.id === chatId);
                    const isFavorite = chatDoc?.favoritedBy?.includes(currentUser.uid);
                    if (isFavorite) {
                        favoriteChatIcon.classList.add('text-amber-400', 'fill-current');
                        favoriteChatText.textContent = 'Unfavorite';
                    } else {
                        favoriteChatIcon.classList.remove('text-amber-400', 'fill-current');
                        favoriteChatText.textContent = 'Favorite';
                    }
                }

                setupStatusListener(); 
            });

            setupStatusListener();
        }
        
        function setupStatusListener() {
            if (unsubscribeStatuses) unsubscribeStatuses();
            
            const partnerIds = allChatsData.map(chat => chat.participants.find(id => id !== currentUser.uid)).filter(Boolean);
            
            const idsToWatch = [...new Set([currentUser.uid, ...partnerIds])];
            
            if (idsToWatch.length === 0) return; 

            const statusesQuery = query(
                collection(db, "statuses"),
                where("__name__", "in", idsToWatch)
            );
            
            unsubscribeStatuses = onSnapshot(statusesQuery, async (snapshot) => {
                 for (const docChange of snapshot.docChanges()) {
                    if (docChange.type !== "removed") {
                        const uid = docChange.doc.id;
                        const itemsQuery = query(
                            collection(db, `statuses/${uid}/items`),
                            where("expiresAt", ">", Timestamp.now())
                        );
                        const itemsSnapshot = await getDocs(itemsQuery);
                        allStatusesData[uid] = itemsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    } else {
                        delete allStatusesData[docChange.doc.id];
                    }
                }

                renderCombinedChatList(); 
                if(!statusPage.classList.contains('hidden')){
                   renderStatusList();
                }
            });
        }


        function renderCombinedChatList() {
            if (allChatsData.length === 0 && !statusPage.classList.contains('hidden')) {
                 chatList.innerHTML = ''; 
                 return;
            }
            if (allChatsData.length === 0) {
                chatList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">No chats yet. Click the 'Search' button to find users and start a conversation.</p>`;
                return;
            }

            let totalUnread = 0;
            const chatHtml = allChatsData.map(chat => {
                const partnerId = chat.participants.find(id => id !== currentUser.uid);
                if (!partnerId || !allUsersData[partnerId]) return '';

                const partner = allUsersData[partnerId];
                const currentUserUnreadCount = chat.unreadCount?.[currentUser.uid] || 0;
                totalUnread += currentUserUnreadCount;
                
                const partnerStatuses = (allStatusesData[partnerId] || []).filter(s => s.expiresAt.toMillis() > Date.now());
                const hasUnseenStatus = partnerStatuses.length > 0 && partnerStatuses.some(s => !(s.seenBy || []).includes(currentUser.uid));
                const statusRingClass = hasUnseenStatus ? 'status-ring' : '';

                const isOnline = partner.status?.state === 'online';
                const initials = getInitials(partner.username);
                const profilePicUrl = partner.profilePicUrl || getPlaceholderUrl(initials);
                const unreadIndicator = currentUserUnreadCount > 0 ? `<span class="w-3 h-3 bg-red-500 rounded-full"></span>` : '';

                const isFavorite = chat.favoritedBy?.includes(currentUser.uid);
                const favoriteIconHtml = isFavorite ? `
                    <svg class="w-4 h-4 text-amber-400 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                ` : '';

                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition chat-item" data-partner-id="${partner.uid}" data-partner-name="${partner.username}" data-partner-pic="${partner.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4 chat-list-pic-wrapper cursor-pointer" data-partner-id="${partner.uid}">
                        <div class="${statusRingClass}">
                           <img src="${profilePicUrl}" class="w-full h-full rounded-full object-cover bg-white dark:bg-gray-800 p-0.5" alt="Profile Pic">
                        </div>
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white dark:border-gray-800 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden cursor-pointer chat-item-details">
                        <div class="flex items-center gap-2">
                            <p class="font-bold truncate text-gray-900 dark:text-white">${partner.username}</p>
                            ${favoriteIconHtml}
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                    </div>
                    <div class="w-8 flex justify-end items-center">
                        ${unreadIndicator}
                    </div>
                </div>`;
            }).join('');

            chatList.innerHTML = chatHtml;

            if (totalUnread > 0) {
                chatsBadge.classList.remove('hidden');
            } else {
                chatsBadge.classList.add('hidden');
            }
        }
        
        function renderFavoritesPage() {
            const favoriteChats = allChatsData.filter(chat => chat.favoritedBy?.includes(currentUser.uid));

            if (favoriteChats.length === 0) {
                favoritesListContainer.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">You haven't favorited any chats yet. Open a chat and use the menu to add it to favorites.</p>`;
                return;
            }

            const favoritesHtml = favoriteChats.map(chat => {
                const partnerId = chat.participants.find(id => id !== currentUser.uid);
                if (!partnerId || !allUsersData[partnerId]) return '';

                const partner = allUsersData[partnerId];
                const isOnline = partner.status?.state === 'online';
                const initials = getInitials(partner.username);
                const profilePicUrl = partner.profilePicUrl || getPlaceholderUrl(initials);

                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition chat-item" data-partner-id="${partner.uid}" data-partner-name="${partner.username}" data-partner-pic="${partner.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-full h-full rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white dark:border-gray-800 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden cursor-pointer chat-item-details">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${partner.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                    </div>
                </div>`;
            }).join('');

            favoritesListContainer.innerHTML = favoritesHtml;
        }

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const partnerName = item.dataset.partnerName.toLowerCase();
                item.style.display = partnerName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // =================================================================
        // 9. CHAT ROOM LOGIC & READ RECEIPTS & TYPING INDICATOR
        // =================================================================

        function handleVisibilityChange() {
            if (!readReceiptObserver || chatRoomPage.classList.contains('hidden')) {
                return;
            }

            if (document.visibilityState === 'hidden') {
                readReceiptObserver.disconnect();
            } else if (document.visibilityState === 'visible') {
                messagesContainer.querySelectorAll('.unread-message').forEach(el => {
                    readReceiptObserver.observe(el);
                });
            }
        }

        chatList.addEventListener('click', (e) => {
            const chatItemDetails = e.target.closest('.chat-item-details');
            const profilePicWrapper = e.target.closest('.chat-list-pic-wrapper');

            if (profilePicWrapper) {
                 const partnerId = profilePicWrapper.dataset.partnerId;
                 const partnerStatuses = (allStatusesData[partnerId] || []).filter(s => s.expiresAt.toMillis() > Date.now());
                 if (partnerStatuses.length > 0) {
                     openStatusViewer(partnerId);
                 }
                 return; // Prevent opening chat
            }

            if (chatItemDetails) {
                 const chatItem = chatItemDetails.closest('.chat-item');
                openChatRoom({
                    uid: chatItem.dataset.partnerId,
                    username: chatItem.dataset.partnerName,
                    profilePicUrl: chatItem.dataset.partnerPic
                });
            }
        });

        favoritesListContainer.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                hidePage('favorites-page');
                openChatRoom({
                    uid: chatItem.dataset.partnerId,
                    username: chatItem.dataset.userName,
                    profilePicUrl: chatItem.dataset.userPic
                });
            }
        });
        
        async function openChatRoom(partner) {
            currentChatPartner = partner;
            showPage('chat-room-page', true);
            
            applyChatTheme(currentUser.settings?.chatTheme || 'theme-default');

            chatRoomUsername.textContent = partner.username;

            const initials = getInitials(partner.username);
            chatRoomPic.src = partner.profilePicUrl || getPlaceholderUrl(initials);
            
            // Apply status ring in chat room header
            const partnerStatuses = (allStatusesData[partner.uid] || []).filter(s => s.expiresAt.toMillis() > Date.now());
            const hasUnseenStatus = partnerStatuses.length > 0 && partnerStatuses.some(s => !(s.seenBy || []).includes(currentUser.uid));
            chatRoomPicWrapper.className = `relative w-10 h-10 ${hasUnseenStatus ? 'status-ring' : ''}`;


            if (readReceiptObserver) readReceiptObserver.disconnect();
            readReceiptObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageWrapper = entry.target;
                        const messageId = messageWrapper.dataset.messageId;
                        markSingleMessageAsRead(messageId);
                        observer.unobserve(messageWrapper);
                    }
                });
            }, { threshold: 0.8 });
            
            document.addEventListener('visibilitychange', handleVisibilityChange);

            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            unsubscribePartnerStatus = onSnapshot(doc(db, "users", partner.uid), (docSnap) => {
                const partnerData = docSnap.data();
                if (partnerData) {
                    currentChatPartner = { ...currentChatPartner, ...partnerData };
                    updatePartnerStatusUI(partnerData.status);
                }
            });

            function updatePartnerStatusUI(status) {
                const isOnline = status?.state === "online";
                chatRoomStatusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white dark:border-gray-800 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                
                if (isOnline) {
                    chatRoomStatusText.textContent = "Online";
                    chatRoomStatusText.className = "text-xs text-green-500";
                } else {
                    chatRoomStatusText.textContent = status?.last_changed ? `last seen ${timeAgo(status.last_changed)}` : "Offline";
                    chatRoomStatusText.className = "text-xs text-gray-500";
                }
            }

            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            // Update favorite button UI
            const chatDoc = allChatsData.find(c => c.id === chatId);
            const isFavorite = chatDoc?.favoritedBy?.includes(currentUser.uid);
            if (isFavorite) {
                favoriteChatIcon.classList.add('text-amber-400', 'fill-current');
                favoriteChatText.textContent = 'Unfavorite';
            } else {
                favoriteChatIcon.classList.remove('text-amber-400', 'fill-current');
                favoriteChatText.textContent = 'Favorite';
            }
            
            messagesContainer.innerHTML = "";

            if (unsubscribeMessages) unsubscribeMessages();

            const messagesQuery = query(
                collection(db, `chats/${chatId}/messages`),
                orderBy("timestamp", "asc")
            );

            let isInitialLoad = true;

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const isUserScrolledUp = messagesContainer.scrollHeight - messagesContainer.clientHeight > messagesContainer.scrollTop + 100;

                snapshot.docChanges().forEach((change) => {
                    const messageId = change.doc.id;
                    const messageData = change.doc.data();

                    if (change.type === "added") {
                        const messageElement = createMessageElement(messageId, messageData);
                        if (!isInitialLoad) {
                            messageElement.classList.add("animate-fade-in-up");
                        }
                        messagesContainer.appendChild(messageElement);
                        
                        if (messageElement.classList.contains('unread-message') && document.visibilityState === 'visible') {
                            readReceiptObserver.observe(messageElement);
                        }
                    }
                    if (change.type === "removed") {
                        const messageElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            readReceiptObserver.unobserve(messageElement);
                            messageElement.remove();
                        }
                    }
                    if (change.type === "modified") {
                        const existingElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                        if (existingElement) {
                            if(existingElement.classList.contains('unread-message')) {
                                readReceiptObserver.unobserve(existingElement);
                            }
                            const updatedElement = createMessageElement(messageId, messageData);
                            existingElement.replaceWith(updatedElement);
                             if (updatedElement.classList.contains('unread-message') && document.visibilityState === 'visible') {
                                readReceiptObserver.observe(updatedElement);
                            }
                        }
                    }
                });
                
                if (isInitialLoad) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    isInitialLoad = false;
                } else if (!isUserScrolledUp) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });

            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            const partnerTypingRef = ref(rtdb, `/typing/${chatId}/${partner.uid}`);
            const typingIndicatorContainer = document.getElementById('typing-indicator-container');

            unsubscribeTypingStatus = onValue(partnerTypingRef, (snap) => {
                if (snap.exists() && snap.val() === true) {
                    const initials = getInitials(currentChatPartner.username);
                    const profilePicUrl = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);

                    typingIndicatorContainer.innerHTML = `
                        <div class="flex items-center space-x-2 animate-fade-in">
                            <img src="${profilePicUrl}" class="w-8 h-8 rounded-full object-cover">
                            <div class="px-4 py-3 rounded-2xl bg-gray-200 dark:bg-gray-700">
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0s;"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.2s;"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    typingIndicatorContainer.innerHTML = '';
                }
            });
        }

        function createMessageElement(id, msg) {
            const isSender = msg.senderId === currentUser.uid;
            const partnerId = currentChatPartner?.uid;
            const partnerData = allUsersData[partnerId];
            
            const partnerHasReceiptsOn = partnerData?.settings?.readReceipts ?? true;
            const showReadReceipt = isSender && partnerHasReceiptsOn;
            
            let quotedContentHtml = '';
            if (msg.replyTo) {
                 let replyBody = '';
                 if (msg.replyTo.type === 'image' && msg.replyTo.imageUrl) {
                    replyBody = `<div class="flex items-center"><img src="${msg.replyTo.imageUrl}" class="w-8 h-8 rounded object-cover mr-2">  Photo</div>`;
                 } else if (msg.replyTo.type === 'video' && msg.replyTo.videoUrl) {
                    replyBody = `<div class="flex items-center"><video src="${msg.replyTo.videoUrl}" class="w-8 h-8 rounded object-cover mr-2"></video>  Video</div>`;
                 } else {
                    replyBody = `<p class="truncate">${msg.replyTo.text}</p>`;
                 }
                quotedContentHtml = `
                <div class="reply-bubble-clickable p-2 mb-1 text-xs bg-black bg-opacity-10 dark:bg-white dark:bg-opacity-10 rounded-md cursor-pointer" data-reply-to-id="${msg.replyTo.messageId}">
                    <p class="font-bold text-sky-500">${msg.replyTo.senderName}</p>
                    ${replyBody}
                </div>`;
            } else if (msg.statusReply) { // NEW: Status reply
                 quotedContentHtml = `
                 <div class="p-2 mb-1 text-xs bg-black bg-opacity-10 dark:bg-white dark:bg-opacity-10 rounded-md flex items-center gap-2">
                    ${msg.statusReply.mediaType === 'image' 
                        ? `<img src="${msg.statusReply.mediaUrl}" class="w-8 h-8 rounded object-cover">`
                        : `<video src="${msg.statusReply.mediaUrl}" class="w-8 h-8 rounded object-cover"></video>`
                    }
                    <div>
                        <p class="font-bold text-primary">Reply to ${msg.statusReply.originalSenderName}'s status</p>
                        <p class="truncate">${msg.text}</p>
                    </div>
                </div>`;
                msg.text = '';
            }

            const readReceipt = showReadReceipt ? `
                <div class="w-4 h-1.5 rounded-full ${msg.isRead ? 'bg-sky-500' : 'bg-gray-300 dark:bg-gray-500'} transition-colors"></div>
            ` : '';

            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col message-bubble-wrapper relative group ${isSender ? 'items-end' : 'items-start'}`;
            wrapper.dataset.messageId = id;
            wrapper.dataset.messageSender = isSender ? currentUser.username : currentChatPartner.username;
            wrapper.dataset.messageType = msg.type || 'text';
            if (msg.text) wrapper.dataset.messageText = msg.text;
            if (msg.imageUrl) wrapper.dataset.messageImageUrl = msg.imageUrl;
            if (msg.videoUrl) wrapper.dataset.messageVideoUrl = msg.videoUrl;
            
            const isReceiver = msg.receiverId === currentUser.uid;
            if(isReceiver && !msg.isRead) {
                wrapper.classList.add('unread-message');
            }

            let messageContentHtml = '';
            const isImageMessage = msg.type === 'image' && msg.imageUrl;
            const isVoiceMessage = msg.type === 'voice' && msg.audioUrl;
            const isVideoMessage = msg.type === 'video' && msg.videoUrl;

            if (isImageMessage) {
                messageContentHtml = `
                    <img src="${msg.imageUrl}" class="max-w-xs rounded-lg cursor-pointer message-photo" style="max-height: 200px;" alt="Sent image">
                `;
            } else if (isVideoMessage) {
                const { width, height } = msg.metadata || {};
                const aspectRatio = (width && height) ? `${width} / ${height}` : '16 / 9';
                messageContentHtml = `
                    <div class="relative max-w-[250px] rounded-lg overflow-hidden cursor-pointer message-video" style="aspect-ratio: ${aspectRatio};">
                        <video src="${msg.videoUrl}" class="w-full h-full object-cover" preload="metadata"></video>
                        <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center pointer-events-none">
                            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        </div>
                    </div>
                `;
            } else if (isVoiceMessage) {
                // --- REPLACEMENT START: NEW VOICE NOTE PLAYER HTML ---
                const senderData = isSender ? currentUser : allUsersData[msg.senderId];
                const senderInitials = getInitials(senderData?.username);
                const senderAvatar = senderData?.profilePicUrl || getPlaceholderUrl(senderInitials);

                messageContentHtml = `
                    <div class="flex items-center gap-2 p-2 w-64 md:w-72">
                        <img src="${senderAvatar}" class="w-8 h-8 rounded-full flex-shrink-0 object-cover" alt="avatar">
                        <button id="play-btn-${id}" class="p-2 flex-shrink-0">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2 10a8 8 0 1116 0 8 8 0 01-16 0zm6.39-2.908a.75.75 0 01.766.027l3.5 2.5a.75.75 0 010 1.262l-3.5 2.5A.75.75 0 018 12.75V7.25a.75.75 0 01.39-.658z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="waveform-container-${id}" class="relative flex-grow h-8 flex items-center cursor-pointer">
                            <div class="w-full h-1 bg-gray-400 dark:bg-gray-500 rounded-full"></div>
                            <div id="waveform-progress-${id}" class="absolute top-1/2 -translate-y-1/2 h-1 bg-white rounded-full w-0"></div>
                            <div id="waveform-scrubber-${id}" class="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full" style="left: 0%;"></div>
                        </div>
                        <span id="duration-text-${id}" class="text-xs font-mono pl-2">${formatDuration(msg.duration || 0)}</span>
                    </div>
                    <audio id="audio-player-${id}" src="${msg.audioUrl}" preload="metadata" class="hidden"></audio>
                `;
                // --- REPLACEMENT END ---
            } else if (msg.text) {
                const urls = extractUrls(msg.text);
                const linkPreviewContainerId = `link-preview-${id}`;
                const linkPreviewHtml = urls.length > 0 ? `<div id="${linkPreviewContainerId}"></div>` : '';
                const messageTextHtml = urls.length > 0 ? msg.text.replace(urls[0], `<a href="${urls[0]}" target="_blank" class="text-blue-400 underline">${urls[0]}</a>`) : msg.text;
                messageContentHtml = `<p>${messageTextHtml}</p>${linkPreviewHtml}`;
            }

            const reactionsContainerHtml = `<div class="reaction-container flex gap-1 mt-1 ${isSender ? 'justify-end' : 'justify-start'}"></div>`;
            
            const bubbleClasses = (isImageMessage || isVideoMessage) ? '' : isVoiceMessage ? (isSender ? 'bg-primary text-white' : 'bg-white dark:bg-gray-700 dark:text-white shadow-sm') : (isSender ? 'p-2 bg-primary text-white' : 'p-2 bg-white dark:bg-gray-700 dark:text-white shadow-sm');
            
            const paddingClass = isVoiceMessage ? 'p-0' : '';

            wrapper.innerHTML = `
                <div class="flex items-end ${isSender ? 'flex-row-reverse' : ''}">
                    <div class="max-w-xs lg:max-w-md">
                        <div class="rounded-2xl ${isSender ? 'rounded-br-none' : 'rounded-bl-none'} ${bubbleClasses}">
                            ${quotedContentHtml}
                            <div class="${paddingClass}">${messageContentHtml}</div>
                        </div>
                    </div>
                    ${!msg.statusReply ? `
                    <button class="action-btn reply-btn opacity-0 transition-opacity p-2 text-gray-500 dark:text-gray-400">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    </button>` : ''}
                    ${isSender ? `
                    <button class="action-btn unsend-btn opacity-0 transition-opacity p-2 text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-500" data-message-id="${id}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                    ` : ''}
                </div>
                ${reactionsContainerHtml}
                <div class="flex items-center mt-1 pr-2 space-x-2">
                     <p class="text-xs text-gray-400 dark:text-gray-500">${formatMessageTime(msg.timestamp)}</p>
                    ${readReceipt}
                </div>
            `;

            // --- ADD THIS NEW BLOCK: JAVASCRIPT FOR THE CUSTOM PLAYER ---
            if (isVoiceMessage) {
                const audio = wrapper.querySelector(`#audio-player-${id}`);
                const playBtn = wrapper.querySelector(`#play-btn-${id}`);
                const pauseIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2 10a8 8 0 1116 0 8 8 0 01-16 0zm6.39-2.908a.75.75 0 01.766.027l3.5 2.5a.75.75 0 010 1.262l-3.5 2.5A.75.75 0 018 12.75V7.25a.75.75 0 01.39-.658z" clip-rule="evenodd" /></svg>`;
                const playIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z" /></svg>`;
                const waveformContainer = wrapper.querySelector(`#waveform-container-${id}`);
                const progress = wrapper.querySelector(`#waveform-progress-${id}`);
                const scrubber = wrapper.querySelector(`#waveform-scrubber-${id}`);
                const durationText = wrapper.querySelector(`#duration-text-${id}`);

                const togglePlay = () => {
                    if (audio.paused) {
                        audio.play();
                        playBtn.innerHTML = playIcon;
                    } else {
                        audio.pause();
                        playBtn.innerHTML = pauseIcon;
                    }
                };

                playBtn.addEventListener('click', togglePlay);

                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    progress.style.width = `${percent}%`;
                    scrubber.style.left = `${percent}%`;
                });

                audio.addEventListener('ended', () => {
                    playBtn.innerHTML = pauseIcon;
                    progress.style.width = '0%';
                    scrubber.style.left = '0%';
                    audio.currentTime = 0;
                });

                audio.addEventListener('loadedmetadata', () => {
                    if (isFinite(audio.duration)) {
                        durationText.textContent = formatDuration(audio.duration);
                    }
                });

                waveformContainer.addEventListener('click', (e) => {
                    const rect = waveformContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const newTime = (clickX / rect.width) * audio.duration;
                    if (isFinite(newTime)) {
                        audio.currentTime = newTime;
                    }
                });
            }
            // --- END OF NEW BLOCK ---

            const reactionsContainer = wrapper.querySelector('.reaction-container');
            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                Object.entries(msg.reactions).forEach(([emoji, uids]) => {
                    if (uids.length > 0) {
                        const reactionChip = document.createElement('button');
                        const userHasReacted = uids.includes(currentUser.uid);
                        reactionChip.className = `reaction-chip ${userHasReacted ? 'reacted-by-me' : ''}`;
                        reactionChip.textContent = `${emoji} ${uids.length}`;
                        reactionChip.dataset.emoji = emoji;
                        reactionsContainer.appendChild(reactionChip);
                    }
                });
            }


            if (msg.text && extractUrls(msg.text).length > 0) {
                const urls = extractUrls(msg.text);
                const linkPreviewContainerId = `link-preview-${id}`;
                const previewContainer = wrapper.querySelector(`#${linkPreviewContainerId}`);
                if (previewContainer) {
                    previewContainer.innerHTML = `<div class="mt-2 p-2 flex items-center justify-center"><div class="w-4 h-4 border-2 border-t-primary border-gray-200 rounded-full animate-spin"></div></div>`;
                    
                    fetchLinkPreview(urls[0]).then(previewData => {
                        if (previewData) {
                            previewContainer.innerHTML = `
                            <a href="${previewData.url}" target="_blank" rel="noopener noreferrer" class="block mt-2 link-preview p-2 rounded-lg bg-gray-100 dark:bg-gray-600">
                                <div class="flex items-center space-x-3">
                                    <img src="${previewData.image}" class="link-preview-image rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/64x64/eee/ccc?text=N/A';">
                                    <div class="overflow-hidden">
                                        <p class="font-bold text-sm truncate text-gray-800 dark:text-gray-200">${previewData.title}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${previewData.description}</p>
                                    </div>
                                </div>
                            </a>
                            `;
                        } else {
                             previewContainer.innerHTML = `<div class="mt-2 p-2 text-xs text-gray-400">Preview not available</div>`;
                        }
                    });
                }
            }

            return wrapper;
        }

        async function markSingleMessageAsRead(messageId) {
            const readReceiptsEnabled = currentUser.settings?.readReceipts ?? true;
            if (!readReceiptsEnabled) return;

            if (!currentChatPartner || !currentUser) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const messageRef = doc(db, `chats/${chatId}/messages`, messageId);
            const chatRef = doc(db, 'chats', chatId);

            try {
                await updateDoc(messageRef, { isRead: true });
                await updateDoc(chatRef, { [`unreadCount.${currentUser.uid}`]: increment(-1) });
            } catch (error) { console.error("Error marking message as read:", error); }
        }

        messageInput.addEventListener('input', () => {
            const sendButton = messageForm.querySelector('button[type="submit"]');
            const hasText = messageInput.value.trim().length > 0;

            if (hasText) {
                sendButton.classList.remove('hidden');
                aiRewriteBtn.style.display = 'flex';
                // Hide media/voice buttons ONLY if media preview is not active
                if (selectedMediaFiles.length === 0) {
                    voiceNoteBtn.classList.add('hidden');
                    attachPhotoBtn.classList.add('hidden');
                }
            } else {
                sendButton.classList.add('hidden');
                aiRewriteBtn.style.display = 'none';
                // Show media/voice buttons ONLY if media preview is not active
                if (selectedMediaFiles.length === 0) {
                    voiceNoteBtn.classList.remove('hidden');
                    attachPhotoBtn.classList.remove('hidden');
                }
            }
            
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, true);
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { set(typingRef, false); }, 2000);
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatPartner) return;
            
            messageInput.value = '';
            // Trigger input event to reset button visibility
            messageInput.dispatchEvent(new Event('input')); 
            aiRewritePopup.classList.add('hidden');
            
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            clearTimeout(typingTimeout);
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, false);

            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                text: text,
                type: "text",
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            if (currentReply) newMessage.replyTo = currentReply;

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);

                await addDoc(messagesRef, newMessage);

                await setDoc(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    unreadCount: { [currentUser.uid]: 0, [currentChatPartner.uid]: increment(1) }
                }, { merge: true });

            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Could not send message.");
                messageInput.value = text;
            } finally {
                cancelReply();
            }
        });

        backToChatsBtn.addEventListener('click', () => {
            hidePage('chat-room-page');
            currentChatPartner = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            if (readReceiptObserver) readReceiptObserver.disconnect();
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        });
        
        // =================================================================
        // 10. MESSAGE INTERACTION LOGIC (REPLY, UNSEND, PREVIEW & REWRITE)
        // =================================================================
        messagesContainer.addEventListener('click', (e) => {
            const replyButton = e.target.closest('.reply-btn');
            const unsendButton = e.target.closest('.unsend-btn');
            const reactionChip = e.target.closest('.reaction-chip');
            const imageElement = e.target.closest('.message-photo');
            const videoElement = e.target.closest('.message-video');
            const replyBubble = e.target.closest('.reply-bubble-clickable');

            if (replyBubble) {
                const targetId = replyBubble.dataset.replyToId;
                const targetMessageElement = messagesContainer.querySelector(`[data-message-id="${targetId}"]`);
                if (targetMessageElement) {
                    targetMessageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const messageBubbleContent = targetMessageElement.querySelector('.rounded-2xl');
                    if (messageBubbleContent) {
                        messageBubbleContent.classList.add('highlight-message');
                        setTimeout(() => {
                            messageBubbleContent.classList.remove('highlight-message');
                        }, 2000);
                    }
                }
            }

            if (imageElement) {
                const imageUrl = imageElement.src;
                openMediaPreview('image', imageUrl);
            }

            if (videoElement) {
                const videoUrl = videoElement.querySelector('video').src;
                openMediaPreview('video', videoUrl);
            }

            if (replyButton) {
                const messageWrapper = replyButton.closest('.message-bubble-wrapper');
                const messageType = messageWrapper.dataset.messageType;

                if (messageType === 'image') {
                    currentReply = {
                        messageId: messageWrapper.dataset.messageId,
                        senderName: messageWrapper.dataset.messageSender,
                        imageUrl: messageWrapper.dataset.messageImageUrl,
                        type: 'image'
                    };
                } else if (messageType === 'video') {
                     currentReply = {
                        messageId: messageWrapper.dataset.messageId,
                        senderName: messageWrapper.dataset.messageSender,
                        videoUrl: messageWrapper.dataset.messageVideoUrl,
                        type: 'video'
                    };
                } else { // 'text'
                    currentReply = {
                        messageId: messageWrapper.dataset.messageId,
                        text: messageWrapper.dataset.messageText,
                        senderName: messageWrapper.dataset.messageSender,
                        type: 'text'
                    };
                }
                showReplyPreview();
            }

            if (unsendButton) {
                const messageId = unsendButton.dataset.messageId;
                if (confirm('Are you sure you want to unsend this message?')) {
                    unsendMessage(messageId);
                }
            }

            if (reactionChip) {
                const messageId = reactionChip.closest('.message-bubble-wrapper').dataset.messageId;
                const emoji = reactionChip.dataset.emoji;
                toggleEmojiReaction(messageId, emoji);
            }
        });
        
        function openMediaPreview(type, url) {
            const previewContainer = document.getElementById('preview-content-container');
            previewContainer.innerHTML = ''; // Clear previous content

            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.className = "max-w-full max-h-full object-contain";
                previewContainer.appendChild(img);
            } else if (type === 'video') {
                const video = document.createElement('video');
                video.src = url;
                video.className = "max-w-full max-h-full object-contain";
                video.controls = true;
                video.autoplay = true;
                previewContainer.appendChild(video);
            }

            downloadMediaBtn.href = url;
            const filename = url.split('/').pop().split('?')[0] || `twinkle-${type}`;
            downloadMediaBtn.setAttribute('download', filename);

            imagePreviewModal.classList.remove('hidden');
        }

        closePreviewBtn.addEventListener('click', () => {
            const modal = document.getElementById('image-preview-modal');
            modal.classList.add('hidden');
            const video = modal.querySelector('video');
            if (video) {
                video.pause(); // Stop video playback
            }
            document.getElementById('preview-content-container').innerHTML = ''; // Clear content
        });

        async function unsendMessage(messageId) {
            if (!currentChatPartner || !currentUser) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const messageRef = doc(db, `chats/${chatId}/messages/${messageId}`);
            try { await deleteDoc(messageRef); }
            catch (error) {
                console.error("Error unsending message:", error);
                alert("Could not unsend the message.");
            }
        }


        function showReplyPreview() {
            if (!currentReply) return;
            replyPreviewUsername.textContent = `Replying to ${currentReply.senderName}`;
            
            if (currentReply.type === 'image') {
                replyPreviewText.innerHTML = `<img src="${currentReply.imageUrl}" class="h-5 inline-block mr-1 rounded-sm">  Photo`;
            } else if (currentReply.type === 'video') {
                replyPreviewText.innerHTML = `<video src="${currentReply.videoUrl}" class="h-5 inline-block mr-1 rounded-sm"></video>  Video`;
            } else {
                replyPreviewText.textContent = currentReply.text;
            }

            replyPreviewContainer.classList.remove('hidden');
            messageInput.focus();
        }

        function cancelReply() {
            currentReply = null;
            replyPreviewContainer.classList.add('hidden');
        }
        cancelReplyBtn.addEventListener('click', cancelReply);

        aiRewriteBtn.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text) return;

            aiRewritePopup.classList.remove('hidden');
            rewriteSuggestionsContainer.innerHTML = '<div class="text-center text-sm text-gray-500">Generating suggestions...</div>';

            const prompt = `Analyze the following text and its language (which could be Hindi, English, or Hinglish). Provide three alternative versions in the same language. Your response MUST be a valid JSON object, and nothing else. The JSON object should have three keys: "formal", "casual", and "simple".

            Text: "${text}"`;

            try {
                let result = await callGeminiAPI([{ role: 'user', parts: [{ text: prompt }] }]);
                
                const jsonResponse = result.replace(/```json/g, '').replace(/```/g, '').trim();
                const suggestions = JSON.parse(jsonResponse);

                rewriteSuggestionsContainer.innerHTML = ''; 

                ['formal', 'casual', 'simple'].forEach(tone => {
                    if (suggestions[tone]) {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'rewrite-suggestion p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer';
                        const capitalizedTone = tone.charAt(0).toUpperCase() + tone.slice(1);
                        suggestionEl.innerHTML = `<span class="font-bold">${capitalizedTone}:</span> ${suggestions[tone]}`;
                        suggestionEl.addEventListener('click', () => {
                            messageInput.value = suggestions[tone];
                            aiRewritePopup.classList.add('hidden');
                            messageInput.focus();
                        });
                        rewriteSuggestionsContainer.appendChild(suggestionEl);
                    }
                });

            } catch (error) {
                rewriteSuggestionsContainer.textContent = "Sorry, couldn't generate suggestions.";
                console.error("AI Rewrite Error:", error);
            }
        });

        closeRewritePopupBtn.addEventListener('click', () => {
            aiRewritePopup.classList.add('hidden');
        });

        // =================================================================
        // 11. USER SEARCH LOGIC
        // =================================================================
        
        backFromSearchBtn.addEventListener('click', () => hidePage('search-users-page'));

        userSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Keep typing to search...</p>';
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, 
                    where("username_lowercase", ">=", searchTerm),
                    where("username_lowercase", "<=", searchTerm + '\uf8ff'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const users = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) users.push(doc.data());
                });
                renderUserSearchResults(users);
            } catch (error) {
                console.error("Error searching users:", error);
                userSearchResults.innerHTML = '<p class="text-red-500 text-center mt-4">Error searching for users. Ensure database indexes are configured.</p>';
            }
        });

        function renderUserSearchResults(users) {
            if (users.length === 0) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">No users found.</p>';
                return;
            }
            userSearchResults.innerHTML = users.map(user => {
                const isOnline = user.status?.state === 'online';
                const initials = getInitials(user.username);
                const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);
                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition user-search-item" data-user-id="${user.uid}" data-user-name="${user.username}" data-user-pic="${user.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${user.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${user.email}</p>
                    </div>
                </div>
            `}).join('');
        }

        userSearchResults.addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-search-item');
            if (userItem) {
                hidePage('search-users-page');
                openChatRoom({
                    uid: userItem.dataset.userId,
                    username: userItem.dataset.userName,
                    profilePicUrl: userItem.dataset.userPic
                });
            }
        });

        // =================================================================
        // 12. PROFILE & BIO LOGIC
        // =================================================================
        settingsProfileLink.addEventListener('click', () => {
            showPage('profile-edit-page', true);
        });

        backFromProfileEditBtn.addEventListener('click', () => {
            hidePage('profile-edit-page');
        });

        privacySettingsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('privacy-settings-page', true);
        });

        backFromPrivacyBtn.addEventListener('click', () => {
            hidePage('privacy-settings-page');
        });

        profilePicContainer.addEventListener('click', () => profilePicInput.click());

        profilePicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                cropModal.classList.remove('hidden');
                if (croppieInstance) {
                    croppieInstance.destroy();
                }
                croppieInstance = new Croppie(cropContainer, {
                    viewport: { width: 200, height: 200, type: 'circle' },
                    boundary: { width: 250, height: 250 },
                    enableExif: true
                });
                croppieInstance.bind({
                    url: event.target.result
                });
            };
            reader.readAsDataURL(file);
        });
        
        cancelCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            if (croppieInstance) {
                croppieInstance.destroy();
                croppieInstance = null;
            }
            profilePicInput.value = ''; // Reset file input
        });

        saveCropBtn.addEventListener('click', async () => {
            if (!croppieInstance) return;

            saveCropBtn.disabled = true;
            saveCropBtn.textContent = 'Saving...';

            try {
                const blob = await croppieInstance.result({ type: 'blob', size: 'viewport', format: 'png', quality: 0.9 });

                const CLOUD_NAME = "dzuyq67ql";
                const UPLOAD_PRESET = "twinkle_profiles";
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', UPLOAD_PRESET);

                showToast('Uploading...', 'info');

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload to Cloudinary failed.');
                
                const data = await response.json();
                const photoURL = data.secure_url;
                if (!photoURL) throw new Error('Cloudinary did not return a URL.');

                await updateDoc(doc(db, 'users', currentUser.uid), { profilePicUrl: photoURL });
                currentUser.profilePicUrl = photoURL;
                
                profilePicDisplay.src = photoURL;
                settingsProfilePic.src = photoURL;
                myStatusPic.src = photoURL;
                
                showToast('Upload complete!', 'success');

            } catch (error) {
                console.error("Upload failed:", error);
                showToast('Upload failed!', 'error');
            } finally {
                cancelCropBtn.click();
                saveCropBtn.disabled = false;
                saveCropBtn.textContent = 'Crop & Save';
            }
        });
        
        editUsernameBtn.addEventListener('click', () => {
            usernameDisplayContainer.classList.add('hidden');
            usernameInputContainer.classList.remove('hidden');
            usernameInput.value = currentUser.username;
            usernameInput.focus();
        });

        cancelUsernameBtn.addEventListener('click', () => {
            usernameInputContainer.classList.add('hidden');
            usernameDisplayContainer.classList.remove('hidden');
        });

        saveUsernameBtn.addEventListener('click', async () => {
            const newUsername = usernameInput.value.trim();
            const oldUsername = currentUser.username;

            if (newUsername.length < 3) return alert("Username must be at least 3 characters.");
            if (newUsername === oldUsername) {
                usernameInputContainer.classList.add('hidden');
                usernameDisplayContainer.classList.remove('hidden');
                return;
            }

            saveUsernameBtn.disabled = true;
            saveUsernameBtn.textContent = 'Saving...';

            try {
                const newUsernameLower = newUsername.toLowerCase();
                const usernameRef = doc(db, "usernames", newUsernameLower);
                const usernameDoc = await getDoc(usernameRef);

                if (usernameDoc.exists()) throw new Error("Username is already taken.");

                const batch = writeBatch(db);
                const oldUsernameRef = doc(db, "usernames", oldUsername.toLowerCase());
                batch.delete(oldUsernameRef);
                batch.set(doc(db, "usernames", newUsernameLower), { uid: currentUser.uid });
                const userRef = doc(db, "users", currentUser.uid);
                batch.update(userRef, { username: newUsername, username_lowercase: newUsernameLower });
                await batch.commit();

                currentUser.username = newUsername;
                profileUsername.textContent = newUsername;
                settingsProfileUsername.textContent = newUsername;
                alert("Username updated successfully!");

            } catch (error) {
                console.error("Error updating username:", error);
                alert("Failed to update username: " + error.message);
            } finally {
                usernameInputContainer.classList.add('hidden');
                usernameDisplayContainer.classList.remove('hidden');
                saveUsernameBtn.disabled = false;
                saveUsernameBtn.textContent = 'Save';
            }
        });


        editBioBtn.addEventListener('click', () => {
            bioText.classList.add('hidden');
            editBioBtn.classList.add('hidden');
            bioInput.classList.remove('hidden');
            saveBioBtn.classList.remove('hidden');
            bioInput.value = currentUser.bio || '';
            bioInput.focus();
        });

        saveBioBtn.addEventListener('click', async () => {
            const newBio = bioInput.value.trim();
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { bio: newBio });
                currentUser.bio = newBio;
                bioText.textContent = newBio || 'This is your bio. Click edit to change it.';
                settingsProfileBio.textContent = newBio || 'This is your bio. Click to edit it.';
            } catch (error) {
                console.error("Failed to save bio:", error);
                alert("Could not save bio.");
            } finally {
                bioText.classList.remove('hidden');
                editBioBtn.classList.remove('hidden');
                bioInput.classList.add('hidden');
                saveBioBtn.classList.add('hidden');
            }
        });
        
        chatRoomHeaderClickable.addEventListener('click', () => {
            if (!currentChatPartner) return;
            
            // If partner has a status, view it. Otherwise, view profile.
            const partnerStatuses = (allStatusesData[currentChatPartner.uid] || []).filter(s => s.expiresAt.toMillis() > Date.now());
            if (partnerStatuses.length > 0) {
                 openStatusViewer(currentChatPartner.uid);
                 return;
            }

            const initials = getInitials(currentChatPartner.username);
            partnerProfilePic.src = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);
            partnerProfileUsername.textContent = currentChatPartner.username;
            partnerProfileBio.textContent = currentChatPartner.bio || 'No bio available.';
            
            showPage('partner-profile-page', true);
        });

        backFromPartnerProfileBtn.addEventListener('click', () => {
            hidePage('partner-profile-page');
        });


        // =================================================================
        // 13. SETTINGS & THEME SWITCHER LOGIC
        // =================================================================
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleSlider.classList.add('dark:translate-x-6');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleSlider.classList.remove('dark:translate-x-6');
            }
            localStorage.setItem('theme', theme);
            const activeNav = document.querySelector('.nav-btn.border-t-2');
            if (activeNav) updateNavButtons(activeNav.dataset.page);
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            applyTheme(isDarkMode ? 'light' : 'dark');
        });

        function updateReadReceiptsToggleUI(isEnabled) {
            if (isEnabled) {
                readReceiptsToggleSlider.classList.add('dark:translate-x-6', 'translate-x-6');
                readReceiptsToggle.classList.add('bg-primary');
                readReceiptsToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
            } else {
                readReceiptsToggleSlider.classList.remove('dark:translate-x-6', 'translate-x-6');
                readReceiptsToggle.classList.remove('bg-primary');
                readReceiptsToggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
            }
        }

        readReceiptsToggle.addEventListener('click', async () => {
            const newSetting = !(currentUser.settings?.readReceipts ?? true);
            updateReadReceiptsToggleUI(newSetting);

            try {
                 if (!currentUser.settings) currentUser.settings = {};
                 currentUser.settings.readReceipts = newSetting;
                await updateDoc(doc(db, 'users', currentUser.uid), { 'settings.readReceipts': newSetting });
            } catch (error) {
                console.error("Failed to update read receipts setting:", error);
                updateReadReceiptsToggleUI(!newSetting);
                 currentUser.settings.readReceipts = !newSetting;
                alert("Could not save your setting. Please try again.");
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        function applyChatTheme(themeName) {
            const allThemes = ['theme-doodle', 'theme-geometric', 'theme-cosmic', 'theme-leaves', 'theme-waves', 'theme-sunset', 'theme-default', 'theme-minty', 'theme-amethyst', 'theme-sunrise', 'theme-cyber', 'theme-arctic', 'theme-peach'];
            
            if (messagesContainer) {
                messagesContainer.classList.remove(...allThemes);
                if (themeName && themeName !== 'theme-default') {
                    messagesContainer.classList.add(themeName);
                }
            }

            if (currentThemePreview) {
                currentThemePreview.style.backgroundImage = '';
                currentThemePreview.style.backgroundColor = '';
                currentThemePreview.className = 'w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600';
                
                if (themeName && themeName !== 'theme-default') {
                    currentThemePreview.classList.add(themeName);
                } else {
                    currentThemePreview.classList.add('bg-gray-100', 'dark:bg-gray-900');
                }
            }
        }

        function updateThemeSelectionUI(activeTheme) {
            themePreviewItems.forEach(item => {
                const div = item.querySelector('div');
                if (item.dataset.theme === activeTheme) {
                    div.classList.add('border-primary');
                } else {
                    div.classList.remove('border-primary');
                }
            });
        }

        async function saveAndApplyChatTheme(themeName) {
            applyChatTheme(themeName);
            updateThemeSelectionUI(themeName);

            try {
                if (!currentUser.settings) currentUser.settings = {};
                currentUser.settings.chatTheme = themeName;
                await updateDoc(doc(db, 'users', currentUser.uid), { 'settings.chatTheme': themeName });
            } catch (error) {
                console.error("Failed to save chat theme:", error);
                alert("Could not save your theme setting.");
            }
        }

        themePreviewItems.forEach(item => {
            item.addEventListener('click', () => saveAndApplyChatTheme(item.dataset.theme));
        });


        // =================================================================
        // 14. AI & GEMINI LOGIC
        // =================================================================
        async function callGeminiAPI(history) {
            const apiKey = "AIzaSyAE9qqHiA_FrTzj-3pkTtS52tH1u53jAhQ"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const payload = { 
                contents: history,
                systemInstruction: { parts: [{ text: "You are a helpful assistant integrated into the Twinkle chat app. Your name is Gemini. Always provide responses in plain text without using any Markdown formatting (like **bold** or *italics*)." }] }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 console.error("API Error:", errorData);
                 throw new Error(`API request failed with status ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                if(result.promptFeedback?.blockReason) {
                     throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
                }
                throw new Error("Invalid response structure from Gemini API.");
            }
        }

        backFromGeminiBtn.addEventListener('click', () => hidePage('gemini-page'));

        function renderGeminiMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            const isGemini = sender === 'gemini';
            
            messageWrapper.className = `flex flex-col ${isGemini ? 'items-start' : 'items-end'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isGemini ? 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm' : 'bg-primary text-white rounded-br-none'}`;
            messageBubble.textContent = text;
            
            if (isGemini) {
                const label = document.createElement('span');
                label.className = 'text-xs text-gray-500 dark:text-gray-400 ml-2 mb-1';
                label.textContent = ' Gemini';
                messageWrapper.appendChild(label);
            }
            
            messageWrapper.appendChild(messageBubble);
            geminiMessagesContainer.appendChild(messageWrapper);
            geminiMessagesContainer.scrollTop = geminiMessagesContainer.scrollHeight;
        }

        geminiMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = geminiMessageInput.value.trim();
            if (!userText) return;

            geminiMessageInput.value = '';
            renderGeminiMessage(userText, 'user');
            geminiChatHistory.push({ role: 'user', parts: [{ text: userText }] });

            geminiTypingIndicator.innerHTML = `
                <div class="flex items-center space-x-2 animate-fade-in">
                    <div class="px-4 py-3 rounded-2xl bg-gray-200 dark:bg-gray-700">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>
                </div>`;

            try {
                const geminiResponse = await callGeminiAPI(geminiChatHistory);
                renderGeminiMessage(geminiResponse, 'gemini');
                geminiChatHistory.push({ role: 'model', parts: [{ text: geminiResponse }] });
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                renderGeminiMessage("Sorry, I couldn't get a response. Please check the console for errors.", 'gemini');
            } finally {
                geminiTypingIndicator.innerHTML = '';
            }
        });

        
        // =================================================================
        // 15. DELETE CHAT & FAVORITE CHAT
        // =================================================================
        chatSettingsBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.toggle('hidden');
        });

        deleteChatBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.add('hidden');
            deleteChatModal.classList.remove('hidden');
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteChatModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            try {
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const messagesSnapshot = await getDocs(messagesRef);
                const batch = writeBatch(db);
                messagesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                await deleteDoc(doc(db, 'chats', chatId));
                
                hidePage('chat-room-page');
                showPage('chats-page');

            } catch (error) {
                console.error("Error deleting chat:", error);
                alert("Could not delete chat. Please try again.");
            } finally {
                deleteChatModal.classList.add('hidden');
            }
        });
        
        async function toggleFavoriteStatus() {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const chatRef = doc(db, 'chats', chatId);

            const chatData = allChatsData.find(chat => chat.id === chatId);
            const isCurrentlyFavorite = chatData?.favoritedBy?.includes(currentUser.uid);

            try {
                if (isCurrentlyFavorite) {
                    await updateDoc(chatRef, {
                        favoritedBy: arrayRemove(currentUser.uid)
                    });
                    showToast('Removed from favorites', 'info');
                } else {
                    await updateDoc(chatRef, {
                        favoritedBy: arrayUnion(currentUser.uid)
                    });
                    showToast('Added to favorites', 'success');
                }
            } catch (error) {
                console.error("Error updating favorite status:", error);
                showToast('Could not update favorite status', 'error');
            }
        }

        favoriteChatBtn.addEventListener('click', (e) => {
            e.preventDefault();
            chatSettingsMenu.classList.add('hidden'); // Hide menu after clicking
            toggleFavoriteStatus();
        });


        document.addEventListener('click', (e) => {
            if (!chatSettingsBtn.contains(e.target) && !chatSettingsMenu.contains(e.target)) {
                chatSettingsMenu.classList.add('hidden');
            }
        });

        // =================================================================
        // 16. PHOTO & VIDEO MESSAGING LOGIC (WITH MULTI-UPLOAD & PREVIEW)
        // =================================================================
        
        attachPhotoBtn.addEventListener('click', () => {
            photoInput.click();
        });

        photoInput.addEventListener('change', (e) => {
            // Add all selected files to the global array
            if (e.target.files.length > 0) {
                 selectedMediaFiles.push(...Array.from(e.target.files));
                 renderMediaPreview();
            }
            // Reset the input value to allow selecting the same file again
            e.target.value = '';
        });

        function renderMediaPreview() {
            thumbnailList.innerHTML = '';

            if (selectedMediaFiles.length === 0) {
                mediaPreviewContainer.classList.add('hidden');
                // Restore original buttons if there's no text in the input
                if (messageInput.value.trim() === '') {
                    attachPhotoBtn.classList.remove('hidden');
                    voiceNoteBtn.classList.remove('hidden');
                }
                return;
            }

            mediaPreviewContainer.classList.remove('hidden');
            attachPhotoBtn.classList.add('hidden');
            voiceNoteBtn.classList.add('hidden');

            selectedMediaFiles.forEach((file, index) => {
                const thumbWrapper = document.createElement('div');
                thumbWrapper.className = 'thumbnail-item';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-thumbnail-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedMediaFiles.splice(index, 1);
                    renderMediaPreview(); // Re-render the preview list
                };
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    let mediaElement;
                    if (file.type.startsWith('image/')) {
                        mediaElement = document.createElement('img');
                    } else if (file.type.startsWith('video/')) {
                        mediaElement = document.createElement('video');
                        mediaElement.muted = true;
                        mediaElement.playsInline = true;
                    }
                    if (mediaElement) {
                        mediaElement.src = event.target.result;
                        thumbWrapper.appendChild(mediaElement);
                    }
                };
                reader.readAsDataURL(file);

                thumbWrapper.appendChild(removeBtn);
                thumbnailList.appendChild(thumbWrapper);
            });
        }
        
        sendMediaBtn.addEventListener('click', () => {
            // Create a copy of the array to send, so we can clear the UI immediately
            const filesToSend = [...selectedMediaFiles];
            
            // Clear the global array and hide the preview UI
            selectedMediaFiles = [];
            renderMediaPreview();

            // Loop through the copied array and upload each file
            filesToSend.forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadImageAndSendMessage(file);
                } else if (file.type.startsWith('video/')) {
                    uploadVideoAndSendMessage(file);
                } else {
                    showToast(`Unsupported file type: ${file.name}`, 'error');
                }
            });
        });


        async function uploadImageAndSendMessage(file) {
            if (!currentChatPartner) return;

            const tempId = `upload-${Date.now()}`;
            
            const placeholder = document.createElement('div');
            placeholder.id = tempId;
            placeholder.className = 'flex flex-col message-bubble-wrapper items-end';
            placeholder.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="px-4 py-2 rounded-2xl bg-primary text-white rounded-br-none opacity-70">
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin"></div>
                            <span>Uploading...</span>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(placeholder);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const CLOUD_NAME = "dzuyq67ql"; 
                const UPLOAD_PRESET = "twinkle_profiles";
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed.');

                const data = await response.json();
                const imageUrl = data.secure_url;
                if (!imageUrl) throw new Error('Cloudinary did not return a URL.');

                await sendImageMessage(imageUrl);

            } catch (error) {
                console.error("Image Upload Error:", error);
                const placeholderContent = placeholder.querySelector('span');
                if(placeholderContent) {
                    placeholderContent.textContent = 'Upload failed!';
                    placeholder.querySelector('div div').classList.add('bg-red-500');
                }
                setTimeout(() => placeholder.remove(), 4000);
            } finally {
                photoInput.value = '';
                placeholder.remove();
            }
        }

        async function sendImageMessage(imageUrl) {
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                type: "image",
                imageUrl: imageUrl,
                text: null,
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                await addDoc(messagesRef, newMessage);

                await setDoc(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: " Photo",
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    unreadCount: { [currentUser.uid]: 0, [currentChatPartner.uid]: increment(1) }
                }, { merge: true });

            } catch (error) {
                console.error("Error sending image message: ", error);
                alert("Could not send photo.");
            }
        }

        async function uploadVideoAndSendMessage(file) {
            if (!currentChatPartner) return;

            const tempId = `upload-${Date.now()}`;
            
            const placeholder = document.createElement('div');
            placeholder.id = tempId;
            placeholder.className = 'flex flex-col message-bubble-wrapper items-end';
            placeholder.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="px-4 py-2 rounded-2xl bg-primary text-white rounded-br-none opacity-70">
                        <div class="flex items-center space-x-2">
                            <div class="w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin"></div>
                            <span>Uploading video...</span>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(placeholder);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const CLOUD_NAME = "dzuyq67ql"; 
                const UPLOAD_PRESET = "twinkle_profiles";
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed.');

                const data = await response.json();
                const videoUrl = data.secure_url;
                const videoMetadata = {
                    duration: data.duration,
                    width: data.width,
                    height: data.height
                };

                if (!videoUrl) throw new Error('Cloudinary did not return a URL.');

                await sendVideoMessage(videoUrl, videoMetadata);

            } catch (error) {
                console.error("Video Upload Error:", error);
                const placeholderContent = placeholder.querySelector('span');
                if(placeholderContent) {
                    placeholderContent.textContent = 'Upload failed!';
                    placeholder.querySelector('div div').classList.add('bg-red-500');
                }
                setTimeout(() => placeholder.remove(), 4000);
            } finally {
                photoInput.value = '';
                placeholder.remove();
            }
        }

        async function sendVideoMessage(videoUrl, metadata) {
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                type: "video",
                videoUrl: videoUrl,
                metadata: metadata,
                text: null,
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                await addDoc(messagesRef, newMessage);

                await setDoc(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: " Video",
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    unreadCount: { [currentUser.uid]: 0, [currentChatPartner.uid]: increment(1) }
                }, { merge: true });

            } catch (error) {
                console.error("Error sending video message: ", error);
                alert("Could not send video.");
            }
        }


       // =================================================================
        // 17. STATUS FEATURE LOGIC
        // =================================================================
        myStatusSection.addEventListener('click', () => {
            const myStatuses = (allStatusesData[currentUser.uid] || []).filter(s => s.expiresAt.toMillis() > Date.now());
            if (myStatuses.length > 0) {
                 openStatusViewer(currentUser.uid);
            } else {
                 statusFileInput.click();
            }
        });
        
        addStatusBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            statusFileInput.click();
        });


        statusFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusUploadError.textContent = '';
            const fileType = file.type.split('/')[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                statusUploadPreview.innerHTML = '';
                if (fileType === 'image') {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    statusUploadPreview.appendChild(img);
                } else if (fileType === 'video') {
                    const video = document.createElement('video');
                    video.src = event.target.result;
                    video.controls = false;
                    video.autoplay = true;
                    video.muted = true;
                    video.loop = true;
                    statusUploadPreview.appendChild(video);
                }
                uploadStatusModal.classList.remove('hidden');
            };

            reader.readAsDataURL(file);
        });

        cancelStatusUploadBtn.addEventListener('click', () => {
            uploadStatusModal.classList.add('hidden');
            statusFileInput.value = '';
            statusCaptionInput.value = '';
            statusUploadPreview.innerHTML = '';
        });

        confirmStatusUploadBtn.addEventListener('click', async () => {
            const file = statusFileInput.files[0];
            const caption = statusCaptionInput.value.trim();
            if (!file) return;

            showToast('Uploading status...', 'info');
            uploadStatusModal.classList.add('hidden');

            try {
                const CLOUD_NAME = "dzuyq67ql";
                const UPLOAD_PRESET = "twinkle_profiles";
                const mediaType = file.type.startsWith('video') ? 'video' : 'image';
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${mediaType}/upload`;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                if (mediaType === 'video') {
                     formData.append('eager', 'du_40,q_auto:good'); 
                }

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed.');

                const data = await response.json();
                const mediaUrl = mediaType === 'video' ? data.eager[0].secure_url : data.secure_url;

                if (!mediaUrl) throw new Error('Cloudinary did not return a valid URL.');

                await saveStatusToFirestore(mediaUrl, mediaType, caption);
                showToast('Status uploaded successfully!', 'success');
                
            } catch (error) {
                console.error("Status Upload Error:", error);
                showToast('Upload failed. Please try again.', 'error');
            } finally {
                statusFileInput.value = '';
                statusCaptionInput.value = '';
                statusUploadPreview.innerHTML = '';
                confirmStatusUploadBtn.disabled = false;
                confirmStatusUploadBtn.textContent = 'Upload';
            }
        });

        async function saveStatusToFirestore(mediaUrl, mediaType, caption) {
            const statusRef = doc(collection(db, `statuses/${currentUser.uid}/items`));
            const now = Timestamp.now();
            const expiresAt = new Timestamp(now.seconds + 24 * 60 * 60, now.nanoseconds); // 24 hours from now

            await setDoc(statusRef, {
                uid: currentUser.uid,
                mediaUrl,
                mediaType,
                caption,
                createdAt: now,
                expiresAt,
                seenBy: [],
                likes: []
            });
            await setDoc(doc(db, 'statuses', currentUser.uid), { lastUpdated: now }, { merge: true });
        }
        
        async function renderStatusList() {
             if (!currentUser) return;

             const myStatuses = (allStatusesData[currentUser.uid] || []).filter(s => s.expiresAt.toMillis() > Date.now());

             if (myStatuses.length > 0) {
                 myStatusSubtitle.textContent = timeAgo(myStatuses[myStatuses.length - 1].createdAt);
                 const hasUnseen = myStatuses.some(s => !(s.seenBy || []).includes(currentUser.uid));
                 myStatusSection.querySelector('div').className = hasUnseen ? 'relative status-ring' : 'relative status-ring-seen';
             } else {
                 myStatusSubtitle.textContent = 'Tap to add a new status';
                 myStatusSection.querySelector('div').className = 'relative';
             }

             const partnerIds = [...new Set(allChatsData.map(chat => chat.participants.find(id => id !== currentUser.uid)).filter(Boolean))];
             
             const statusesHtml = partnerIds.map(uid => {
                 const user = allUsersData[uid];
                 if (!user) return '';
                 const userStatuses = (allStatusesData[uid] || []).filter(s => s.expiresAt.toMillis() > Date.now());
                 if (userStatuses.length === 0) return '';
                 
                 userStatuses.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());

                 const hasUnseen = userStatuses.some(s => !(s.seenBy || []).includes(currentUser.uid));
                 const ringClass = hasUnseen ? 'status-ring' : 'status-ring-seen';
                 const lastStatusTime = timeAgo(userStatuses[userStatuses.length - 1].createdAt);
                 const initials = getInitials(user.username);
                 const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);

                 return `
                    <div class="flex items-center space-x-4 p-3 bg-white dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition status-item" data-uid="${uid}">
                        <div class="${ringClass}">
                           <img src="${profilePicUrl}" class="w-14 h-14 rounded-full object-cover bg-white dark:bg-gray-800 p-0.5" alt="${user.username}'s Profile">
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-900 dark:text-white">${user.username}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${lastStatusTime}</p>
                        </div>
                    </div>
                 `;

             }).join('');
             
             statusList.innerHTML = statusesHtml || `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">No recent updates from your contacts.</p>`;
        }
        
        statusList.addEventListener('click', (e) => {
            const statusItem = e.target.closest('.status-item');
            if (statusItem) {
                openStatusViewer(statusItem.dataset.uid);
            }
        });
        
        function openStatusViewer(uid) {
             const user = allUsersData[uid] || (uid === currentUser.uid ? currentUser : null);
             if (!user) return;
             
             let statuses = (allStatusesData[uid] || []).sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());

             if (statuses.length === 0) {
                console.log(`No statuses found in cache for user ${uid}.`);
                return;
             }

             let currentIndex = 0;
             if(uid !== currentUser.uid) {
                const unseenIndex = statuses.findIndex(s => !(s.seenBy || []).includes(currentUser.uid));
                if (unseenIndex !== -1) currentIndex = unseenIndex;
             }

            let animationFrameId;
            let timerState = {
                startTime: 0,
                duration: 7000,
                elapsed: 0,
                isPaused: false
            };

            const pauseTimer = () => {
                if (timerState.isPaused) return;
                timerState.isPaused = true;
                cancelAnimationFrame(animationFrameId);
                timerState.elapsed = Date.now() - timerState.startTime;
                const progressFill = document.getElementById(`progress-fill-${currentIndex}`);
                if(progressFill) progressFill.style.transition = 'none';
            };

            const resumeTimer = () => {
                if (!timerState.isPaused) return;
                timerState.isPaused = false;
                timerState.startTime = Date.now() - timerState.elapsed;
                const progressFill = document.getElementById(`progress-fill-${currentIndex}`);
                if(progressFill) progressFill.style.transition = 'width 0.1s linear';
                animationFrameId = requestAnimationFrame(animateProgressBar);
            };

            const animateProgressBar = () => {
                if (timerState.isPaused) return;
                const currentTime = Date.now();
                const currentElapsed = currentTime - timerState.startTime;
                const progress = Math.min(currentElapsed / timerState.duration, 1);
                
                const progressFill = document.getElementById(`progress-fill-${currentIndex}`);
                if (progressFill) {
                    progressFill.style.width = `${progress * 100}%`;
                }

                if (currentElapsed < timerState.duration) {
                    animationFrameId = requestAnimationFrame(animateProgressBar);
                } else {
                    showStatus(currentIndex + 1);
                }
            };

            const startProgressBar = (duration) => {
                timerState = { startTime: Date.now(), duration, elapsed: 0, isPaused: false };
                const progressFill = document.getElementById(`progress-fill-${currentIndex}`);
                if (progressFill) progressFill.style.width = '0%';
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(animateProgressBar);
            };
            
            statusViewerModal.classList.remove('hidden');
            
            statusProgressBars.innerHTML = statuses.map((s, i) => `
                <div class="progress-bar-segment">
                    <div id="progress-fill-${i}" class="progress-bar-fill"></div>
                </div>
            `).join('');

             function showStatus(index) {
                if (index >= statuses.length) {
                    closeStatusViewer();
                    return;
                }
                currentIndex = index;

                if (unsubscribeStatusItem) unsubscribeStatusItem();
                cancelAnimationFrame(animationFrameId);

                const status = statuses[index];
                currentViewingStatus = { ...status, ownerUid: uid };
                
                if (uid === currentUser.uid) {
                    deleteStatusBtn.classList.remove('hidden');
                    const statusItemRef = doc(db, `statuses/${uid}/items`, status.id);
                    unsubscribeStatusItem = onSnapshot(statusItemRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const updatedStatusData = { id: docSnap.id, ...docSnap.data() };
                            currentViewingStatus = { ...updatedStatusData, ownerUid: uid };
                            updateStatusViewerFooter(uid, updatedStatusData);
                        } else {
                            showToast("This status was deleted.", "info");
                            closeStatusViewer();
                        }
                    });
                } else {
                    deleteStatusBtn.classList.add('hidden');
                }

                const initials = getInitials(user.username);
                statusViewerPic.src = user.profilePicUrl || getPlaceholderUrl(initials);
                statusViewerUsername.textContent = user.username;
                statusViewerTime.textContent = timeAgo(status.createdAt);
                
                const allProgressFills = statusProgressBars.querySelectorAll('.progress-bar-fill');
                allProgressFills.forEach((fill, i) => {
                    if (i < currentIndex) {
                        fill.style.width = '100%';
                    } else {
                        fill.style.width = '0%';
                    }
                });
                
                statusViewerContent.innerHTML = `<div class="animate-spin w-10 h-10 border-4 border-t-transparent border-white rounded-full"></div>`;
                
                let mediaElement;
                if (status.mediaType === 'image') {
                    mediaElement = document.createElement('img');
                    mediaElement.src = status.mediaUrl;
                } else if (status.mediaType === 'video') {
                    mediaElement = document.createElement('video');
                    mediaElement.src = status.mediaUrl;
                    mediaElement.autoplay = true;
                    mediaElement.playsInline = true;
                    mediaElement.muted = true;
                }

                const onMediaLoaded = () => {
                    statusViewerContent.innerHTML = '';
                    statusViewerContent.appendChild(mediaElement);
                    startProgressBar(status.mediaType === 'video' ? (mediaElement.duration * 1000) : 7000);
                }

                if(status.mediaType === 'image') mediaElement.onload = onMediaLoaded;
                if(status.mediaType === 'video') mediaElement.onloadeddata = onMediaLoaded;

                statusViewerCaption.textContent = status.caption || '';
                updateStatusViewerFooter(uid, status);
                
                if (uid !== currentUser.uid && !(status.seenBy || []).includes(currentUser.uid)) {
                    const statusRef = doc(db, `statuses/${uid}/items`, status.id);
                    updateDoc(statusRef, { seenBy: arrayUnion(currentUser.uid) });
                }
             }

            nextStatusBtn.onclick = () => showStatus(currentIndex + 1);
            prevStatusBtn.onclick = () => { if (currentIndex > 0) showStatus(currentIndex - 1); };
            
            statusViewerContent.onmousedown = pauseTimer;
            statusViewerContent.onmouseup = resumeTimer;
            statusViewerContent.ontouchstart = pauseTimer;
            statusViewerContent.ontouchend = resumeTimer;
             
             showStatus(currentIndex);
        }

        deleteStatusBtn.addEventListener('click', async () => {
            const { id, ownerUid } = currentViewingStatus;
            if (!id || ownerUid !== currentUser.uid) return;

            if (confirm("Are you sure you want to delete this status?")) {
                try {
                    const statusItemRef = doc(db, `statuses/${ownerUid}/items`, id);
                    await deleteDoc(statusItemRef);
                    
                    const statusIndex = allStatusesData[ownerUid].findIndex(s => s.id === id);
                    if (statusIndex > -1) {
                        allStatusesData[ownerUid].splice(statusIndex, 1);
                    }
                    
                    showToast("Status deleted.", "success");
                    closeStatusViewer();
                } catch (error) {
                    console.error("Error deleting status:", error);
                    showToast("Could not delete status.", "error");
                }
            }
        });

        function updateStatusViewerFooter(ownerUid, statusData) {
    if (ownerUid === currentUser.uid) {
        const views = statusData.seenBy?.length || 0;
        const likes = statusData.likes?.length || 0;
        statusViewerFooter.innerHTML = `
            <button id="viewers-btn" class="flex items-center justify-center gap-4 text-white font-semibold w-full bg-black/30 p-2 rounded-full">
                <span class="flex items-center gap-1">
                    <span class="text-xl"></span>
                    ${views}
                </span>
                <span class="flex items-center gap-1">
                    <span class="text-xl"></span>
                    ${likes}
                </span>
            </button>
        `;
        document.getElementById('viewers-btn').addEventListener('click', () => openStatusViewersList(statusData));
    } else {
                 const isLiked = (statusData.likes || []).includes(currentUser.uid);
                statusViewerFooter.innerHTML = `
                    <div class="flex items-center gap-2">
                        <form id="status-reply-form" class="flex-1">
                           <input id="status-reply-input" type="text" placeholder="Reply..." autocomplete="off" class="w-full px-4 py-2 border-0 rounded-full bg-black/30 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-white">
                        </form>
                        <button id="like-status-btn" class="p-2 text-white">
                            <svg class="w-7 h-7 ${isLiked ? 'liked' : ''}" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        </button>
                    </div>
                `;
                const replyInput = document.getElementById('status-reply-input');
                replyInput.onfocus = () => document.dispatchEvent(new Event('pauseStatus'));
                replyInput.onblur = () => document.dispatchEvent(new Event('resumeStatus'));

                document.getElementById('like-status-btn').addEventListener('click', handleStatusLike);
                document.getElementById('status-reply-form').addEventListener('submit', handleStatusReply);
            }
        }
        
        async function handleStatusLike() {
             const { id, ownerUid, likes = [] } = currentViewingStatus;
             const statusRef = doc(db, `statuses/${ownerUid}/items`, id);
             const isLiked = likes.includes(currentUser.uid);
             const button = document.getElementById('like-status-btn').querySelector('svg');

             if (isLiked) {
                 await updateDoc(statusRef, { likes: arrayRemove(currentUser.uid) });
                 button.classList.remove('liked');
                 button.setAttribute('fill', 'none');
             } else {
                 await updateDoc(statusRef, { likes: arrayUnion(currentUser.uid) });
                 button.classList.add('liked');
                 button.setAttribute('fill', 'currentColor');
             }
        }
        
        async function handleStatusReply(e) {
            e.preventDefault();
            const replyInput = document.getElementById('status-reply-input');
            const text = replyInput.value.trim();
            if (!text) return;
            
            const { mediaUrl, mediaType, ownerUid } = currentViewingStatus;
            const statusOwner = allUsersData[ownerUid];
            if (!statusOwner) return;

            const chatId = [currentUser.uid, ownerUid].sort().join('_');
            const newMessage = {
                senderId: currentUser.uid,
                receiverId: ownerUid,
                text: text,
                type: "text",
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {},
                statusReply: {
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    originalSenderName: statusOwner.username
                }
            };

            const chatRef = doc(db, "chats", chatId);
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            await addDoc(messagesRef, newMessage);
            await setDoc(chatRef, {
                participants: [currentUser.uid, ownerUid],
                lastMessage: `Replied to status: ${text}`,
                lastMessageTimestamp: serverTimestamp(),
                lastSenderId: currentUser.uid,
                unreadCount: { [currentUser.uid]: 0, [ownerUid]: increment(1) }
            }, { merge: true });

            replyInput.value = '';
            replyInput.placeholder = 'Replied!';
            setTimeout(() => { replyInput.placeholder = 'Reply...'; }, 2000);
        }

        async function openStatusViewersList(statusData) {
            statusViewersList.innerHTML = '<div class="text-center"><div class="animate-spin w-6 h-6 border-2 border-t-primary rounded-full mx-auto"></div></div>';
            statusViewersModal.classList.remove('hidden');

            const viewerIds = statusData.seenBy || [];
            const likerIds = statusData.likes || [];
            const allUserIds = [...new Set([...viewerIds, ...likerIds])];
            
            if(allUserIds.length === 0) {
                 statusViewersList.innerHTML = '<p class="text-gray-500 text-center">No one has seen this status yet.</p>';
                 return;
            }

            const viewersHtml = allUserIds.map(uid => {
                const user = allUsersData[uid];
                if (!user) return '';
                const hasLiked = likerIds.includes(uid);
                const initials = getInitials(user.username);
                const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);
                return `
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-3">
                            <img src="${profilePicUrl}" class="w-10 h-10 rounded-full object-cover">
                            <span class="font-semibold text-gray-800 dark:text-gray-200">${user.username}</span>
                        </div>
                   ${hasLiked ? '<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>' : ''}
                    </div>
                `;
            }).join('');
            
            statusViewersList.innerHTML = viewersHtml;
        }


        function closeStatusViewer() {
            clearTimeout(currentStatusViewerTimeout);
            if (unsubscribeStatusItem) unsubscribeStatusItem(); // Unsubscribe from item listener
            statusViewerModal.classList.add('hidden');
            statusViewerContent.innerHTML = '';
            currentViewingStatus = {};
            deleteStatusBtn.classList.add('hidden'); // Hide delete btn
        }

        closeStatusViewerBtn.addEventListener('click', closeStatusViewer);
        closeViewersModalBtn.addEventListener('click', () => statusViewersModal.classList.add('hidden'));

        // =================================================================
        // 18. VOICE NOTE LOGIC
        // =================================================================
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Show recording UI and add animation
                recordingIndicator.classList.remove('hidden');
                voiceNoteBtn.classList.add('animate-bump'); // Add animation class
                
                // Hide input using opacity to prevent layout shift
                messageInput.style.opacity = '0';
                messageInput.style.pointerEvents = 'none'; 

                recordingTimerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                    recordingTimer.textContent = formatDuration(elapsedSeconds);
                }, 1000);

                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const duration = (Date.now() - recordingStartTime) / 1000;

                    if (duration > 1) { // Only send if recording is longer than 1 second
                        uploadAudioAndSendMessage(audioBlob, duration);
                    }

                    // Cleanup
                    audioChunks = [];
                    stream.getTracks().forEach(track => track.stop());
                    clearInterval(recordingTimerInterval);
                    recordingIndicator.classList.add('hidden');
                    messageInput.classList.remove('hidden');
                });
            } catch (err) {
                console.error("Error accessing microphone:", err);
                showToast("Microphone access denied.", "error");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
            // --- MODIFICATIONS START ---
            // Cleanup UI regardless of recorder state
            clearInterval(recordingTimerInterval);
            recordingIndicator.classList.add('hidden');
            voiceNoteBtn.classList.remove('animate-bump'); // Remove animation class

            // Show the input again
            messageInput.style.opacity = '1';
            messageInput.style.pointerEvents = 'auto';
            audioChunks = []; // Clear chunks here
            // --- MODIFICATIONS END ---
        }
        
        voiceNoteBtn.addEventListener('mousedown', startRecording);
        voiceNoteBtn.addEventListener('mouseup', stopRecording);
        voiceNoteBtn.addEventListener('mouseleave', stopRecording); // Cancel if mouse leaves button
        voiceNoteBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
        voiceNoteBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });


        async function uploadAudioAndSendMessage(audioBlob, duration) {
             if (!currentChatPartner) return;
             const tempId = `upload-${Date.now()}`;
             const placeholder = document.createElement('div');
             placeholder.id = tempId;
             placeholder.className = 'flex flex-col message-bubble-wrapper items-end';
             placeholder.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                     <div class="p-2 rounded-2xl bg-primary text-white rounded-br-none opacity-70">
                         <div class="flex items-center space-x-2">
                             <div class="w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin"></div>
                             <span>Uploading voice note...</span>
                         </div>
                     </div>
                </div>`;
             messagesContainer.appendChild(placeholder);
             messagesContainer.scrollTop = messagesContainer.scrollHeight;

             try {
                const CLOUD_NAME = "dzuyq67ql"; 
                const UPLOAD_PRESET = "twinkle_profiles";
                // Cloudinary uses the 'video' endpoint for audio files as well
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`;
                
                const formData = new FormData();
                formData.append('file', audioBlob);
                formData.append('upload_preset', UPLOAD_PRESET);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed.');

                const data = await response.json();
                const audioUrl = data.secure_url;
                // Cloudinary provides duration for video/audio uploads
                const audioDuration = data.duration || duration; 

                if (!audioUrl) throw new Error('Cloudinary did not return a URL.');

                await sendVoiceMessage(audioUrl, audioDuration);

             } catch (error) {
                 console.error("Voice Note Upload Error:", error);
                 placeholder.querySelector('span').textContent = 'Upload failed!';
                 setTimeout(() => placeholder.remove(), 4000);
             } finally {
                 placeholder.remove();
             }
        }

        async function sendVoiceMessage(audioUrl, duration) {
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                type: "voice",
                audioUrl: audioUrl,
                duration: duration,
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                await addDoc(messagesRef, newMessage);

                await setDoc(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: " Voice Note",
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    unreadCount: { [currentUser.uid]: 0, [currentChatPartner.uid]: increment(1) }
                }, { merge: true });

            } catch (error) {
                console.error("Error sending voice message: ", error);
                alert("Could not send voice note.");
            }
        }
    </script>
</body>
</html>