<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twinkle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
    <script>
        // Custom Tailwind theme configuration for our purple color
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    colors: {
                        primary: '#6a0dad',
                        ludo: { // Kept for other UI elements if needed, but not used by ludo game
                            red: '#ef4444',
                            green: '#22c55e',
                            yellow: '#f59e0b',
                            blue: '#3b82f6',
                        }
                    },
                    keyframes: {
                        'fade-in-up': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        'spin': {
                            'to': { transform: 'rotate(360deg)' },
                        },
                        'blink': {
                            '50%': { opacity: '0.2' },
                        },
                    },
                    animation: {
                        'fade-in-up': 'fade-in-up 0.3s ease-out',
                        'fade-in': 'fade-in 1.5s ease-out', /* Slower fade-in for logo */
                        'scale-in': 'scale-in 0.2s ease-out',
                        'spin': 'spin 1s linear infinite',
                        'blink': 'blink 1.4s infinite both',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* --- CUSTOM HEADER GLASS EFFECT --- */
        header.glass-effect {
            background: transparent !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: none !important;
            -webkit-mask-image: none !important;
            mask-image: none !important;
        }

        /* --- DARKER THEME OVERRIDES --- */
        .dark body, .dark .dark\:bg-gray-900, .dark .bg-gray-900 {
            background-color: #000000 !important;
        }
        .dark .dark\:bg-gray-800, .dark .bg-gray-800 {
            background-color: #121212 !important;
        }
        .dark .dark\:bg-gray-700, .dark .bg-gray-700 {
            background-color: #1e1e1e !important;
        }
        .dark .dark\:border-gray-600, .dark .border-gray-600 {
            border-color: #333333 !important;
        }
        .dark .dark\:border-gray-700, .dark .border-gray-700 {
            border-color: #2a2a2a !important;
        }
        .dark .dark\:text-gray-400, .dark .text-gray-400 {
            color: #999999 !important;
        }
        .dark .dark\:text-gray-300, .dark .text-gray-300 {
            color: #cccccc !important;
        }
        .dark .glass-effect {
            background: rgba(18, 18, 18, 0.75) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border-color: rgba(47, 47, 47, 0.7) !important;
        }
        .dark ::-webkit-scrollbar-track { background: #000000; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .dark .theme-doodle {
            background-color: #000000 !important;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234B5563' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") !important;
        }
        .dark .theme-geometric {
            background-color: #000000 !important;
            background-image: linear-gradient(135deg, #000000 25%, transparent 25%), linear-gradient(225deg, #000000 25%, transparent 25%), linear-gradient(45deg, #000000 25%, transparent 25%), linear-gradient(315deg, #000000 25%, #121212 25%) !important;
        }
        .dark .reaction-chip {
            background-color: #2a2a2a !important;
        }
        .dark .dark-text-glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        /* --- END DARKER THEME OVERRIDES --- */

        /* --- NEW UI IMPROVEMENT STYLES --- */
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .bg-gradient-custom {
            background-image: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
        }
        .border-gradient-custom {
            border-image-slice: 1;
            border-image-source: linear-gradient(to right, #3b82f6, #8b5cf6, #f59e0b);
        }
        .logo-text span.large {
            font-size: 1.25em; /* Makes 'T' bigger */
            vertical-align: baseline;
        }

        /* Glass Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.5); /* From dark:bg-gray-800 */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Simple scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px;}
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .hidden { display: none; }
        .message-bubble-wrapper:hover .action-btn {
            opacity: 1;
        }
        .dark .dark-text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.2);
        }
        /* Rich Link Preview Styles */
        .link-preview {
            border-left: 3px solid #6a0dad;
        }
        .link-preview-image {
            width: 64px;
            height: 64px;
            object-fit: cover;
        }
        .rewrite-suggestion {
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .rewrite-suggestion:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Message Actions Menu */
        .message-actions-menu {
            display: none;
            position: absolute;
            right: 0;
            top: -10px;
            z-index: 10;
        }
        .message-bubble-wrapper:hover .message-actions-menu {
            display: block;
        }
        .unsend-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .unsend-btn:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Emoji Reactions */
        .reaction-chip {
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #e5e7eb; /* gray-200 */
            transition: background-color 0.2s;
        }
        .dark .reaction-chip {
            background-color: #4b5563; /* gray-600 */
        }
        .reaction-chip.reacted-by-me {
            background-color: #60a5fa; /* blue-400 */
            color: white;
        }
        .dark .reaction-chip.reacted-by-me {
            background-color: #3b82f6; /* blue-500 */
        }

        /* --- CHAT THEME STYLES --- */
        .theme-preview-item {
            cursor: pointer;
        }
        .theme-preview-item .border-primary {
            border-color: #6a0dad;
        }
        .theme-preview-item > div {
            background-size: cover;
            background-position: center;
        }

        /* Base styles for themes on messages container */
        #messages-container {
            transition: background 0.3s ease;
        }

        /* Theme 1: Doodle Fun */
        .theme-doodle {
            background-color: #f3f4f6; /* light: gray-100 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239CA3AF' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-doodle {
            background-color: #111827; /* dark: gray-900 */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234B5563' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 2: Geometric Bliss */
        .theme-geometric {
            background-color: #f3f4f6;
            background-image: linear-gradient(135deg, #f3f4f6 25%, transparent 25%), linear-gradient(225deg, #f3f4f6 25%, transparent 25%), linear-gradient(45deg, #f3f4f6 25%, transparent 25%), linear-gradient(315deg, #f3f4f6 25%, #e5e7eb 25%);
            background-size: 40px 40px;
            background-position: -10px 0, -10px 0, 0 0, 0 0;
        }
        .dark .theme-geometric {
            background-color: #111827;
            background-image: linear-gradient(135deg, #111827 25%, transparent 25%), linear-gradient(225deg, #111827 25%, transparent 25%), linear-gradient(45deg, #111827 25%, transparent 25%), linear-gradient(315deg, #111827 25%, #1f2937 25%);
        }

        /* Theme 3: Cosmic Dust */
        .theme-cosmic {
            background-color: #0c0a1a;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="0.1"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4v-9H0v-1h4V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h9V0h1v4h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm-90-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9z"/%3E%3Cpath d="M6 5V0h1v5h5v1H6v5H5V6H0V5h5z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }
        html:not(.dark) .theme-cosmic {
            background-color: #f0f2ff;
            background-image: none; /* or a very light pattern if needed */
        }

        /* Theme 4: Lush Leaves */
        .theme-leaves {
            background-color: #f0fff4; /* mint-cream like */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23a7f3d0' fill-opacity='0.2'%3E%3Cpath fill-rule='evenodd' d='M11 0l5 20-5-5-5 5L11 0zm22 24l5 20-5-5-5 5 5-20zm22 24l5 20-5-5-5 5 5-20zM11 48l5 20-5-5-5 5 5-20z'/%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-leaves {
            background-color: #052e16; /* dark green */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg fill='%23a7f3d0' fill-opacity='0.1'%3E%3Cpath fill-rule='evenodd' d='M11 0l5 20-5-5-5 5L11 0zm22 24l5 20-5-5-5 5 5-20zm22 24l5 20-5-5-5 5 5-20zM11 48l5 20-5-5-5 5 5-20z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 5: Oceanic Waves */
        .theme-waves {
            background: #e0f2fe; /* light blue */
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%237dd3fc' fill-opacity='0.2'%3E%3Cpath d='M0 40c0 11.046 8.954 20 20 20s20-8.954 20-20S31.046 20 20 20 0 28.954 0 40zm80 0c0 11.046-8.954 20-20 20s-20-8.954-20-20 8.954-20 20-20 20 8.954 20 20zM20 0c11.046 0 20 8.954 20 20s-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0zm40 80c11.046 0 20-8.954 20-20s-8.954-20-20-20-20 8.954-20 20 8.954 20 20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .theme-waves {
            background: #0c2a4d; /* dark blue */
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%237dd3fc' fill-opacity='0.1'%3E%3Cpath d='M0 40c0 11.046 8.954 20 20 20s20-8.954 20-20S31.046 20 20 20 0 28.954 0 40zm80 0c0 11.046-8.954 20-20 20s-20-8.954-20-20 8.954-20 20-20 20 8.954 20 20zM20 0c11.046 0 20 8.954 20 20s-8.954 20-20 20S0 31.046 0 20 8.954 0 20 0zm40 80c11.046 0 20-8.954 20-20s-8.954-20-20-20-20 8.954-20 20 8.954 20 20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Theme 6: Sunset Gradient */
        .theme-sunset {
            background: linear-gradient(170deg, #fef3c7, #fbcfe8, #e9d5ff);
        }
        .dark .theme-sunset {
            background: linear-gradient(170deg, #422006, #4a044e, #2e1065);
        }

        /* --- GRADIENT THEMES --- */
        /* Theme 7: Minty Fresh */
        .theme-minty {
            background: linear-gradient(170deg, #d4fc79, #96e6a1);
        }
        .dark .theme-minty {
            background: linear-gradient(170deg, #09203f, #537895);
        }

        /* Theme 8: Royal Amethyst */
        .theme-amethyst {
            background: linear-gradient(170deg, #c471f5, #fa71cd);
        }
        .dark .theme-amethyst {
            background: linear-gradient(170deg, #480572, #240039);
        }

        /* Theme 9: Fiery Sunrise */
        .theme-sunrise {
            background: linear-gradient(170deg, #fceabb, #f8b500);
        }
        .dark .theme-sunrise {
            background: linear-gradient(170deg, #870000, #190a05);
        }

        /* Theme 10: Cyber Glow */
        .theme-cyber {
            background: linear-gradient(170deg, #00d2ff, #3a7bd5);
        }
        .dark .theme-cyber {
            background: linear-gradient(170deg, #f02fc2, #609ea);
        }

        /* Theme 11: Arctic Night */
        .theme-arctic {
            background: linear-gradient(170deg, #e0c3fc, #8ec5fc);
        }
        .dark .theme-arctic {
            background: linear-gradient(170deg, #000428, #004e92);
        }

        /* Theme 12: Sweet Peach */
        .theme-peach {
            background: linear-gradient(170deg, #ffdde1, #ee9ca7);
        }
        .dark .theme-peach {
            background: linear-gradient(170deg, #6d2e36, #3b171c);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans antialiased">

    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
        <h1 class="text-6xl font-bold logo-text text-gradient animate-fade-in">
            <span class="large">T</span>winkle
        </h1>
    </div>

    <div id="auth-page" class="hidden">
        <div class="w-screen h-screen grid grid-cols-1 md:grid-cols-2">
            
            <div class="hidden md:flex flex-col items-center justify-center bg-gradient-to-br from-primary via-purple-800 to-indigo-700 text-white p-12 text-center relative overflow-hidden">
                <div class="absolute -top-16 -left-16 w-64 h-64 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-24 -right-10 w-72 h-72 bg-white/10 rounded-full"></div>
                
                <div class="z-10 animate-fade-in">
                    <h1 class="text-7xl font-bold logo-text">
                        <span class="large">T</span>winkle
                    </h1>
                    <p class="mt-4 text-lg text-purple-200 max-w-sm mx-auto">
                        Connect instantly. Chat seamlessly. Welcome to the future of conversation.
                    </p>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900 overflow-y-auto">
                <div class="w-full max-w-md">
                    
                    <div id="login-view">
                        <div class="p-8 space-y-6 md:bg-white md:dark:bg-gray-800 md:rounded-2xl md:shadow-2xl animate-scale-in">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Welcome Back!</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Login to continue to Twinkle</p>
                            </div>
                            <div class="space-y-4">
                                <button id="google-signin-btn" class="w-full flex items-center justify-center py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 39.233 44 34.026 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                                    Sign in with Google
                                </button>
                                <div class="relative">
                                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-50 dark:bg-gray-900 md:bg-white md:dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span></div>
                                </div>
                            </div>
                            <form id="login-form" class="space-y-6">
                                <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <button type="submit" class="w-full py-3 text-white bg-gradient-custom rounded-md hover:opacity-90 transition-opacity font-bold active:scale-95">Login</button>
                            </form>
                            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Don't have an account? <a href="#" id="show-signup" class="font-medium text-primary hover:underline">Sign up</a></p>
                        </div>
                    </div>

                    <div id="signup-view" class="hidden">
                        <div class="p-8 space-y-6 md:bg-white md:dark:bg-gray-800 md:rounded-2xl md:shadow-2xl animate-scale-in">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Create Account</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Get started with Twinkle</p>
                            </div>
                            <div class="space-y-4">
                                <button id="google-signup-btn" class="w-full flex items-center justify-center py-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#34A853" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#FBBC05" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#EA4335" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 39.233 44 34.026 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                                    Sign up with Google
                                </button>
                                <div class="relative">
                                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-50 dark:bg-gray-900 md:bg-white md:dark:bg-gray-800 text-gray-500 dark:text-gray-400">Or continue with</span></div>
                                </div>
                            </div>
                            <form id="signup-form" class="space-y-6">
                                <input type="text" id="signup-username" placeholder="Username (must be unique)" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="email" id="signup-email" placeholder="Email Address" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-transparent md:bg-gray-50 md:dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                                <button type="submit" class="w-full py-3 text-white bg-gradient-custom rounded-md hover:opacity-90 transition-opacity font-bold active:scale-95">Sign Up</button>
                            </form>
                            <p class="text-sm text-center text-gray-600 dark:text-gray-400">Already have an account? <a href="#" id="show-login" class="font-medium text-primary hover:underline">Login</a></p>
                        </div>
                    </div>

                </div>
            </div>
            
        </div>
    </div>

    <div id="profile-setup-page" class="hidden">
        <div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900 p-4">
            <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl animate-scale-in">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Complete Your Profile</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Choose a username and password to finish setting up your account.</p>
                </div>
                <form id="profile-setup-form" class="space-y-6">
                    <div>
                        <input type="text" id="setup-username" placeholder="Choose a unique username" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                        <p id="username-feedback" class="text-xs mt-1 h-4"></p>
                    </div>
                    <input type="password" id="setup-password" placeholder="Create a password (min. 6 characters)" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <input type="password" id="setup-password-confirm" placeholder="Confirm your password" required class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-primary transition">
                    <button type="submit" id="complete-profile-btn" class="w-full py-3 text-white bg-gradient-custom rounded-md hover:opacity-90 transition-opacity font-bold active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">Complete Profile</button>
                </form>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 class="text-lg font-bold text-center text-gray-900 dark:text-white">Crop Your Photo</h3>
            <div id="crop-container" class="w-full h-64"></div>
            <div class="flex justify-center space-x-4">
                 <button id="cancel-crop-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                 <button id="save-crop-btn" class="py-2 px-4 text-sm font-medium text-white bg-primary rounded-md hover:bg-purple-800 transition">Crop & Save</button>
            </div>
        </div>
    </div>


    <div id="app-container" class="hidden h-screen w-screen flex flex-col bg-gray-100 dark:bg-gray-900">
        <header class="fixed top-0 left-0 right-0 glass-effect py-2 px-4 flex justify-between items-center z-10">
             <h1 class="text-xl font-bold logo-text text-gradient">
                <span class="large">T</span>winkle
            </h1>
            <button id="open-gemini-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white transition-colors">
                <img src="https://static.vecteezy.com/system/resources/previews/055/687/055/non_2x/rectangle-gemini-google-icon-symbol-logo-free-png.png"  width="27" height="27">
        </header>

        <main class="flex-1 overflow-y-auto pb-20 pt-14">
            <div id="chats-page" class="page p-4 relative h-full">
                <input type="search" id="search-input" placeholder="Search existing chats..." class="w-full mb-4 px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                <div id="chat-list" class="space-y-3">
                    </div>
            </div>
            
            <div id="settings-page" class="page hidden">
                <header class="p-4 flex-shrink-0">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h2>
                </header>
                <div class="p-4 space-y-6">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="search" placeholder="Search settings" class="w-full pl-10 pr-4 py-2 text-sm border-gray-300 dark:border-gray-700 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>

                    <div id="settings-profile-link" class="flex items-center space-x-4 p-3 bg-white dark:bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <img id="settings-profile-pic" class="w-16 h-16 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile">
                        <div>
                            <h3 id="settings-profile-username" class="font-bold text-lg text-gray-900 dark:text-white">Username</h3>
                            <p id="settings-profile-bio" class="text-sm text-gray-500 dark:text-gray-400 truncate">This is your bio...</p>
                        </div>
                    </div>

                    <div class="space-y-1 bg-white dark:bg-gray-800 rounded-lg p-2">
                        <a href="#" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                            <span class="text-gray-900 dark:text-white">Favorites</span>
                        </a>
                        <a href="#" id="privacy-settings-link" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                            <span class="text-gray-900 dark:text-white">Privacy</span>
                        </a>
                         <a href="#" id="chat-settings-section-link" class="flex items-center space-x-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition rounded-md">
                            <svg class="w-6 h-6 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="text-gray-900 dark:text-white">Chat Settings</span>
                        </a>
                    </div>

                    <button id="logout-button" class="w-full mt-4 py-3 text-white bg-red-500 rounded-lg hover:bg-red-600 transition active:scale-95">Logout</button>
                </div>
            </div>

            <div id="privacy-settings-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-privacy-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Privacy Settings</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Read Receipts</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">If turned off, you won't send or receive read receipts.</p>
                                </div>
                                <button id="read-receipts-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 flex-shrink-0">
                                    <span id="read-receipts-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                        </div>
                </div>
            </div>
            
             <div id="chat-settings-section-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-chat-settings-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Chat Settings</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Dark Mode</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Toggle between light and dark theme for the app.</p>
                                </div>
                                <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 dark:bg-gray-600 flex-shrink-0">
                                    <span id="theme-toggle-slider" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1 dark:translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                        <div id="chat-theme-selector-link" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                            <div class="flex items-center justify-between">
                                <div class="mr-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200">Chat Background Theme</h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Select a background for your chats.</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="current-theme-preview" class="w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-theme-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-40">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-chat-theme-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Select a Theme</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto grid grid-cols-2 gap-4">
                        <div class="theme-preview-item" data-theme="theme-default">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent bg-gray-100 dark:bg-gray-900 flex items-center justify-center"><span class="text-gray-800 dark:text-gray-200">Default</span></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Default</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-doodle">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-doodle"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Doodle Fun</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-geometric">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-geometric"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Geometric Bliss</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-cosmic">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-cosmic"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Cosmic Dust</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-leaves">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-leaves"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Lush Leaves</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-waves">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-waves"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Oceanic Waves</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-sunset">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-sunset"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Sunset Gradient</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-minty">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-minty"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Minty Fresh</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-amethyst">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-amethyst"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Royal Amethyst</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-sunrise">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-sunrise"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Fiery Sunrise</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-cyber">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-cyber"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Cyber Glow</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-arctic">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-arctic"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Arctic Night</p>
                        </div>
                        <div class="theme-preview-item" data-theme="theme-peach">
                            <div class="w-full h-32 rounded-lg border-2 border-transparent theme-peach"></div>
                            <p class="text-center text-sm mt-2 text-gray-700 dark:text-gray-300">Sweet Peach</p>
                        </div>
                    </div>
                </div>
            </div>


            <div id="profile-edit-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                 <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-profile-edit-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Edit Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <div id="profile-pic-container" class="relative w-24 h-24 mx-auto mb-4 cursor-pointer group">
                                <img id="profile-pic-display" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Profile Picture">
                                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <span class="text-white text-xs font-bold">Change</span>
                                </div>
                            </div>
                            <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                            
                            <div id="username-display-container" class="flex justify-center items-center gap-2 mb-1">
                                <h3 id="profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                                <button id="edit-username-btn" class="text-sm text-primary font-semibold p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L13.196 5.232z" /></svg>
                                </button>
                            </div>

                            <div id="username-input-container" class="hidden max-w-xs mx-auto">
                                <input type="text" id="username-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-center text-gray-900 dark:text-gray-200" />
                                <div class="mt-2 flex gap-2">
                                     <button id="cancel-username-btn" class="w-full py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                                     <button id="save-username-btn" class="w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                                </div>
                            </div>

                            <p id="profile-email" class="text-gray-500 dark:text-gray-400">email@example.com</p>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-gray-800 dark:text-gray-200">Bio</h4>
                                <button id="edit-bio-btn" class="text-sm text-primary font-semibold">Edit</button>
                            </div>
                            <p id="bio-text" class="text-gray-600 dark:text-gray-300 text-sm">This is your bio. Click edit to change it.</p>
                            <textarea id="bio-input" class="hidden w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 text-sm text-gray-900 dark:text-gray-200" rows="3"></textarea>
                            <button id="save-bio-btn" class="hidden mt-2 w-full py-2 text-sm text-white bg-primary rounded-md hover:bg-purple-800 transition active:scale-95">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-room-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-to-chats-btn" class="text-primary dark:text-white p-2 text-sm">
                        Back
                    </button>
                    <div id="chat-room-header-clickable" class="flex items-center space-x-3 cursor-pointer flex-1">
                        <div class="relative w-10 h-10">
                            <img id="chat-room-pic" class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/6a0dad/white?text=P" alt="Partner">
                            <div id="chat-room-status-dot" class="w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>
                        </div>
                        <div>
                            <h2 id="chat-room-username" class="font-bold text-gray-900 dark:text-white dark-text-glow">Chat Partner</h2>
                            <p id="chat-room-status-text" class="text-xs text-gray-500">Offline</p>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="chat-settings-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-white">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                        <div id="chat-settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg z-10">
                            <a href="#" id="delete-chat-btn" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600">Delete Chat</a>
                        </div>
                    </div>
                </header>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-2">
                    <div id="emoji-reaction-picker" class="hidden absolute z-20 flex items-center gap-2 p-1.5 bg-white dark:bg-gray-700 rounded-full shadow-lg transition-transform duration-150 ease-out">
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">👍</button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">❤️</button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">😂</button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">😮</button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">😢</button>
                        <button class="reaction-emoji text-2xl hover:scale-125 transition-transform">🙏</button>
                    </div>
                </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <div id="typing-indicator-container" class="h-12"></div>
                    <div id="ai-rewrite-popup" class="hidden mb-2 p-4 bg-white dark:bg-gray-700 rounded-lg shadow-lg animate-fade-in-up">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold flex items-center"><span class="mr-2 text-lg">✨</span> Gemini</h4>
                            <button id="close-rewrite-popup-btn" class="text-gray-500 dark:text-gray-400">&times;</button>
                        </div>
                        <div id="rewrite-suggestions" class="space-y-2 text-sm">
                            </div>
                    </div>
                    <div id="reply-preview-container" class="hidden p-2 mb-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <p id="reply-preview-username" class="text-sm font-bold text-sky-500"></p>
                                <p id="reply-preview-text" class="text-xs text-gray-600 dark:text-gray-300 truncate"></p>
                            </div>
                            <button id="cancel-reply-btn" class="text-gray-500 dark:text-gray-400">&times;</button>
                        </div>
                    </div>
                    <button id="ai-rewrite-btn" class="hidden w-full mb-2 flex items-center justify-center gap-2 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        😊 AI Rewrite
                    </button>
                    <form id="message-form" class="flex items-center">
                        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-gradient-custom text-white rounded-full hover:opacity-90 transition-opacity active:scale-95">Send</button>
                    </form>
                </footer>
            </div>
            
            <div id="search-users-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-search-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <input type="search" id="user-search-input" placeholder="Search for users by username..." class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                </header>
                <div id="user-search-results" class="flex-1 overflow-y-auto p-4 space-y-3">
                    </div>
            </div>

            <div id="partner-profile-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-30">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-partner-profile-btn" class="text-primary dark:text-white p-2 text-sm">Back</button>
                    <h2 class="font-bold text-gray-900 dark:text-white">Profile</h2>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                     <div class="max-w-md mx-auto space-y-4">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center">
                            <img id="partner-profile-pic" class="w-24 h-24 rounded-full object-cover ring-4 ring-primary ring-opacity-50 mx-auto mb-4" src="https://placehold.co/100x100/6a0dad/white?text=A" alt="Partner Profile Picture">
                            <h3 id="partner-profile-username" class="text-2xl font-bold text-gray-900 dark:text-white">Username</h3>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-left">
                            <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-2">Bio</h4>
                            <p id="partner-profile-bio" class="text-gray-600 dark:text-gray-300 text-sm">No bio available.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gemini-page" class="page hidden fixed inset-0 flex flex-col bg-gray-100 dark:bg-gray-900 z-20">
                <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex items-center space-x-3 flex-shrink-0">
                    <button id="back-from-gemini-btn" class="text-primary dark:text-white p-2 text-sm">
                        Back
                    </button>
                    <h2 class="font-bold text-gray-900 dark:text-white flex items-center">
    <img src="https://static.vecteezy.com/system/resources/previews/055/687/055/non_2x/rectangle-gemini-google-icon-symbol-logo-free-png.png" width="25" height="25"> &nbsp;  Gemini
                    </h2>
                </header>
                <div id="gemini-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    </div>
                <footer class="p-4 bg-white dark:bg-gray-800 border-t dark:border-gray-700">
                    <div id="gemini-typing-indicator" class="h-6 mb-2"></div>
                    <form id="gemini-message-form" class="flex items-center">
                        <input type="text" id="gemini-message-input" placeholder="Type a message to Gemini..." autocomplete="off" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                        <button type="submit" class="ml-3 p-3 bg-gradient-custom text-white rounded-full hover:opacity-90 transition-opacity active:scale-95">Send</button>
                    </form>
                </footer>
            </div>

            <div id="delete-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4 text-center">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Delete Chat</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Are you sure you want to permanently delete this entire conversation?</p>
                    <div class="flex justify-center space-x-4">
                         <button id="cancel-delete-btn" class="py-2 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-500 transition">Cancel</button>
                         <button id="confirm-delete-btn" class="py-2 px-4 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            </div>

        </main>

        <nav class="glass-effect fixed bottom-0 left-0 right-0 mx-2 mb-2 rounded-xl flex justify-around py-0.5 px-1 z-10">
            <button data-page="chats-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                <div class="relative">
                    <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    <span id="chats-badge" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                </div>
                <span class="text-xs font-semibold">Chats</span>
            </button>
            <button data-page="search-users-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                 <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <span class="text-xs font-semibold">Search</span>
            </button>
            <button data-page="settings-page" class="nav-btn flex flex-col items-center justify-center w-full py-1 rounded-lg transition-colors duration-200">
                <svg class="w-5 h-5 mb-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="text-xs font-semibold">Settings</span>
            </button>
        </nav>
    </div>

    <script type="module">
        // =================================================================
        // 1. FIREBASE SDK IMPORTS (FROM CDN)
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            EmailAuthProvider,
            linkWithCredential
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, getDoc, setDoc, updateDoc, deleteDoc,
            collection, query, where, orderBy, onSnapshot, addDoc,
            serverTimestamp, runTransaction, getDocs, limit, writeBatch, Timestamp, increment, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        
        // =================================================================
        // 2. FIREBASE CONFIGURATION
        // =================================================================
       const firebaseConfig = {
          apiKey: "AIzaSyBMZBqPHViEWGA7mT_GN_mePBOnqT1NYz0",
          authDomain: "chat-app-e1891.firebaseapp.com",
          projectId: "chat-app-e1891",
          storageBucket: "chat-app-e1891.appspot.com",
          messagingSenderId: "889518853542",
          appId: "1:889518853542:web:969c0d35177a3fb2fd9367"
        };

        // =================================================================
        // 3. INITIALIZE FIREBASE & SERVICES
        // =================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        
        // =================================================================
        // 4. GLOBAL STATE & DOM REFERENCES
        // =================================================================
        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribeChats = null;
        let unsubscribeUsers = null;
        let unsubscribeMessages = null;
        let unsubscribePartnerStatus = null;
        let unsubscribeTypingStatus = null;
        let typingTimeout = null;
        let currentReply = null;
        let geminiChatHistory = [];
        let readReceiptObserver = null;
        let pressHoldTimer = null;
        let activeMessageForReaction = null;
        let usernameCheckTimeout = null;
        let croppieInstance = null;

        // Data caches for real-time updates
        let allChatsData = [];
        let allUsersData = {};
        
        const loadingScreen = document.getElementById('loading-screen');
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        const pages = document.querySelectorAll('.page');
        
        // Forms & Toggles
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const loginView = document.getElementById('login-view');
        const signupView = document.getElementById('signup-view');
        
        // NEW: Profile Setup Page References
        const profileSetupPage = document.getElementById('profile-setup-page');
        const profileSetupForm = document.getElementById('profile-setup-form');
        const setupUsernameInput = document.getElementById('setup-username');
        const usernameFeedback = document.getElementById('username-feedback');
        const completeProfileBtn = document.getElementById('complete-profile-btn');

        // NEW: Crop Modal References
        const cropModal = document.getElementById('crop-modal');
        const cropContainer = document.getElementById('crop-container');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        const saveCropBtn = document.getElementById('save-crop-btn');

        // Buttons
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        const logoutButton = document.getElementById('logout-button');
        const navButtons = document.querySelectorAll('.nav-btn');
        const openGeminiBtn = document.getElementById('open-gemini-btn');
        
        // Chat List
        const searchInput = document.getElementById('search-input');
        const chatList = document.getElementById('chat-list');
        const chatsBadge = document.getElementById('chats-badge');
        
        // Chat Room
        const chatRoomPage = document.getElementById('chat-room-page');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const chatRoomHeaderClickable = document.getElementById('chat-room-header-clickable');
        const chatRoomUsername = document.getElementById('chat-room-username');
        const chatRoomPic = document.getElementById('chat-room-pic');
        const chatRoomStatusDot = document.getElementById('chat-room-status-dot');
        const chatRoomStatusText = document.getElementById('chat-room-status-text');
        const replyPreviewContainer = document.getElementById('reply-preview-container');
        const replyPreviewUsername = document.getElementById('reply-preview-username');
        const replyPreviewText = document.getElementById('reply-preview-text');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');
        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        const chatSettingsMenu = document.getElementById('chat-settings-menu');
        const deleteChatBtn = document.getElementById('delete-chat-btn');
        const emojiReactionPicker = document.getElementById('emoji-reaction-picker');

        // User Search
        const searchUsersPage = document.getElementById('search-users-page');
        const backFromSearchBtn = document.getElementById('back-from-search-btn');
        const userSearchInput = document.getElementById('user-search-input');
        const userSearchResults = document.getElementById('user-search-results');

        // Settings Page
        const settingsProfileLink = document.getElementById('settings-profile-link');
        const settingsProfilePic = document.getElementById('settings-profile-pic');
        const settingsProfileUsername = document.getElementById('settings-profile-username');
        const settingsProfileBio = document.getElementById('settings-profile-bio');
        const privacySettingsLink = document.getElementById('privacy-settings-link');

        // Privacy Settings Page
        const backFromPrivacyBtn = document.getElementById('back-from-privacy-btn');

        // Profile Edit Page
        const backFromProfileEditBtn = document.getElementById('back-from-profile-edit-btn');
        const profilePicContainer = document.getElementById('profile-pic-container');
        const profilePicInput = document.getElementById('profile-pic-input');
        const profilePicDisplay = document.getElementById('profile-pic-display');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const editBioBtn = document.getElementById('edit-bio-btn');
        const saveBioBtn = document.getElementById('save-bio-btn');
        const bioText = document.getElementById('bio-text');
        const bioInput = document.getElementById('bio-input');
        const editUsernameBtn = document.getElementById('edit-username-btn');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const cancelUsernameBtn = document.getElementById('cancel-username-btn');
        const usernameInput = document.getElementById('username-input');
        const usernameDisplayContainer = document.getElementById('username-display-container');
        const usernameInputContainer = document.getElementById('username-input-container');


        // Partner Profile Page
        const partnerProfilePage = document.getElementById('partner-profile-page');
        const backFromPartnerProfileBtn = document.getElementById('back-from-partner-profile-btn');
        const partnerProfilePic = document.getElementById('partner-profile-pic');
        const partnerProfileUsername = document.getElementById('partner-profile-username');
        const partnerProfileBio = document.getElementById('partner-profile-bio');

        // Gemini Page
        const geminiPage = document.getElementById('gemini-page');
        const backFromGeminiBtn = document.getElementById('back-from-gemini-btn');
        const geminiMessagesContainer = document.getElementById('gemini-messages-container');
        const geminiMessageForm = document.getElementById('gemini-message-form');
        const geminiMessageInput = document.getElementById('gemini-message-input');
        const geminiTypingIndicator = document.getElementById('gemini-typing-indicator');

        // Modals
        const deleteChatModal = document.getElementById('delete-chat-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // AI Rewrite References
        const aiRewriteBtn = document.getElementById('ai-rewrite-btn');
        const aiRewritePopup = document.getElementById('ai-rewrite-popup');
        const closeRewritePopupBtn = document.getElementById('close-rewrite-popup-btn');
        const rewriteSuggestionsContainer = document.getElementById('rewrite-suggestions');
        
        // Theme Toggle & Chat Themes
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleSlider = document.getElementById('theme-toggle-slider');
        const readReceiptsToggle = document.getElementById('read-receipts-toggle');
        const readReceiptsToggleSlider = document.getElementById('read-receipts-toggle-slider');
        const chatSettingsSectionLink = document.getElementById('chat-settings-section-link');
        const chatSettingsSectionPage = document.getElementById('chat-settings-section-page');
        const backFromChatSettingsBtn = document.getElementById('back-from-chat-settings-btn');
        const chatThemeSelectorLink = document.getElementById('chat-theme-selector-link');
        const chatThemePage = document.getElementById('chat-theme-page');
        const backFromChatThemeBtn = document.getElementById('back-from-chat-theme-btn');
        const themePreviewItems = document.querySelectorAll('.theme-preview-item');
        const currentThemePreview = document.getElementById('current-theme-preview');


        // =================================================================
        // 5. HELPER FUNCTIONS
        // =================================================================
        const getInitials = (name = '') => name ? name.charAt(0).toUpperCase() : '?';
        const getPlaceholderUrl = (initials) => `https://placehold.co/100x100/6a0dad/white?text=${initials}`;
        const timeAgo = (timestamp) => {
            if (!timestamp) return '';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp.toMillis()) / 1000);
            
            if (seconds < 60) return `just now`;
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) {
                const days = Math.floor(interval);
                if (days === 1) return "yesterday";
                return days + " days ago";
            }
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return `just now`;
        };
        const formatMessageTime = (timestamp) => {
            if (!timestamp) return '';
            return timestamp.toDate().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        };

        const extractUrls = (text) => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.match(urlRegex) || [];
        }

        async function fetchLinkPreview(url) {
            const cachedData = sessionStorage.getItem(url);
            if (cachedData) {
                return JSON.parse(cachedData);
            }

            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) return null;
                const data = await response.json();
                const html = data.contents;
                
                if (!html) return null;

                const doc = new DOMParser().parseFromString(html, 'text/html');
                const title = doc.querySelector('meta[property="og:title"]')?.getAttribute('content') || doc.querySelector('title')?.textContent || '';
                const description = doc.querySelector('meta[property="og:description"]')?.getAttribute('content') || doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';
                let image = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';
                
                if (image && !image.startsWith('http')) {
                    try {
                        const urlObj = new URL(url);
                        image = `${urlObj.origin}${image}`;
                    } catch (e) {
                        image = '';
                    }
                }

                const previewData = {
                    url,
                    title: title.trim(),
                    description: description.trim(),
                    image: image || 'https://placehold.co/64x64/eee/ccc?text=N/A'
                };

                sessionStorage.setItem(url, JSON.stringify(previewData));
                return previewData;
            } catch (error) {
                console.error("Error fetching link preview:", error);
                return null;
            }
        }


        // =================================================================
        // 6. PAGE NAVIGATION LOGIC
        // =================================================================
        function showPage(pageId, isOverlay = false) {
            if (!isOverlay) {
                pages.forEach(page => page.classList.add('hidden'));
            }
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
            }
            if (!isOverlay) updateNavButtons(pageId);
        }

        function hidePage(pageId) {
            const page = document.getElementById(pageId);
            if(page) page.classList.add('hidden');
        }

        function updateNavButtons(activePageId) {
            navButtons.forEach(btn => {
                const isTarget = btn.dataset.page === activePageId;
                btn.classList.toggle('text-gray-500', !isTarget);
                btn.classList.toggle('dark:text-gray-400', !isTarget);
                
                // New active state with gradient border
                btn.classList.toggle('border-t', isTarget);
                btn.classList.toggle('border-gradient-custom', isTarget);
                btn.classList.toggle('text-primary', isTarget);
                btn.classList.toggle('dark:text-white', isTarget);

                // Remove old background highlight
                btn.classList.remove('bg-purple-100', 'dark:bg-gray-700');
            });
        }
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                if (pageId === 'search-users-page') {
                    showPage('search-users-page', true);
                    userSearchInput.value = '';
                    userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Type a username to find users.</p>';
                } else {
                    showPage(pageId);
                }
            });
        });

        openGeminiBtn.addEventListener('click', () => {
            // Add a greeting message if the chat is empty
            if (geminiChatHistory.length === 0) {
                const greetingText = "Hello! I'm Gemini. How can I help you today? You can ask me questions, request translations, or get help with your writing.";
                const greetingMessage = { role: 'model', parts: [{ text: greetingText }] };
                geminiChatHistory.push(greetingMessage);
                renderGeminiMessage(greetingText, 'gemini');
            }
            showPage('gemini-page', true);
        });
        
        // --- NEW Navigation for Chat Settings ---
        chatSettingsSectionLink.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('chat-settings-section-page', true);
        });

        backFromChatSettingsBtn.addEventListener('click', () => {
            hidePage('chat-settings-section-page');
        });

        chatThemeSelectorLink.addEventListener('click', () => {
            updateThemeSelectionUI(currentUser.settings?.chatTheme || 'theme-default');
            showPage('chat-theme-page', true);
        });

        backFromChatThemeBtn.addEventListener('click', () => {
            hidePage('chat-theme-page');
        });


        // =================================================================
        // 7. AUTHENTICATION & PRESENCE MANAGEMENT
        // =================================================================
        onAuthStateChanged(auth, async (user) => {
            loadingScreen.classList.add('hidden');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };

                    // NEW: Check if profile is complete
                    if (currentUser.profileComplete === false) {
                        authPage.classList.add('hidden');
                        appContainer.classList.add('hidden');
                        profileSetupPage.classList.remove('hidden');
                    } else {
                        profileSetupPage.classList.add('hidden');
                        authPage.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        showPage('chats-page');
                        setupRealtimeListeners();
                        managePresence(user.uid);
                        
                        // Update profile UI in both Settings and Edit Profile pages
                        const initials = getInitials(currentUser.username);
                        const profilePicUrl = currentUser.profilePicUrl || getPlaceholderUrl(initials);
                        const bio = currentUser.bio || 'This is your bio. Click to edit it.';

                        // Settings page elements
                        settingsProfileUsername.textContent = currentUser.username;
                        settingsProfileBio.textContent = bio;
                        settingsProfilePic.src = profilePicUrl;
                        
                        // Update Read Receipts toggle UI
                        // Default to true (enabled) if the setting is not present
                        const readReceiptsEnabled = currentUser.settings?.readReceipts ?? true;
                        updateReadReceiptsToggleUI(readReceiptsEnabled);

                        // Apply saved chat theme
                        const savedChatTheme = currentUser.settings?.chatTheme || 'theme-default';
                        applyChatTheme(savedChatTheme);

                        // Edit Profile page elements
                        profileUsername.textContent = currentUser.username;
                        profileEmail.textContent = currentUser.email;
                        bioText.textContent = bio;
                        profilePicDisplay.src = profilePicUrl;
                    }
                } else {
                    console.error("User exists in Auth but not in Firestore. Logging out.");
                    signOut(auth); 
                }
            } else {
                currentUser = null;
                authPage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                profileSetupPage.classList.add('hidden');
                cleanupRealtimeListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (username.length < 3) return alert("Username must be at least 3 characters.");
            if (password.length < 6) return alert("Password must be at least 6 characters.");

            try {
                const usernameDoc = await getDoc(doc(db, "usernames", username.toLowerCase()));
                if (usernameDoc.exists()) throw new Error("Username is already taken.");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", user.uid);
                    const usernameRef = doc(db, "usernames", username.toLowerCase());
                    
                    transaction.set(userRef, {
                        uid: user.uid,
                        username: username,
                        username_lowercase: username.toLowerCase(),
                        email: email,
                        profilePicUrl: null,
                        bio: '', // Initialize with empty bio
                        createdAt: serverTimestamp(),
                        profileComplete: true, // Profile is complete for email signups
                        status: {
                            state: 'offline',
                            last_changed: serverTimestamp(),
                        },
                        settings: {
                            readReceipts: true, // Default setting
                            chatTheme: 'theme-default' // Default theme
                        }
                    });
                    transaction.set(usernameRef, { uid: user.uid });
                });
            } catch (error) {
                alert("Signup Error: " + error.message);
            }
        });
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user already exists in Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // This is a brand new user
                    const tempUsername = user.email.split('@')[0].toLowerCase() + Math.floor(Math.random() * 1000);
                    const tempUsernameRef = doc(db, "usernames", tempUsername);

                    await runTransaction(db, async (transaction) => {
                         transaction.set(userDocRef, {
                            uid: user.uid,
                            username: tempUsername, // Temporary username
                            username_lowercase: tempUsername,
                            email: user.email,
                            profilePicUrl: user.photoURL,
                            bio: '',
                            createdAt: serverTimestamp(),
                            profileComplete: false, // <-- NEW FLAG
                            status: { state: 'offline', last_changed: serverTimestamp() },
                            settings: { readReceipts: true, chatTheme: 'theme-default' }
                        });
                        transaction.set(tempUsernameRef, { uid: user.uid });
                    });
                }
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                alert("Could not sign in with Google. Please try again.");
            }
        }
        googleSigninBtn.addEventListener('click', handleGoogleSignIn);
        googleSignupBtn.addEventListener('click', handleGoogleSignIn);

        logoutButton.addEventListener('click', async () => {
            if (currentUser) {
                const userStatusRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userStatusRef, {
                    status: { state: 'offline', last_changed: serverTimestamp() }
                });
            }
            signOut(auth);
        });

        showSignup.addEventListener('click', (e) => { 
            e.preventDefault(); 
            loginView.classList.add('hidden'); 
            signupView.classList.remove('hidden'); 
        });
        showLogin.addEventListener('click', (e) => { 
            e.preventDefault(); 
            signupView.classList.add('hidden'); 
            loginView.classList.remove('hidden'); 
        });

        function managePresence(uid) {
            const userStatusDatabaseRef = ref(rtdb, '/status/' + uid);
            const userStatusFirestoreRef = doc(db, '/users/' + uid);

            const isOfflineForFirestore = { state: 'offline', last_changed: serverTimestamp() };
            const isOnlineForFirestore = { state: 'online', last_changed: serverTimestamp() };

            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === false) {
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                    return;
                }
                const onDisconnectRef = onDisconnect(userStatusDatabaseRef);
                onDisconnectRef.set({ state: 'offline', last_changed: rtdbServerTimestamp() });
                set(userStatusDatabaseRef, { state: 'online', last_changed: rtdbServerTimestamp() });
                updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    updateDoc(userStatusFirestoreRef, { status: isOfflineForFirestore });
                } else {
                    updateDoc(userStatusFirestoreRef, { status: isOnlineForFirestore });
                }
            });
        }

        // =================================================================
        // 8. REALTIME LISTENERS & CHAT LIST
        // =================================================================
        function cleanupRealtimeListeners() {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeUsers) unsubscribeUsers();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        }

        function setupRealtimeListeners() {
            cleanupRealtimeListeners();

            // Listener for all user data changes (for real-time statuses)
            const usersQuery = query(collection(db, "users"));
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    allUsersData[change.doc.id] = change.doc.data();
                });
                renderCombinedChatList(); // Re-render the list when any user's status changes
            });

            // Listener for chat data changes
            const chatsQuery = query(
                collection(db, "chats"),
                where("participants", "array-contains", currentUser.uid),
                orderBy("lastMessageTimestamp", "desc")
            );
            
            unsubscribeChats = onSnapshot(chatsQuery, (snapshot) => {
                allChatsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCombinedChatList(); // Re-render the list when chat data changes
            });
        }

        function renderCombinedChatList() {
            if (allChatsData.length === 0) {
                chatList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center mt-8">No chats yet. Click the 'Search' button to find users and start a conversation.</p>`;
                return;
            }

            let totalUnread = 0;
            const chatHtml = allChatsData.map(chat => {
                const partnerId = chat.participants.find(id => id !== currentUser.uid);
                if (!partnerId || !allUsersData[partnerId]) return ''; // Skip if partner data not loaded yet

                const partner = allUsersData[partnerId];
                const currentUserUnreadCount = chat.unreadCount?.[currentUser.uid] || 0;
                totalUnread += currentUserUnreadCount;

                const isOnline = partner.status?.state === 'online';
                const initials = getInitials(partner.username);
                const profilePicUrl = partner.profilePicUrl || getPlaceholderUrl(initials);
                const unreadIndicator = currentUserUnreadCount > 0 ? `<span class="w-3 h-3 bg-red-500 rounded-full"></span>` : '';

                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition chat-item" data-partner-id="${partner.uid}" data-partner-name="${partner.username}" data-partner-pic="${partner.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${partner.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${chat.lastMessage || 'No messages yet'}</p>
                    </div>
                    <div class="w-8 flex justify-end items-center">
                        ${unreadIndicator}
                    </div>
                </div>`;
            }).join('');

            chatList.innerHTML = chatHtml;

            if (totalUnread > 0) {
                chatsBadge.classList.remove('hidden');
            } else {
                chatsBadge.classList.add('hidden');
            }
        }
        
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(item => {
                const partnerName = item.dataset.partnerName.toLowerCase();
                item.style.display = partnerName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // =================================================================
        // 9. CHAT ROOM LOGIC & READ RECEIPTS & TYPING INDICATOR
        // =================================================================

        // NEW: Handler for visibility change to pause/resume read receipt observer
        function handleVisibilityChange() {
            if (!readReceiptObserver || chatRoomPage.classList.contains('hidden')) {
                return;
            }

            if (document.visibilityState === 'hidden') {
                // When tab is hidden, disconnect the observer to stop marking messages as read
                readReceiptObserver.disconnect();
            } else if (document.visibilityState === 'visible') {
                // When tab is visible again, re-observe all currently unread messages
                messagesContainer.querySelectorAll('.unread-message').forEach(el => {
                    readReceiptObserver.observe(el);
                });
            }
        }

        chatList.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                openChatRoom({
                    uid: chatItem.dataset.partnerId,
                    username: chatItem.dataset.partnerName,
                    profilePicUrl: chatItem.dataset.partnerPic
                });
            }
        });
        
        async function openChatRoom(partner) {
            currentChatPartner = partner;
            showPage('chat-room-page', true);
            
            // Apply current user's saved theme
            applyChatTheme(currentUser.settings?.chatTheme || 'theme-default');

            chatRoomUsername.textContent = partner.username;

            const initials = getInitials(partner.username);
            chatRoomPic.src = partner.profilePicUrl || getPlaceholderUrl(initials);

            // Setup IntersectionObserver for read receipts
            if (readReceiptObserver) readReceiptObserver.disconnect();
            readReceiptObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const messageWrapper = entry.target;
                        const messageId = messageWrapper.dataset.messageId;
                        markSingleMessageAsRead(messageId);
                        observer.unobserve(messageWrapper); // Stop observing once it's marked as read
                    }
                });
            }, { threshold: 0.8 }); // Trigger when 80% of the message is visible
            
            // Add visibility change listener
            document.addEventListener('visibilitychange', handleVisibilityChange);

            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            unsubscribePartnerStatus = onSnapshot(doc(db, "users", partner.uid), (docSnap) => {
                const partnerData = docSnap.data();
                if (partnerData) {
                    currentChatPartner = { ...currentChatPartner, ...partnerData };
                    updatePartnerStatusUI(partnerData.status);
                }
            });

            function updatePartnerStatusUI(status) {
                const isOnline = status?.state === "online";
                chatRoomStatusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                
                if (isOnline) {
                    chatRoomStatusText.textContent = "Online";
                    chatRoomStatusText.className = "text-xs text-green-500";
                } else {
                    if (status?.last_changed) {
                        chatRoomStatusText.textContent = `last seen ${timeAgo(status.last_changed)}`;
                    } else {
                        chatRoomStatusText.textContent = "Offline";
                    }
                    chatRoomStatusText.className = "text-xs text-gray-500";
                }
            }

            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            messagesContainer.innerHTML = ""; // Clear previous messages

            if (unsubscribeMessages) unsubscribeMessages();

            const messagesQuery = query(
                collection(db, `chats/${chatId}/messages`),
                orderBy("timestamp", "asc")
            );

            let isInitialLoad = true;

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const isUserScrolledUp = messagesContainer.scrollHeight - messagesContainer.clientHeight > messagesContainer.scrollTop + 100;

                snapshot.docChanges().forEach((change) => {
                    const messageId = change.doc.id;
                    const messageData = change.doc.data();

                    if (change.type === "added") {
                        const messageElement = createMessageElement(messageId, messageData);
                        if (!isInitialLoad) {
                            messageElement.classList.add("animate-fade-in-up");
                        }
                        messagesContainer.appendChild(messageElement);
                        
                        // If it's an unread message for the current user, observe it, but only if the tab is visible
                        if (messageElement.classList.contains('unread-message') && document.visibilityState === 'visible') {
                            readReceiptObserver.observe(messageElement);
                        }
                    }
                    if (change.type === "removed") {
                        const messageElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                        if (messageElement) {
                            readReceiptObserver.unobserve(messageElement);
                            messageElement.remove();
                        }
                    }
                    if (change.type === "modified") {
                        const existingElement = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
                        if (existingElement) {
                            // Stop observing the old element before replacing
                            if(existingElement.classList.contains('unread-message')) {
                                readReceiptObserver.unobserve(existingElement);
                            }
                            const updatedElement = createMessageElement(messageId, messageData);
                            existingElement.replaceWith(updatedElement);
                             if (updatedElement.classList.contains('unread-message') && document.visibilityState === 'visible') {
                                readReceiptObserver.observe(updatedElement);
                            }
                        }
                    }
                });
                
                if (isInitialLoad) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    isInitialLoad = false;
                } else if (!isUserScrolledUp) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            });

            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            const partnerTypingRef = ref(rtdb, `/typing/${chatId}/${partner.uid}`);
            const typingIndicatorContainer = document.getElementById('typing-indicator-container');

            unsubscribeTypingStatus = onValue(partnerTypingRef, (snap) => {
                if (snap.exists() && snap.val() === true) {
                    const initials = getInitials(currentChatPartner.username);
                    const profilePicUrl = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);

                    typingIndicatorContainer.innerHTML = `
                        <div class="flex items-center space-x-2 animate-fade-in">
                            <img src="${profilePicUrl}" class="w-8 h-8 rounded-full object-cover">
                            <div class="px-4 py-3 rounded-2xl bg-gray-200 dark:bg-gray-700">
                                <div class="flex items-center space-x-1">
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0s;"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.2s;"></div>
                                    <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>`;
                } else {
                    typingIndicatorContainer.innerHTML = '';
                }
            });
        }

        function createMessageElement(id, msg) {
            const isSender = msg.senderId === currentUser.uid;
            // The partner is the other participant in the chat
            const partnerId = currentChatPartner?.uid;
            const partnerData = allUsersData[partnerId];
            
            // Determine if the read receipt should be shown.
            // Show it if:
            // 1. The current user is the sender.
            // 2. The partner (receiver) has read receipts enabled (or the setting is undefined, defaulting to true).
            const partnerHasReceiptsOn = partnerData?.settings?.readReceipts ?? true;
            const showReadReceipt = isSender && partnerHasReceiptsOn;

            const replyHtml = msg.replyTo ? `
                <div class="p-2 mb-1 text-xs bg-black bg-opacity-10 dark:bg-white dark:bg-opacity-10 rounded-md">
                    <p class="font-bold text-sky-500">${msg.replyTo.senderName}</p>
                    <p class="truncate">${msg.replyTo.text}</p>
                </div>
            ` : '';

            const readReceipt = showReadReceipt ? `
                <div class="w-4 h-1.5 rounded-full ${msg.isRead ? 'bg-sky-500' : 'bg-gray-300 dark:bg-gray-500'} transition-colors"></div>
            ` : '';

            const wrapper = document.createElement('div');
            wrapper.className = `flex flex-col message-bubble-wrapper relative group ${isSender ? 'items-end' : 'items-start'}`;
            wrapper.dataset.messageId = id;
            wrapper.dataset.messageText = msg.text;
            wrapper.dataset.messageSender = isSender ? currentUser.username : currentChatPartner.username;
            
            const isReceiver = msg.receiverId === currentUser.uid;
            if(isReceiver && !msg.isRead) {
                wrapper.classList.add('unread-message');
            }

            const urls = extractUrls(msg.text);
            const linkPreviewContainerId = `link-preview-${id}`;
            const linkPreviewHtml = urls.length > 0 ? `<div id="${linkPreviewContainerId}"></div>` : '';

            const messageTextHtml = urls.length > 0 ? msg.text.replace(urls[0], `<a href="${urls[0]}" target="_blank" class="text-blue-400 underline">${urls[0]}</a>`) : msg.text;

            const actionsMenu = isSender ? `
                <div class="absolute top-1/2 -translate-y-1/2 ${isSender ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'} p-2">
                    <div class="relative">
                        <button class="message-menu-btn opacity-0 group-hover:opacity-100 transition-opacity p-1 text-gray-500 dark:text-gray-400">
                             <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                        </button>
                        <div class="message-menu-dropdown hidden absolute bottom-full mb-1 left-0 bg-white dark:bg-gray-700 rounded-md shadow-lg z-10 w-24">
                            <button class="unsend-btn text-red-600 dark:text-red-400 block w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-message-id="${id}">Unsend</button>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // NEW: Container for reaction chips
            const reactionsContainerHtml = `<div class="reaction-container flex gap-1 mt-1 ${isSender ? 'justify-end' : 'justify-start'}"></div>`;

            wrapper.innerHTML = `
                ${actionsMenu}
                <div class="flex items-end ${isSender ? 'flex-row-reverse' : ''}">
                    <div class="max-w-xs lg:max-w-md">
                        <div class="px-4 py-2 rounded-2xl ${isSender ? 'bg-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm'} overflow-hidden">
                            ${replyHtml}
                            <p>${messageTextHtml}</p>
                            ${linkPreviewHtml}
                        </div>
                    </div>
                    <button class="action-btn reply-btn opacity-0 transition-opacity p-2 text-gray-500 dark:text-gray-400">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                ${reactionsContainerHtml}
                <div class="flex items-center mt-1 pr-2 space-x-2">
                     <p class="text-xs text-gray-400 dark:text-gray-500">${formatMessageTime(msg.timestamp)}</p>
                    ${readReceipt}
                </div>
            `;

            // NEW: Populate reactions
            const reactionsContainer = wrapper.querySelector('.reaction-container');
            if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                Object.entries(msg.reactions).forEach(([emoji, uids]) => {
                    if (uids.length > 0) {
                        const reactionChip = document.createElement('button');
                        const userHasReacted = uids.includes(currentUser.uid);
                        reactionChip.className = `reaction-chip ${userHasReacted ? 'reacted-by-me' : ''}`;
                        reactionChip.textContent = `${emoji} ${uids.length}`;
                        reactionChip.dataset.emoji = emoji;
                        reactionsContainer.appendChild(reactionChip);
                    }
                });
            }


            if (urls.length > 0) {
                const previewContainer = wrapper.querySelector(`#${linkPreviewContainerId}`);
                previewContainer.innerHTML = `<div class="mt-2 p-2 flex items-center justify-center"><div class="w-4 h-4 border-2 border-t-primary border-gray-200 rounded-full animate-spin"></div></div>`;
                
                fetchLinkPreview(urls[0]).then(previewData => {
                    if (previewData) {
                        previewContainer.innerHTML = `
                        <a href="${previewData.url}" target="_blank" rel="noopener noreferrer" class="block mt-2 link-preview p-2 rounded-lg bg-gray-100 dark:bg-gray-600">
                            <div class="flex items-center space-x-3">
                                <img src="${previewData.image}" class="link-preview-image rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/64x64/eee/ccc?text=N/A';">
                                <div class="overflow-hidden">
                                    <p class="font-bold text-sm truncate text-gray-800 dark:text-gray-200">${previewData.title}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${previewData.description}</p>
                                </div>
                            </div>
                        </a>
                        `;
                    } else {
                         previewContainer.innerHTML = `<div class="mt-2 p-2 text-xs text-gray-400">Preview not available</div>`;
                    }
                });
            }

            return wrapper;
        }

        async function markSingleMessageAsRead(messageId) {
            // If the current user (the receiver) has read receipts disabled, do nothing.
            const readReceiptsEnabled = currentUser.settings?.readReceipts ?? true;
            if (!readReceiptsEnabled) {
                return;
            }

            if (!currentChatPartner || !currentUser) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const messageRef = doc(db, `chats/${chatId}/messages`, messageId);
            const chatRef = doc(db, 'chats', chatId);

            try {
                await updateDoc(messageRef, { isRead: true });
                await updateDoc(chatRef, {
                    [`unreadCount.${currentUser.uid}`]: increment(-1)
                });
            } catch (error) {
                console.error("Error marking message as read:", error);
            }
        }

        messageInput.addEventListener('input', () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, true);
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                set(typingRef, false);
            }, 2000);
            
            // Show/hide AI rewrite button
            if (messageInput.value.trim().length > 0) {
                aiRewriteBtn.classList.remove('hidden');
            } else {
                aiRewriteBtn.classList.add('hidden');
                aiRewritePopup.classList.add('hidden');
            }
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatPartner) return;
            
            messageInput.value = '';
            aiRewriteBtn.classList.add('hidden'); // Hide on send
            aiRewritePopup.classList.add('hidden'); // Hide on send
            
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            clearTimeout(typingTimeout);
            const typingRef = ref(rtdb, `/typing/${chatId}/${currentUser.uid}`);
            set(typingRef, false);

            const newMessage = {
                senderId: currentUser.uid,
                receiverId: currentChatPartner.uid,
                text: text,
                type: "text",
                isRead: false,
                timestamp: serverTimestamp(),
                reactions: {}
            };

            if (currentReply) {
                newMessage.replyTo = currentReply;
            }

            try {
                const chatRef = doc(db, "chats", chatId);
                const messagesRef = collection(db, `chats/${chatId}/messages`);

                await addDoc(messagesRef, newMessage);

                await setDoc(chatRef, {
                    participants: [currentUser.uid, currentChatPartner.uid],
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    lastSenderId: currentUser.uid,
                    unreadCount: {
                        [currentUser.uid]: 0,
                        [currentChatPartner.uid]: increment(1)
                    }
                }, { merge: true });


            } catch (error) {
                console.error("Error sending message: ", error);
                alert("Could not send message.");
                messageInput.value = text;
            } finally {
                cancelReply();
            }
        });

        backToChatsBtn.addEventListener('click', () => {
            hidePage('chat-room-page');
            currentChatPartner = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (unsubscribeTypingStatus) unsubscribeTypingStatus();
            if (readReceiptObserver) readReceiptObserver.disconnect();
            document.removeEventListener('visibilitychange', handleVisibilityChange);
        });
        
        // =================================================================
        // 10. MESSAGE INTERACTION LOGIC (REPLY, UNSEND & REWRITE)
        // =================================================================
        messagesContainer.addEventListener('click', (e) => {
            const replyButton = e.target.closest('.reply-btn');
            const menuButton = e.target.closest('.message-menu-btn');
            const unsendButton = e.target.closest('.unsend-btn');
            const reactionChip = e.target.closest('.reaction-chip');

            document.querySelectorAll('.message-menu-dropdown').forEach(menu => {
                if (!menu.previousElementSibling.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            if (replyButton) {
                const messageWrapper = replyButton.closest('.message-bubble-wrapper');
                currentReply = {
                    messageId: messageWrapper.dataset.messageId,
                    text: messageWrapper.dataset.messageText,
                    senderName: messageWrapper.dataset.messageSender
                };
                showReplyPreview();
            }

             if (menuButton) {
                const dropdown = menuButton.nextElementSibling;
                dropdown.classList.toggle('hidden');
            }

            if (unsendButton) {
                const messageId = unsendButton.dataset.messageId;
                if (confirm('Are you sure you want to unsend this message?')) {
                    unsendMessage(messageId);
                }
            }

            if (reactionChip) {
                const messageId = reactionChip.closest('.message-bubble-wrapper').dataset.messageId;
                const emoji = reactionChip.dataset.emoji;
                toggleEmojiReaction(messageId, emoji);
            }
        });

        async function unsendMessage(messageId) {
            if (!currentChatPartner || !currentUser) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const messageRef = doc(db, `chats/${chatId}/messages/${messageId}`);

            try {
                await deleteDoc(messageRef);
                // Note: We don't update the `lastMessage` on the chat document for simplicity.
                // The chat preview might show a deleted message until a new one is sent.
            } catch (error) {
                console.error("Error unsending message:", error);
                alert("Could not unsend the message.");
            }
        }


        function showReplyPreview() {
            if (!currentReply) return;
            replyPreviewUsername.textContent = `Replying to ${currentReply.senderName}`;
            replyPreviewText.textContent = currentReply.text;
            replyPreviewContainer.classList.remove('hidden');
            messageInput.focus();
        }

        function cancelReply() {
            currentReply = null;
            replyPreviewContainer.classList.add('hidden');
        }
        cancelReplyBtn.addEventListener('click', cancelReply);

        // AI Rewrite Logic
        aiRewriteBtn.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text) return;

            aiRewritePopup.classList.remove('hidden');
            rewriteSuggestionsContainer.innerHTML = '<div class="text-center text-sm text-gray-500">Generating suggestions...</div>';

            // New, more robust prompt asking for JSON output
            const prompt = `Analyze the following text and its language (which could be Hindi, English, or Hinglish). Provide three alternative versions in the same language. Your response MUST be a valid JSON object, and nothing else. The JSON object should have three keys: "formal", "casual", and "simple".

            Text: "${text}"`;

            try {
                let result = await callGeminiAPI([{ role: 'user', parts: [{ text: prompt }] }]);
                
                // Clean the result to ensure it's valid JSON
                // Gemini sometimes wraps its response in ```json ... ```
                const jsonResponse = result.replace(/```json/g, '').replace(/```/g, '').trim();
                const suggestions = JSON.parse(jsonResponse);

                rewriteSuggestionsContainer.innerHTML = ''; // Clear loading message

                // Use the keys from the JSON response directly
                ['formal', 'casual', 'simple'].forEach(tone => {
                    if (suggestions[tone]) {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'rewrite-suggestion p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer';
                        const capitalizedTone = tone.charAt(0).toUpperCase() + tone.slice(1);
                        suggestionEl.innerHTML = `<span class="font-bold">${capitalizedTone}:</span> ${suggestions[tone]}`;
                        suggestionEl.addEventListener('click', () => {
                            messageInput.value = suggestions[tone];
                            aiRewritePopup.classList.add('hidden');
                            messageInput.focus();
                        });
                        rewriteSuggestionsContainer.appendChild(suggestionEl);
                    }
                });

            } catch (error) {
                rewriteSuggestionsContainer.textContent = "Sorry, couldn't generate suggestions.";
                console.error("AI Rewrite Error:", error);
            }
        });

        closeRewritePopupBtn.addEventListener('click', () => {
            aiRewritePopup.classList.add('hidden');
        });

        // =================================================================
        // 11. USER SEARCH LOGIC
        // =================================================================
        
        backFromSearchBtn.addEventListener('click', () => hidePage('search-users-page'));

        userSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">Keep typing to search...</p>';
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, 
                    where("username_lowercase", ">=", searchTerm),
                    where("username_lowercase", "<=", searchTerm + '\uf8ff'),
                    limit(10)
                );
                
                const querySnapshot = await getDocs(q);
                const users = [];
                querySnapshot.forEach((doc) => {
                    if (doc.id !== currentUser.uid) users.push(doc.data());
                });
                renderUserSearchResults(users);
            } catch (error) {
                console.error("Error searching users:", error);
                userSearchResults.innerHTML = '<p class="text-red-500 text-center mt-4">Error searching for users. Ensure database indexes are configured.</p>';
            }
        });

        function renderUserSearchResults(users) {
            if (users.length === 0) {
                userSearchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center mt-4">No users found.</p>';
                return;
            }
            userSearchResults.innerHTML = users.map(user => {
                const isOnline = user.status?.state === 'online';
                const initials = getInitials(user.username);
                const profilePicUrl = user.profilePicUrl || getPlaceholderUrl(initials);
                return `
                <div class="flex items-center p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition user-search-item" data-user-id="${user.uid}" data-user-name="${user.username}" data-user-pic="${user.profilePicUrl || ''}">
                    <div class="relative w-12 h-12 flex-shrink-0 mr-4">
                        <img src="${profilePicUrl}" class="w-12 h-12 rounded-full object-cover" alt="Profile Pic">
                        <div class="w-3.5 h-3.5 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold truncate text-gray-900 dark:text-white">${user.username}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${user.email}</p>
                    </div>
                </div>
            `}).join('');
        }

        userSearchResults.addEventListener('click', (e) => {
            const userItem = e.target.closest('.user-search-item');
            if (userItem) {
                hidePage('search-users-page');
                openChatRoom({
                    uid: userItem.dataset.userId,
                    username: userItem.dataset.userName,
                    profilePicUrl: userItem.dataset.userPic
                });
            }
        });

        // =================================================================
        // 12. PROFILE & BIO LOGIC
        // =================================================================
        settingsProfileLink.addEventListener('click', () => {
            showPage('profile-edit-page', true);
        });

        backFromProfileEditBtn.addEventListener('click', () => {
            hidePage('profile-edit-page');
        });

        privacySettingsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('privacy-settings-page', true);
        });

        backFromPrivacyBtn.addEventListener('click', () => {
            hidePage('privacy-settings-page');
        });

        profilePicContainer.addEventListener('click', () => profilePicInput.click());

        profilePicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                cropModal.classList.remove('hidden');
                if (croppieInstance) {
                    croppieInstance.destroy();
                }
                croppieInstance = new Croppie(cropContainer, {
                    viewport: { width: 200, height: 200, type: 'circle' },
                    boundary: { width: 250, height: 250 },
                    enableExif: true
                });
                croppieInstance.bind({
                    url: event.target.result
                });
            };
            reader.readAsDataURL(file);
        });
        
        cancelCropBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            if (croppieInstance) {
                croppieInstance.destroy();
                croppieInstance = null;
            }
            profilePicInput.value = ''; // Reset file input
        });

        saveCropBtn.addEventListener('click', async () => {
            if (!croppieInstance) return;

            saveCropBtn.disabled = true;
            saveCropBtn.textContent = 'Saving...';

            try {
                const blob = await croppieInstance.result({
                    type: 'blob',
                    size: 'viewport',
                    format: 'png',
                    quality: 0.9
                });

                // --- Start: Cloudinary Upload Logic ---
                const CLOUD_NAME = "dzuyq67ql";
                const UPLOAD_PRESET = "twinkle_profiles";
                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', UPLOAD_PRESET);
                // --- End: Cloudinary Upload Logic ---

                const toast = document.createElement('div');
                toast.textContent = 'Uploading...';
                toast.className = 'fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
                document.body.appendChild(toast);

                const response = await fetch(url, { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload to Cloudinary failed.');
                
                const data = await response.json();
                const photoURL = data.secure_url;
                if (!photoURL) throw new Error('Cloudinary did not return a URL.');

                await updateDoc(doc(db, 'users', currentUser.uid), { profilePicUrl: photoURL });
                currentUser.profilePicUrl = photoURL;
                
                profilePicDisplay.src = photoURL;
                settingsProfilePic.src = photoURL;
                
                toast.textContent = 'Upload complete!';
                toast.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
                setTimeout(() => toast.remove(), 3000);

            } catch (error) {
                console.error("Upload failed:", error);
                const toast = document.createElement('div');
                toast.textContent = 'Upload failed!';
                toast.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } finally {
                cancelCropBtn.click(); // Hide modal and clean up
                saveCropBtn.disabled = false;
                saveCropBtn.textContent = 'Crop & Save';
            }
        });
        
        editUsernameBtn.addEventListener('click', () => {
            usernameDisplayContainer.classList.add('hidden');
            usernameInputContainer.classList.remove('hidden');
            usernameInput.value = currentUser.username;
            usernameInput.focus();
        });

        cancelUsernameBtn.addEventListener('click', () => {
            usernameInputContainer.classList.add('hidden');
            usernameDisplayContainer.classList.remove('hidden');
        });

        saveUsernameBtn.addEventListener('click', async () => {
            const newUsername = usernameInput.value.trim();
            const oldUsername = currentUser.username;

            if (newUsername.length < 3) {
                alert("Username must be at least 3 characters.");
                return;
            }
            if (newUsername === oldUsername) {
                usernameInputContainer.classList.add('hidden');
                usernameDisplayContainer.classList.remove('hidden');
                return;
            }

            saveUsernameBtn.disabled = true;
            saveUsernameBtn.textContent = 'Saving...';

            try {
                const newUsernameLower = newUsername.toLowerCase();
                const usernameRef = doc(db, "usernames", newUsernameLower);
                const usernameDoc = await getDoc(usernameRef);

                if (usernameDoc.exists()) {
                    throw new Error("Username is already taken. Please choose another one.");
                }

                const batch = writeBatch(db);
                const oldUsernameRef = doc(db, "usernames", oldUsername.toLowerCase());
                batch.delete(oldUsernameRef);
                batch.set(doc(db, "usernames", newUsernameLower), { uid: currentUser.uid });
                const userRef = doc(db, "users", currentUser.uid);
                batch.update(userRef, {
                    username: newUsername,
                    username_lowercase: newUsernameLower
                });
                await batch.commit();

                currentUser.username = newUsername;
                profileUsername.textContent = newUsername;
                settingsProfileUsername.textContent = newUsername;
                alert("Username updated successfully!");

            } catch (error) {
                console.error("Error updating username:", error);
                alert("Failed to update username: " + error.message);
            } finally {
                usernameInputContainer.classList.add('hidden');
                usernameDisplayContainer.classList.remove('hidden');
                saveUsernameBtn.disabled = false;
                saveUsernameBtn.textContent = 'Save';
            }
        });


        editBioBtn.addEventListener('click', () => {
            bioText.classList.add('hidden');
            editBioBtn.classList.add('hidden');
            bioInput.classList.remove('hidden');
            saveBioBtn.classList.remove('hidden');
            bioInput.value = currentUser.bio || '';
            bioInput.focus();
        });

        saveBioBtn.addEventListener('click', async () => {
            const newBio = bioInput.value.trim();
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { bio: newBio });
                currentUser.bio = newBio;
                bioText.textContent = newBio || 'This is your bio. Click edit to change it.';
                settingsProfileBio.textContent = newBio || 'This is your bio. Click to edit it.';
            } catch (error) {
                console.error("Failed to save bio:", error);
                alert("Could not save bio.");
            } finally {
                bioText.classList.remove('hidden');
                editBioBtn.classList.remove('hidden');
                bioInput.classList.add('hidden');
                saveBioBtn.classList.add('hidden');
            }
        });
        
        chatRoomHeaderClickable.addEventListener('click', () => {
            if (!currentChatPartner) return;
            
            const initials = getInitials(currentChatPartner.username);
            partnerProfilePic.src = currentChatPartner.profilePicUrl || getPlaceholderUrl(initials);
            partnerProfileUsername.textContent = currentChatPartner.username;
            partnerProfileBio.textContent = currentChatPartner.bio || 'No bio available.';
            
            showPage('partner-profile-page', true);
        });

        backFromPartnerProfileBtn.addEventListener('click', () => {
            hidePage('partner-profile-page');
        });


        // =================================================================
        // 13. SETTINGS & THEME SWITCHER LOGIC
        // =================================================================
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleSlider.classList.add('dark:translate-x-6');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleSlider.classList.remove('dark:translate-x-6');
            }
            localStorage.setItem('theme', theme);
            const activeNav = document.querySelector('.nav-btn.border-t-2');
            if (activeNav) {
                updateNavButtons(activeNav.dataset.page);
            }
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            applyTheme(isDarkMode ? 'light' : 'dark');
        });

        function updateReadReceiptsToggleUI(isEnabled) {
            if (isEnabled) {
                readReceiptsToggleSlider.classList.add('dark:translate-x-6', 'translate-x-6');
                readReceiptsToggle.classList.add('bg-primary');
                readReceiptsToggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
            } else {
                readReceiptsToggleSlider.classList.remove('dark:translate-x-6', 'translate-x-6');
                readReceiptsToggle.classList.remove('bg-primary');
                readReceiptsToggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
            }
        }

        readReceiptsToggle.addEventListener('click', async () => {
            // Optimistically update UI
            const newSetting = !(currentUser.settings?.readReceipts ?? true);
            updateReadReceiptsToggleUI(newSetting);

            try {
                // Update local state
                 if (!currentUser.settings) currentUser.settings = {};
                 currentUser.settings.readReceipts = newSetting;
                // Update Firestore
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    'settings.readReceipts': newSetting
                });
            } catch (error) {
                console.error("Failed to update read receipts setting:", error);
                // Revert UI on error
                updateReadReceiptsToggleUI(!newSetting);
                 currentUser.settings.readReceipts = !newSetting;
                alert("Could not save your setting. Please try again.");
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        // --- NEW CHAT THEME LOGIC ---

        function applyChatTheme(themeName) {
            const allThemes = ['theme-doodle', 'theme-geometric', 'theme-cosmic', 'theme-leaves', 'theme-waves', 'theme-sunset', 'theme-default', 'theme-minty', 'theme-amethyst', 'theme-sunrise', 'theme-cyber', 'theme-arctic', 'theme-peach'];
            
            // Apply to open chat room
            if (messagesContainer) {
                messagesContainer.classList.remove(...allThemes);
                if (themeName && themeName !== 'theme-default') {
                    messagesContainer.classList.add(themeName);
                }
            }

            // Update the preview in settings
            if (currentThemePreview) {
                // Reset styles first
                currentThemePreview.style.backgroundImage = '';
                currentThemePreview.style.backgroundColor = '';
                currentThemePreview.className = 'w-6 h-6 rounded-full border border-gray-300 dark:border-gray-600';
                
                if (themeName && themeName !== 'theme-default') {
                    currentThemePreview.classList.add(themeName);
                } else {
                    currentThemePreview.classList.add('bg-gray-100', 'dark:bg-gray-900');
                }
            }
        }

        function updateThemeSelectionUI(activeTheme) {
            themePreviewItems.forEach(item => {
                if (item.dataset.theme === activeTheme) {
                    item.querySelector('div').classList.add('border-primary');
                } else {
                    item.querySelector('div').classList.remove('border-primary');
                }
            });
        }

        async function saveAndApplyChatTheme(themeName) {
            applyChatTheme(themeName);
            updateThemeSelectionUI(themeName);

            try {
                if (!currentUser.settings) currentUser.settings = {};
                currentUser.settings.chatTheme = themeName;
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    'settings.chatTheme': themeName
                });
            } catch (error) {
                console.error("Failed to save chat theme:", error);
                alert("Could not save your theme setting.");
                // TODO: Revert optimistically applied changes if needed
            }
        }

        themePreviewItems.forEach(item => {
            item.addEventListener('click', () => {
                const selectedTheme = item.dataset.theme;
                saveAndApplyChatTheme(selectedTheme);
            });
        });


        // =================================================================
        // 14. AI & GEMINI LOGIC
        // =================================================================
        async function callGeminiAPI(history) {
            const apiKey = "AIzaSyAE9qqHiA_FrTzj-3pkTtS52tH1u53jAhQ"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            if (apiKey === "AIzaSyAE9qqHiA_FrTzj-3pkTtS52tH1u53jAhQ") {
                // This is a placeholder for potential warnings about exposed keys.
            }

            const payload = { 
                contents: history,
                systemInstruction: {
                    parts: [{
                        text: "You are a helpful assistant integrated into the Twinkle chat app. Your name is Gemini. Always provide responses in plain text without using any Markdown formatting (like **bold** or *italics*)."
                    }]
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 console.error("API Error:", errorData);
                 throw new Error(`API request failed with status ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                if(result.promptFeedback?.blockReason) {
                     throw new Error(`Request blocked: ${result.promptFeedback.blockReason}`);
                }
                throw new Error("Invalid response structure from Gemini API.");
            }
        }

        backFromGeminiBtn.addEventListener('click', () => {
            hidePage('gemini-page');
        });

        function renderGeminiMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            const isGemini = sender === 'gemini';
            
            messageWrapper.className = `flex flex-col ${isGemini ? 'items-start' : 'items-end'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isGemini ? 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm' : 'bg-primary text-white rounded-br-none'}`;
            messageBubble.textContent = text;
            
            if (isGemini) {
                const label = document.createElement('span');
                label.className = 'text-xs text-gray-500 dark:text-gray-400 ml-2 mb-1';
                label.textContent = '✨ Gemini';
                messageWrapper.appendChild(label);
            }
            
            messageWrapper.appendChild(messageBubble);
            geminiMessagesContainer.appendChild(messageWrapper);
            geminiMessagesContainer.scrollTop = geminiMessagesContainer.scrollHeight;
        }

        geminiMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = geminiMessageInput.value.trim();
            if (!userText) return;

            geminiMessageInput.value = '';
            renderGeminiMessage(userText, 'user');
            geminiChatHistory.push({ role: 'user', parts: [{ text: userText }] });

            geminiTypingIndicator.innerHTML = `
                <div class="flex items-center space-x-2 animate-fade-in">
                    <div class="px-4 py-3 rounded-2xl bg-gray-200 dark:bg-gray-700">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0s;"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-blink" style="animation-delay: 0.4s;"></div>
                        </div>
                    </div>
                </div>`;

            try {
                const geminiResponse = await callGeminiAPI(geminiChatHistory);
                renderGeminiMessage(geminiResponse, 'gemini');
                geminiChatHistory.push({ role: 'model', parts: [{ text: geminiResponse }] });
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                renderGeminiMessage("Sorry, I couldn't get a response. Please check the console for errors.", 'gemini');
            } finally {
                geminiTypingIndicator.innerHTML = '';
            }
        });

        
        // =================================================================
        // 15. DELETE CHAT
        // =================================================================
        chatSettingsBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.toggle('hidden');
        });

        deleteChatBtn.addEventListener('click', () => {
            chatSettingsMenu.classList.add('hidden');
            deleteChatModal.classList.remove('hidden');
        });
        
        cancelDeleteBtn.addEventListener('click', () => {
            deleteChatModal.classList.add('hidden');
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            
            try {
                const messagesRef = collection(db, `chats/${chatId}/messages`);
                const messagesSnapshot = await getDocs(messagesRef);
                const batch = writeBatch(db);
                messagesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                await deleteDoc(doc(db, 'chats', chatId));
                
                hidePage('chat-room-page');
                showPage('chats-page');

            } catch (error) {
                console.error("Error deleting chat:", error);
                alert("Could not delete chat. Please try again.");
            } finally {
                deleteChatModal.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!chatSettingsBtn.contains(e.target) && !chatSettingsMenu.contains(e.target)) {
                chatSettingsMenu.classList.add('hidden');
            }
        });

        // =================================================================
        // 16. NEW: PROFILE SETUP LOGIC
        // =================================================================

        async function checkUsernameAvailability(username) {
            const newUsername = username.trim().toLowerCase();
            if (newUsername.length < 3) {
                usernameFeedback.textContent = 'Username must be at least 3 characters.';
                usernameFeedback.className = 'text-xs mt-1 h-4 text-red-500';
                completeProfileBtn.disabled = true;
                return false;
            }
            
            const usernameRef = doc(db, "usernames", newUsername);
            const docSnap = await getDoc(usernameRef);

            if (docSnap.exists()) {
                usernameFeedback.textContent = 'Username is already taken.';
                usernameFeedback.className = 'text-xs mt-1 h-4 text-red-500';
                completeProfileBtn.disabled = true;
                return false;
            } else {
                usernameFeedback.textContent = 'Username is available!';
                usernameFeedback.className = 'text-xs mt-1 h-4 text-green-500';
                completeProfileBtn.disabled = false;
                return true;
            }
        }

        setupUsernameInput.addEventListener('input', (e) => {
            clearTimeout(usernameCheckTimeout);
            usernameFeedback.textContent = 'Checking...';
            usernameFeedback.className = 'text-xs mt-1 h-4 text-gray-400';
            completeProfileBtn.disabled = true;
            usernameCheckTimeout = setTimeout(() => {
                checkUsernameAvailability(e.target.value);
            }, 500); // Debounce for 500ms
        });

        profileSetupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const setupPasswordInput = document.getElementById('setup-password');
            const setupPasswordConfirmInput = document.getElementById('setup-password-confirm');

            const newUsername = setupUsernameInput.value.trim();
            const newPassword = setupPasswordInput.value;
            const confirmPassword = setupPasswordConfirmInput.value;

            // Validation
            if (newPassword !== confirmPassword) {
                return alert("Passwords do not match.");
            }
            if (newPassword.length < 6) {
                return alert("Password must be at least 6 characters long.");
            }

            completeProfileBtn.disabled = true;
            completeProfileBtn.textContent = 'Saving...';

            try {
                // Final check on username
                const isAvailable = await checkUsernameAvailability(newUsername);
                if (!isAvailable) {
                    throw new Error("Username is not available.");
                }

                // 1. Link Email/Password credential to the Google account
                const credential = EmailAuthProvider.credential(currentUser.email, newPassword);
                await linkWithCredential(auth.currentUser, credential);

                // 2. Update Firestore documents in a batch
                const batch = writeBatch(db);
                
                // Ref to the new username doc
                const newUsernameRef = doc(db, "usernames", newUsername.toLowerCase());
                batch.set(newUsernameRef, { uid: currentUser.uid });
                
                // Ref to the old temp username doc
                const oldUsernameRef = doc(db, "usernames", currentUser.username_lowercase);
                batch.delete(oldUsernameRef);

                // Ref to the user's main profile doc
                const userRef = doc(db, "users", currentUser.uid);
                batch.update(userRef, {
                    username: newUsername,
                    username_lowercase: newUsername.toLowerCase(),
                    profileComplete: true
                });

                await batch.commit();

                // 3. Force a reload of the user's state to reflect the changes
                // A simple page reload is the most reliable way to re-trigger onAuthStateChanged
                window.location.reload();

            } catch (error) {
                console.error("Profile setup failed:", error);
                alert("Failed to complete profile: " + error.message);
                completeProfileBtn.disabled = false;
                completeProfileBtn.textContent = 'Complete Profile';
            }
        });
        
    </script>
</body>
</html>